---
title: "Stockton Green Economy Report"
author: "City Systems"
date: "Last Updated: February 2020"
output: 
  bookdown::gitbook:
    df_print: paged
    split_by: section
    includes:
      in_header: header.html
    config:
      toc:
        collapse: none
        scroll_highlight: yes
        before: null
        after: null
      toolbar:
        position: fixed
      edit : null
      download: null
      search: yes
      fontsettings:
        theme: white
        family: sans
        size: 2
      sharing:
        facebook: no
        github: no
        twitter: no
        linkedin: no
        weibo: no
        instapaper: no
        vk: no
        all: no
      info: no
editor_options: 
  chunk_output_type: inline
---

# Introduction

```{r libraries, include=FALSE}
library(tidycensus)
library(censusapi)
library(tigris)
library(units)
library(lehdr)
library(sf)
library(osrm)
library(mapview)
library(tidyverse)
library(magrittr)
library(lwgeom)
library(knitr)
library(DT)
library(bookdown)
library(kableExtra)
library(FinancialMath)
library(smoothr)
library(lwgeom)
library(geosphere)
library(tidytransit)
opts_chunk$set(
  echo = TRUE, 
  warning=FALSE, 
  message=FALSE,
  cache=TRUE
)
mapviewOptions(
  basemaps = "OpenStreetMap",
  leafletWidth = "100%")
options(
  tigris_use_cache = TRUE,
  tigris_class = "sf",
  osrm.server = "http://127.0.0.1:5000/",
  scipen=999
)
census_api_key("c8aa67e4086b4b5ce3a8717f59faa9a28f611dab", install = TRUE, overwrite = TRUE)
Sys.setenv(CENSUS_KEY="c8aa67e4086b4b5ce3a8717f59faa9a28f611dab")
```

```{r codefolding, echo=FALSE, eval=TRUE}
codejs <- readr::read_lines("js/codefolding.js")
collapsejs <- readr::read_lines("js/collapse.js")
transitionjs <- readr::read_lines("js/transition.js")

htmlhead <- 
  paste('
<script>',
paste(transitionjs, collapse = "\n"),
'</script>
<script>',
paste(collapsejs, collapse = "\n"),
'</script>
<script>',
paste(codejs, collapse = "\n"),
'</script>
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
.row { display: flex; }
.collapse { display: none; }
.in { display:block }
</style>
<script>
$(document).ready(function () {
  window.initializeCodeFolding("show" === "hide");
});
</script>
', sep = "\n")

readr::write_lines(htmlhead, path = "header.html")
```

The Office of the Mayor in Stockton, CA is seeking to differentiate the City's investment opportunities, including potential capital from public (e.g. Transformative Climate Communities), private (e.g. Opportunity Zones), and philanthropic (e.g. foundations) sources, through the lens of **green economy**. The challenge at hand is to conduct a comprehensive assessment of Stockton's assets and opportunities across a wide range of industry, infrastructure, development, and policy domains which could be marketed as green economy investment opportunities, thereby enabling City representatives to prioritize and drive evidence-informed discussions with investors, as opposed to agendas being driven by one-off outside interests. In particular, the City is focused on leveraging such a framework to target and scope a green demonstration project in the short-term (2020-2021), which already has committed capital, that generates the most useful short-term results, both in realized environmental and economic benefits and in attracting further investment interest.

City Systems has conducted a research activity with the following outcomes:

1. A repository of information about green economy investment opportunities in Stockton, including relevant technical review, case studies of implementation in other cities, key risks/challenges, and estimated ranges of possible environmental and economic benefits per dollar of investment.
2. Communication materials for the City of Stockton and partners to use in investor outreach.
3. A detailed design and implementation plan for a green demonstration project, informed by consensus-building discussion with City-identified stakeholders throughout the research phase, and likely to have initiated before the conclusion of the research phase.

The following document describes our methodology and results. Given the scope of this report, readers are encouraged to navigate freely throughout different sections using the table of contents on the left, or with the summary table below.

| If you are interested in... | Skip to... |
|:---|:---|
| Baseline assessment of economy and GHG footprint | [Chapter 2](#baseline-assessment) |
| Overview of over fifty green economy strategies from around the U.S. | [Chapter 3](overview-of-green-economy-strategies) |
| Analysis of five green economy strategies for Stockton | [Chapter 4](analysis-of-green-economy-strategies) |
| U.S. strategy overview organized by city/county/state | [Appendix A](appendix-a-index-of-case-studies-by-place) |

$~$

**Acknowledgements**

Ann Rogan provided the motivation for and guided this entire project. Jasmine Leek, Amanda Ford, Taylor Williams, Finn Dobkin, Darryl Rutherford, and others attended regular check-ins and gave valuable feedback. Greg Forbes, Kevin Lin, Max O'Krepki, and John Zhao provided support on portions of code. Rachel Galowich, Christian Giadolor, Greg Forbes, Julia Wagenfehr, Armelle Coutant, Abdul Aleem, Matt Nissen, and Dorian Lumarque participated in practicum projects at Stanford that produced outcomes that are integrated into this work. Finn Dobkin led the research in Chapter 3 on green economy strategies. Tyler Pullen reviewed the report and offered helpful revisions.

## Approach

The goal of every urban government is to provide residents a high quality of life, which not only includes the benefits associated with high-quality jobs, but also a vibrant economy filled with excellent amenities and supported by well-maintained infrastructure. Building a robust business tax base is one recognized strategy in California for cities to adequately fund general expenses and capital infrastructure, given, for example, state restrictions on property taxes. This strategy is particularly relevant to Stockton given its history of bankruptcy following the Recession and its "brain drain" challenge of keeping high-quality talent from leaving for economic opportunities in the Bay Area and elsewhere. One useful related indicator is the jobs to employed residents (J/ER) ratio; the higher this ratio, the greater the share of business and sales tax relative to property tax, and the less likely the region is a "bedroom community" in which there are more people at night than during the day. For reference, a city like San Jose is unique to have its metropolitan core location yet have a J/ER ratio less than 1; nearby cities like Palo Alto approach a J/ER ratio of 3. 

If Stockton is to reinvent its economy, a key goal should be to increase its J/ER ratio while ensuring the quality of those jobs. To do so, it must aggressively attract high-quality businesses and support the growth of its existing ones, so that its number of jobs may increase more quickly than its population. Historical data for both population and jobs will help us understand the baseline performance of Stockton and its surrounding region in this regard, as well as allow us to forecast what "business-as-usual" looks like into the future. Then, J/ER ratio targets can be set in comparison to business-as-usual, which can be achieved through the kinds of economic development strategies explored in this report.

Of course, both job and population growth directly impact a city's environmental footprint. In Chapter 2, we will prepare a baseline assessment of Stockton's greenhouse gas inventory, our primary indicator of environmental performance. Importantly, GHGs should be disaggregated as much as possible into residential and non-residential (commercial, industrial, agricultural) sectors and normalized by respective populations (residents vs. workers) to understand the GHG use per capita in these different sectors. Stockton's GHG footprint will almost certainly increase in the coming decades simply due to the increase in jobs and population, but if GHG/capita for each sector can be reduced through the kinds of strategies explored in this report, then it should be considered successful in curbing GHGs -- and perhaps the City's GHG footprint may actually decrease as a whole.

So, in summary, an accurate assessment of current population and jobs, combined with a GHG inventory, helps us measure important indicators of success like J/ER and GHG/capita. And a best estimate of how population and jobs will change in the future shows us what business-as-usual looks like for both economic and environmental health. Given this outlook, Stockton can consider a wide range of possible strategies that stimulate job growth, reduce our environmental footprint, or in the best case scenario, achieve both at the same time, all categorized under the term **green economy**. The effects of those strategies can be modeled into the future in comparison to business-as-usual to see if they help us achieve our economic and environmental targets. Of course, strategies will also need to be evaluated based on their costs and return on investment, which we will approximate as a $/tCO2e (metric tons of carbon dioxide equivalent) in net-present value, similar to the work done in [Climate Smart San Jose](https://www.sanjoseca.gov/your-government/environment/climate-smart-san-jos). After robustly carrying out the quantitative analysis involved, this report will highlight the most promising strategies at the intersection of "green" and "economy" so that future decision-makers can take actionable steps towards a vibrant and sustainable future.

# Baseline Assessment

The first step to our research is to conduct a baseline assessment of Stockton's environmental and economic performance, and produce "business-as-usual" forecasts. Different datasets will be limited to different historical ranges and geographic scales. We will explain all key assumptions made in data processing. For forecasting, we will generally rely on simple regression and will project to 2040, a common planning horizon.

## Population and Jobs

The following analysis first processes population and jobs data at the County (SJC) level, where it is more readily available, followed by estimations at the City level. 

### County-level Analysis

The following datasets were collected for SJC:

- [Total Population, American Communities Survey, 1-Yr Estimates, 2010-2018](https://www.census.gov/programs-surveys/acs)
- [Population projections for US counties, 2020-2100](https://osf.io/9ynfc/)
- [Longitudinal Employer-Household Dynamics Origin-Destination Employment Statistics, 2010-2017](https://lehd.ces.census.gov/data/), available at the block level

A few notes on methodology and assumptions:

1. From the ACS, we collected Total Population, Total Population 16 and Older, Total Employed Residents (16+), and Unemployment Rate (for 16+). In order to forecast the future number of employed residents, which would then be used to forecast the future number of jobs, we chose to perform a linear regression on employment rate projecting to 2040, given that the unemployment rate was significantly more variable from 2010-2018.
2. Population projections come from a [study](https://www.nature.com/articles/sdata20195) published in Nature in 2019. The specific methodology is beyond the scope of this project to unpack. What's notable is that five different projections were made by the author based on diferent "potential futures involving various growth policies, fossil-fuel usage, mitigation policies (i.e. emission reductions), adaptation policies (i.e. deployment of flood defenses), and population change". We used the "Middle of the road" projection.
3. Projections from the above study were available in 5-year age groups. While the total population projection is directly used in the final table below for SJC, Population of 15+ was also collected which was multiplied by the previously projected Employment Rate (#1) to forecast total Employed Residents. Note that given data limitations we have a discontinuity between Population 16+ data from 2010-2018 and Population 15+ data from 2020-2040. We assume this difference is negligible for the purposes of our analysis, but it would have the effect of overestimating job count.
4. From LODES we collected "Primary Jobs" at the block group level and aggregated all jobs for block groups in SJC. These are meant to match the number of individual workers in a region. We also compared this number to the number of employees provided by the [Quarterly Workforce Indicators](https://www.census.gov/data/developers/data-sets/qwi.html) dataset and the number of nonemployer establishments in the [Nonemployer Statistics](https://www.census.gov/data/developers/data-sets/cbp-nonemp-zbp/nonemp-api.2017.html) dataset. The LODES Primary Jobs number was higher than the QWI Employee count but lower than the QWI Employee count plus Nonemployer Establishments count, which seems to make sense (since an individual could operate multiple nonemployer establishments).
5. We calculated J/ER for 2010-2018 by dividing total Jobs by Employed Residents. Then, we chose to perform a linear regression on J/ER ratio projecting to 2040, and multiplied this by our projected Employed Residents (#3) to forecast total Jobs.

```{r sjc-pop-jobs}
ca_counties <- counties("CA", cb = TRUE)
ca_tracts <- tracts("CA", cb = TRUE)
ca_bgs <- block_groups("CA", cb = TRUE)

county_neighbors <-
  ca_counties %>% 
  filter(NAME %in% c(
    "San Joaquin",
    "Alameda",
    "Sacramento",
    "Santa Clara",
    "Stanislaus",
    "Contra Costa",
    "San Francisco",
    "San Mateo",
    "Solano",
    "Fresno",
    "Placer",
    "Yolo",
    "Sonoma",
    "Merced",
    "Monterey"
  ))

pop_sjc <- data.frame(matrix(ncol=3,nrow=0))
colnames(pop_sjc) <- c("Population","Population15andolder","year")

for(year in 2010:2018){

  temp <-
    getCensus(
      name = "acs/acs1",
      vintage = year,
      vars = c("B01003_001E"),
      region = "county:077",
      regionin = "state:06"
    ) %>%
    mutate(
      Population = B01003_001E,
      year = year
    ) %>%
    dplyr::select(
      Population,
      year
    )

  pop_sjc<- rbind(pop_sjc,temp)

}

sjc_projection <-
  read_csv("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/SSP_asrc_STATEfiles/DATA-PROCESSED/SPLITPROJECTIONS/CA.csv") %>%
  filter(COUNTY == "077") %>%
  group_by(YEAR) %>%
  summarize(
    Population = sum(SSP2),
    Population15andOlder = sum(SSP2[which(AGE > 3)])
  ) %>%
  filter(YEAR %in% c(2020,2025,2030,2035,2040)) %>%
  dplyr::select(Population, Population15andOlder, year = YEAR)

pop_sjc_w_projection <-
  bind_rows(pop_sjc,sjc_projection)

emp_sjc <- data.frame(matrix(ncol=2,nrow=0))
colnames(emp_sjc) <- c("EmployedResidents","year")

for(year in 2010:2018){

  temp <-
    getCensus(
      name = "acs/acs1/subject",
      vintage = year,
      vars = c("S2301_C01_001E","S2301_C03_001E","S2301_C04_001E"),
      region = "county:077",
      regionin = "state:06"
    ) %>%
    mutate(
      Population16andOlder = S2301_C01_001E,
      PercEmployedResidents = S2301_C03_001E,
      EmployedResidents = PercEmployedResidents/100*Population16andOlder,
      UnemploymentRate = S2301_C04_001E,
      year = year
    ) %>%
    dplyr::select(
      Population16andOlder,
      PercEmployedResidents,
      EmployedResidents,
      UnemploymentRate,
      year
    )

  emp_sjc<- rbind(emp_sjc,temp)

}

pop_emp_sjc_w_projection <-
  pop_sjc_w_projection %>%
  left_join(emp_sjc, by = "year") %>%
  mutate(
    PercEmployedResidents = ifelse(
      !is.na(PercEmployedResidents),
      PercEmployedResidents,
      lm(
        formula = `PercEmployedResidents`[1:9] ~ year[1:9]
      )$coefficients[1]+
        lm(
          formula = `PercEmployedResidents`[1:9] ~ year[1:9]
        )$coefficients[2]*year
    ),
    EmployedResidents = ifelse(!is.na(EmployedResidents),EmployedResidents,Population15andOlder*PercEmployedResidents/100)
  )

# sjc_wac <-
#   2010:2017 %>%
#   map(function(year){
#     ca_wac <-
#       grab_lodes(
#         state = "ca",
#         year = year,
#         lodes_type = "wac",
#         job_type = "JT01",
#         segment = "S000",
#         state_part = "main",
#         agg_geo = "bg"
#       )
# 
#     temp <-
#       ca_wac %>%
#       filter(substr(w_bg,1,5) == "06077")
# 
#     return(temp)
#   }) %>%
#   rbindlist()
# 
# save(sjc_wac, file = "C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/sjc_wac.Rdata")
load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/sjc_wac.Rdata")

jobs_sjc <-
  sjc_wac %>%
  group_by(year) %>% 
  summarize(Jobs = sum(C000))

#Add 2018 jobs projection
jobs_sjc[9,1] <- 2018
jobs_sjc[9,2] <- 
  lm(formula = jobs_sjc$Jobs[1:8] ~ jobs_sjc$year[1:8])$coefficients[1]+
  lm(formula = jobs_sjc$Jobs[1:8] ~ jobs_sjc$year[1:8])$coefficients[2]*2018

pop_jobs_sjc_w_projection <-
  pop_emp_sjc_w_projection %>%
  left_join(jobs_sjc, by = "year") %>%
  mutate(
    ratio = ifelse(
      !is.na(Jobs),
      Jobs/EmployedResidents,
      lm(
        formula = Jobs[1:9]/EmployedResidents[1:9] ~ year[1:9]
      )$coefficients[1]+
        lm(
          formula = Jobs[1:9]/EmployedResidents[1:9] ~ year[1:9]
        )$coefficients[2]*year
    ),
    Jobs = ifelse(!is.na(Jobs),Jobs,EmployedResidents*ratio)
  ) %>%
  transmute(
    Year = year,
    Population = Population,
    Jobs = Jobs,
    `Employed Residents` = EmployedResidents,
    `J/ER Ratio` = ratio,
    `Percent Employed Residents` = PercEmployedResidents,
    `Percent Unemployment` = UnemploymentRate
  )

pop_jobs_sjc_w_projection_table <-
  pop_jobs_sjc_w_projection %>%
  transmute(
    Year = Year,
    Population = prettyNum(round(Population,-3),big.mark=","),
    Jobs = prettyNum(round(Jobs,-3),big.mark=","),
    `Employed Residents` = prettyNum(round(`Employed Residents`,-3),big.mark=","),
    `J/ER Ratio` = round(`J/ER Ratio`,2),
    `Percent Employed Residents` = paste0(round(`Percent Employed Residents`),"%"),
    `Percent Unemployment` = ifelse(is.na(`Percent Unemployment`),"NA",paste0(round(`Percent Unemployment`),"%"))
  )

# save(pop_jobs_sjc_w_projection, file = "C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/pop_jobs_sjc_w_projection.Rdata")

kable(
  pop_jobs_sjc_w_projection_table,
  booktabs = TRUE,
  caption = 'Historical population and job counts for San Joaquin County 2010-2017, followed by projections to 2040.'
) %>%
  kable_styling() %>%
  scroll_box(width = "100%")
```

$~$

The figure below shows the J/ER ratio projected out to 2040, reaching a high of 0.78. This is not particularly high (given our goal of surpassing 1). There is certainly room for improvement through proactive economic development strategies.

```{r sjc-jer, fig.cap = "Historical Jobs to Employed Residents Ratio for San Joaquin County 2010-2018, followed by projections to 2040."}
ggplot(pop_jobs_sjc_w_projection, aes(x = Year)) + 
  geom_line(aes(y = `J/ER Ratio`), size=2, colour = "forest green") +
  geom_vline(aes(xintercept = 2018), color = "dark grey") +
  annotate("text",label= "Data Available\n", color = "dark grey", x=2018, y=.75, angle = 90, size=4) +
  annotate("text",label= "\nForecast", color = "dark grey", x=2018, y=.75, angle = 90, size=4) +
  labs(title = "San Joaquin County, CA")
```

$~$

```{r sjc-projection, fig.cap = "Historical population, employed residents, and jobs for San Joaquin County 2010-2018, followed by projections to 2040."}
ggplot(pop_jobs_sjc_w_projection, aes(x = Year)) + 
  geom_line(aes(y = `Employed Residents`/100000, colour = "Employed Residents"), size = 2) +
  geom_line(aes(y = Jobs/100000, colour = "Jobs"), size = 2) +
  geom_line(aes(y = Population/100000, colour = "Population"), size = 2) + 
  geom_vline(aes(xintercept = 2018), color = "dark grey") +
  annotate("text",label= "Data Available\n", color = "dark grey", x=2018, y=5, angle = 90, size=4) +
  annotate("text",label= "\nForecast", color = "dark grey", x=2018, y=5, angle = 90, size=4) +
  scale_colour_manual(values = c("purple","blue","red")) + 
  labs(title = "San Joaquin County, CA", y = "Count (100,000s)", colour = "")
```

$~$

The following figure compares the J/ER ratio for SJC and its neighboring counties since 2010. SJC is toward the lower end of the group. It appears that all of these counties are stagnant or decreasing in this metric, and are all "bedroom counties" in the sense of being net exporters of workers during the day. 

```{r compare-jer, fig.cap = "Comparison of Jobs to Employment Ratio for different counties, 2010-2017."}
# county_jer <- NULL
# 
# for(year in 2010:2017){
#   
#   ca_wac <-
#     grab_lodes(
#       state = "ca",
#       year = year,
#       lodes_type = "wac",
#       job_type = "JT01",
#       segment = "S000",
#       state_part = "main",
#       agg_geo = "tract"
#     )
#   
#   for(county in county_neighbors$COUNTYFP){
#     
#      temp <-
#       getCensus(
#         name = "acs/acs1/subject",
#         vintage = year,
#         vars = c("S2301_C01_001E","S2301_C03_001E","S2301_C04_001E"),
#         region = paste0("county:",county),
#         regionin = "state:06"
#       ) %>%
#       mutate(
#         Population16andOlder = S2301_C01_001E,
#         PercEmployedResidents = S2301_C03_001E,
#         EmployedResidents = round( PercEmployedResidents/100*Population16andOlder),
#         Year = year,
#         Jobs = 
#           ca_wac %>% 
#           filter(substr(w_tract,3,5) == county) %>% 
#           pull(C000) %>% 
#           sum(na.rm=T),
#         County = county_neighbors[which(county_neighbors$COUNTYFP == county),]$NAME,
#       ) %>%
#       dplyr::select(
#         County,
#         Year,
#         Jobs,
#         EmployedResidents
#       )
#   
#     county_jer<- rbind(county_jer,temp)
#   }
# }
# 
# save(county_jer,file="C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/county_jer.Rdata")
load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/county_jer.Rdata")

county_jer %>% 
  filter(County %in% c("San Joaquin","Stanislaus","Alameda","Sacramento","Fresno","Solano","Contra Costa")) %>% 
  ggplot(
    aes(
      x = Year,
      y = Jobs/EmployedResidents,
      colour = County
    )
  ) +
  geom_line()
```

$~$

The [Quarterly Workforce Indicators](https://www.census.gov/data/developers/data-sets/qwi.html) dataset also illustrates the number and average quarterly earnings of jobs in different sub-level NAICS industry sectors (228 total). The table below is sorted by sectors with the most jobs in SJC.

```{r qwi}
label_industry <-
  read_csv("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/label_industry.csv")

# qwi_sjc <- data.frame(matrix(ncol=5,nrow=0))
# colnames(qwi_sjc) <- c("year","industry","label","EmpS","EarnS")
# 
# for(years in 2010:2018){
#   qwi<-
#     getCensus(
#       name = "timeseries/qwi/sa",
#       region = "county:077",
#       regionin = "state:06",
#       vars = c("EmpS","EarnS","industry","ind_level"),
#       time = years
#     ) %>%
#     filter(ind_level == 4) %>%
#     mutate(
#       year = substr(time,1,4)
#     ) %>%
#     left_join(label_industry, by= "industry") %>%
#     group_by(year,industry,label) %>%
#     summarize(
#       EmpS = round(mean(as.numeric(EmpS), na.rm = TRUE),0),
#       EarnS = round(mean(as.numeric(EarnS), na.rm = TRUE),0)
#     ) %>%
#     filter(!is.na(EmpS) & EmpS != 0)
# 
#   qwi_sjc<-
#     bind_rows(qwi_sjc,qwi)
# }
# 
# save(qwi_sjc, file = "C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/qwi_sjc.Rdata")
load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/qwi_sjc.Rdata")

qwi_sjc_18 <-
  qwi_sjc %>% 
  filter(year == 2018) %>% 
  arrange(desc(EmpS)) %>% 
  transmute(
    Label = label, 
    Jobs = prettyNum(round(EmpS,-2),big.mark=","), 
    `Average Quarterly Earnings` = paste0("$",prettyNum(round(EarnS,-2),big.mark=","))
  ) 

kable(
  qwi_sjc_18,
  booktabs = TRUE,
  caption = 'Job counts and earnings by NAICS industry sector for San Joaquin County 2018.'
) %>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "500px")
```

$~$

### City-level Analysis

The Nature journal population projections from the previous section are not available at the City level; in this case we chose to assume that Stockton's missing data was proportional to the related data we had at the County level. Otherwise, to scale our analysis down to Stockton, we collected data at the block group level. The following block groups were manually selected to represent Stockton.

```{r bgs, fig.cap = "Block groups used to represent Stockton population estimates. The red outline is the official city boundary."}
stockton_boundary <- 
  places("CA", cb = TRUE) %>% 
  filter(NAME == "Stockton") 

stockton_boundary_buffer <-
  stockton_boundary %>% 
  st_transform(26910) %>% 
  st_buffer(1600) %>% 
  st_transform(st_crs(stockton_boundary))
  
# includes unincorporated areas on periphery that have addresses in Stockton, but removing Lodi and Manteca areas
stockton_bgs_full <- 
  block_groups("CA", cb = TRUE)[stockton_boundary_buffer,c("GEOID")] %>% 
  filter(!(GEOID %in% c("060770051351","060770040011","060770041061","060770041022")))

# stockton_bgs_minimal <- 
#   block_groups("CA", cb = TRUE)[stockton_boundary,c("GEOID")] %>% 
#   filter(!(GEOID %in% c("060770040011","060770039001","060770041061","060770039001","060770039002","060770051311","060770051351","060770041022","06077002701","060770036012","060770015002","060770017001","060770017003","060770017002","060770027011","060770027012","060770027013","060770027014","060770037001")))

stockton_tracts_full <-
  tracts("CA", cb = TRUE)[stockton_boundary_buffer,c("GEOID")] %>% 
  filter(!(GEOID %in% c("06077004001","06077004106","06077005135")))

# mapview(stockton_tracts_full) + mapview(stockton_boundary, alpha.regions = 0, color = "red", lwd = 4)

# map <- mapview(stockton_bgs_full$geometry) + mapview(stockton_boundary$geometry, alpha.regions = 0, color = "red", lwd = 4)
# 
# mapshot(map,url="map-bgs.html")

knitr::include_url("http://web.stanford.edu/~douyang1/map-bgs.html")
```

$~$

```{r stockton-pop-jobs}
pop_stockton <- data.frame(matrix(ncol=3,nrow=0))
colnames(pop_stockton) <- c("PopulationStockton","Population15andolder","year")

for(year in 2010:2018){

  temp <-
    getCensus(
      name = "acs/acs1",
      vintage = year,
      vars = c("B01003_001E"),
      region = "place:75000",
      regionin = "state:06"
    ) %>%
    mutate(
      PopulationStockton = B01003_001E,
      year = year
    ) %>%
    dplyr::select(
      PopulationStockton,
      year
    )

  pop_stockton<- rbind(pop_stockton,temp)

}

emp_stockton <- data.frame(matrix(ncol=2,nrow=0))
colnames(emp_stockton) <- c("EmployedResidents","year")

for(year in 2010:2018){ 

  temp <-
    getCensus(
      name = "acs/acs1/subject",
      vintage = year,
      vars = c("S2301_C01_001E","S2301_C03_001E","S2301_C04_001E"),
      region = "place:75000",
      regionin = "state:06"
    ) %>%
    mutate(
      Population16andOlder = S2301_C01_001E,
      PercEmployedResidents = S2301_C03_001E,
      EmployedResidents = PercEmployedResidents/100*Population16andOlder,
      UnemploymentRate = S2301_C04_001E,
      year = year
    ) %>%
    dplyr::select(
      Population16andOlder,
      PercEmployedResidents,
      EmployedResidents,
      UnemploymentRate,
      year
    )

  emp_stockton<- rbind(emp_stockton,temp)

}

pop_emp_stockton_w_projection <-
  pop_sjc_w_projection %>%
  left_join(pop_stockton, by = "year") %>% 
  left_join(emp_stockton, by = "year") %>%
  mutate(
    PercStockton = PopulationStockton/Population,
    PercStocktonAdult = Population16andOlder/PopulationStockton,
    PercStockton = ifelse(
      !is.na(PercStockton),
      PercStockton,
      lm(
        formula = `PercStockton`[1:9] ~ year[1:9]
      )$coefficients[1]+
        lm(
          formula = `PercStockton`[1:9] ~ year[1:9]
        )$coefficients[2]*year
    ),
    PopulationStockton = Population * PercStockton,
    PopulationStockton15andOlder = Population15andOlder * PercStockton,
    PercEmployedResidents = ifelse(
      !is.na(PercEmployedResidents),
      PercEmployedResidents,
      lm(
        formula = `PercEmployedResidents`[1:9] ~ year[1:9]
      )$coefficients[1]+
        lm(
          formula = `PercEmployedResidents`[1:9] ~ year[1:9]
        )$coefficients[2]*year
    ),
    EmployedResidents = ifelse(
      !is.na(EmployedResidents),
      EmployedResidents,
      PopulationStockton15andOlder*PercEmployedResidents/100
    )
  )

# stockton_wac <-
#   2010:2017 %>%
#   map_dfr(function(year){
#     ca_wac <-
#       grab_lodes(
#         state = "ca",
#         year = year,
#         lodes_type = "wac",
#         job_type = "JT01",
#         segment = "S000",
#         state_part = "main",
#         agg_geo = "bg"
#       )
# 
#     temp <-
#       stockton_bgs_full %>%
#       geo_join(ca_wac, "GEOID", "w_bg")
# 
#     return(temp)
#   })
# 
# save(stockton_wac, file = "C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/stockton_wac.Rdata")
load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/stockton_wac.Rdata")

jobs_stockton <-
  stockton_wac %>% 
  group_by(year) %>% 
  summarize(Jobs = sum(C000))

#Add 2018 jobs projection
jobs_stockton[9,1] <- 2018
jobs_stockton[9,2] <- 
  lm(formula = jobs_stockton$Jobs[1:8] ~ jobs_stockton$year[1:8])$coefficients[1]+
  lm(formula = jobs_stockton$Jobs[1:8] ~ jobs_stockton$year[1:8])$coefficients[2]*2018

pop_jobs_stockton_w_projection <-
  pop_emp_stockton_w_projection %>%
  left_join(jobs_stockton, by = "year") %>%
  mutate(
    ratio = ifelse(
      !is.na(Jobs),
      Jobs/EmployedResidents,
      lm(
        formula = Jobs[1:9]/EmployedResidents[1:9] ~ year[1:9]
      )$coefficients[1]+
        lm(
          formula = Jobs[1:9]/EmployedResidents[1:9] ~ year[1:9]
        )$coefficients[2]*year
    ),
    Jobs = ifelse(!is.na(Jobs),Jobs,EmployedResidents*ratio)
  ) %>%
  transmute(
    Year = year,
    Population = PopulationStockton,
    Jobs = Jobs,
    `Employed Residents` = EmployedResidents,
    `J/ER Ratio` = ratio,
    `Percent Employed Residents` = PercEmployedResidents,
    `Percent Unemployment` = UnemploymentRate
  )

pop_jobs_stockton_w_projection_table <-
  pop_jobs_stockton_w_projection %>%
  transmute(
    Year = Year,
    Population = prettyNum(round(Population,-3),big.mark=","),
    Jobs = prettyNum(round(Jobs,-3),big.mark=","),
    `Employed Residents` = prettyNum(round(`Employed Residents`,-3),big.mark=","),
    `J/ER Ratio` = round(`J/ER Ratio`,2),
    `Percent Employed Residents` = paste0(round(`Percent Employed Residents`),"%"),
    `Percent Unemployment` = ifelse(is.na(`Percent Unemployment`),"NA",paste0(round(`Percent Unemployment`),"%"))
  )

# save(pop_jobs_stockton_w_projection, file = "C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/pop_jobs_stockton_w_projection.Rdata")

kable(
  pop_jobs_stockton_w_projection_table, 
  booktabs = TRUE,
  caption = 'Historical population and job counts for Stockton 2010-2018, followed by projections to 2040.'
  ) %>%
  kable_styling() %>%
  scroll_box(width = "100%")
```

$~$

Stockton's jobs to employed residents ratio trend for 2010-2018 is notable; while it has been higher overall than the County's J/ER ratio this decade, it has been trending slightly downwards where the County's has been trending upwards. One possible explanation would be that Stockton has received an influx of residents who are working outside of Stockton; perhaps such residents have been displaced further from their place of work, and have moved to Stockton where they could find more affordable housing. Further analysis would be necessary to test this explanation and others. It's also important to acknowledge that many good jobs held by Stockton residents may be just outside of official Stockton borders, in the industrial zones and neighboring cities, which still contribute to the local economy; that is why it's useful to look at both the city and county levels. But if this preliminary analysis is indicative of a growing imbalance, then Stockton should focus on aggressive strategies to reverse the trend and bring more quality jobs within its borders. 

```{r stockton-jer, fig.cap = "Historical jobs to employed residents ratio for Stockton 2010-2018, followed by projections to 2040."}
ggplot(pop_jobs_stockton_w_projection, aes(x = Year)) + 
  geom_line(aes(y = `J/ER Ratio`), size=2, colour = "forest green") +
  geom_vline(aes(xintercept = 2018), color = "dark grey") +
  annotate("text",label= "Data Available\n", color = "dark grey", x=2018, y=.75, angle = 90, size=4) +
  annotate("text",label= "\nForecast", color = "dark grey", x=2018, y=.75, angle = 90, size=4) +
  labs(title = "Stockton, CA")
```

$~$

```{r stockton-projection, fig.cap = "Historical population, employed residents, and jobs for Stockton 2010-2018, followed by projections to 2040."}
ggplot(pop_jobs_stockton_w_projection, aes(x = Year)) + 
  geom_line(aes(y = `Employed Residents`/100000, colour = "Employed Residents"), size = 2) +
  geom_line(aes(y = Jobs/100000, colour = "Jobs"), size = 2) +
  geom_line(aes(y = Population/100000, colour = "Population"), size = 2) + 
  geom_vline(aes(xintercept = 2018), color = "dark grey") +
  annotate("text",label= "Data Available\n", color = "dark grey", x=2018, y=2, angle = 90, size=4) +
  annotate("text",label= "\nForecast", color = "dark grey", x=2018, y=2, angle = 90, size=4) +
  scale_colour_manual(values = c("purple","blue","red")) + 
  labs(title = "Stockton, CA", y = "Count (100,000s)", colour = "")
```

$~$

Estimation of the average earnings of Stockton jobs is not possible using the QWI data from the previous section, which is only available at the County level. However, using LODES data, we can recreate a table of job counts by top-level NAICS industry sector (20 total).

```{r stockton-naics}
# stockton_rac <-
#   2010:2017 %>%
#   map_dfr(function(year){
#     ca_rac <-
#       grab_lodes(
#         state = "ca",
#         year = year,
#         lodes_type = "rac",
#         job_type = "JT01",
#         segment = "S000",
#         state_part = "main",
#         agg_geo = "bg"
#       )
# 
#     temp <-
#       stockton_bgs_full %>%
#       geo_join(ca_rac, "GEOID", "h_bg")
# 
#     return(temp)
#   })
# 
# save(stockton_rac, file = "C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/stockton_rac.Rdata")
load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/stockton_rac.Rdata")

jobs_stockton_residents <-
  stockton_rac %>%
  group_by(year) %>% 
  summarize_at(
    vars(CNS01:CNS20),
    sum,
    na.rm=T
  ) %>% 
  st_set_geometry(NULL) %>%
  gather(
    -year,
    key = "code",
    value = "Jobs"
  ) %>% 
  mutate(
    industry =
      case_when(
        code == "CNS01" ~ "Agriculture, Forestry, Fishing and Hunting",
        code == "CNS02" ~ "Mining, Quarrying, and Oil and Gas Extraction",
        code == "CNS03" ~ "Utilities",
        code == "CNS04" ~ "Construction",
        code == "CNS05" ~ "Manufacturing",
        code == "CNS06" ~ "Wholesale Trade",
        code == "CNS07" ~ "Retail Trade",
        code == "CNS08" ~ "Transportation and Warehousing",
        code == "CNS09" ~ "Information",
        code == "CNS10" ~ "Finance and Insurance",
        code == "CNS11" ~ "Real Estate and Rental and Leasing",
        code == "CNS12" ~ "Professional, Scientific, and Technical Services",
        code == "CNS13" ~ "Management of Companies and Enterprises",
        code == "CNS14" ~ "Administrative and Support and Waste Management and Remediation Services",
        code == "CNS15" ~ "Educational Services",
        code == "CNS16" ~ "Health Care and Social Assistance",
        code == "CNS17" ~ "Arts, Entertainment, and Recreation",
        code == "CNS18" ~ "Accommodation and Food Services",
        code == "CNS20" ~ "Public Administration",
        code == "CNS19" ~ "Other Services"
      )
  ) %>% 
  dplyr::select(-code)

jobs_stockton_residents_17 <-
  jobs_stockton_residents %>% 
  filter(year == 2017) %>%
  dplyr::select(-year) %>%
  arrange(desc(Jobs)) %>% 
  transmute(
    `NAICS Industry` = industry, 
    Jobs = prettyNum(round(Jobs,-2),big.mark=",")
  ) 

kable(
  jobs_stockton_residents_17, 
  booktabs = TRUE,
  caption = 'Job counts by NAICS industry sector for Stockton 2017.'
  ) %>%
  kable_styling() %>%
  scroll_box(width = "100%")
```

## Green Jobs

While there are many possible ways to identify "green jobs", this report uses the [Bureau of Labor Statistics Green Jobs Initiative](https://www.bls.gov/green/home.htm) classification of 333 NAICS industries which it has determined to potentially contain jobs that meet its definition of green jobs:

- Jobs in businesses that produce goods or provide services that benefit the environment or conserve natural resources.
- Jobs in which workers' duties involve making their establishment's production processes more environmentally friendly or use fewer natural resources.

Specifically, those 333 potential industries were classified into the following sub-categories:

- 58 in "Energy from renewable sources"
- 140 in "Energy efficiency"
- 124 in "Pollution reduction and removal, greenhouse gas reduction, and recycling and reuse"
- 75 in "Natural resource conservation"
- 45 in "Environmental compliance, education and training, and public awareness"

The following six tables filter the full Quarterly Workforce Indicators dataset to just the BLS-classified sectors, as well as further filtering in these five sub-categories. The top green job sectors span agriculture, building trades, and scientific research. This analysis is at the County level because the QWI data is only available at that scale.

```{r sjc-jobs}
green_jobs_classification <- 
  read_csv("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/green_jobs_classification.csv")

green_jobs_summary <-
  green_jobs_classification %>% 
  mutate(naics4digit = substr(`NAICS 2007`,1,4)) %>% 
  group_by(naics4digit) %>% 
  summarize(
    total = n(),
    green = sum(`BLS GGS in scope` =="Y"),
    green1 = sum(!is.na(`1. Energy from renewable sources`)),
    green2 = sum(!is.na(`2. Energy Efficiency`)),
    green3 = sum(!is.na(`3. Pollution reduction and removal, greenhouse gas reduction, and recycling and reuse`)),
    green4 = sum(!is.na(`4. Natural resource conservation`)),
    green5 = sum(!is.na(`5. Environmental compliance, education and training, and public awareness`))
  )

green_jobs_summary <-
  green_jobs_summary %>% 
  mutate_at(vars("green","green1","green2","green3","green4","green5"), function(x){x/green_jobs_summary$total}) %>% 
  filter(green > 0.5)

green_jobs_sjc_18 <-
  qwi_sjc %>% 
  filter(year == 2018, industry %in% green_jobs_summary$naics4digit) %>% 
  arrange(desc(EmpS)) %>% 
  transmute(
    `Green job category` = label, 
    Jobs = prettyNum(round(EmpS,-2),big.mark=","), 
    `Average Earnings` = paste0("$",prettyNum(round(EarnS,-2),big.mark=","))
  ) 

kable(
  green_jobs_sjc_18, 
  booktabs = TRUE, 
  caption = 'Job counts and earnings by NAICS industry sector classified by BLS to contain green jobs and services for San Joaquin County 2018.'
  ) %>% 
  kable_styling() %>%
  scroll_box(width = "100%", height = "500px")
```

$~$

```{r sjc-jobs1}
green1_jobs_sjc_18 <-
  qwi_sjc %>% 
  filter(year == 2018, industry %in% green_jobs_summary[which(green_jobs_summary$green1>0.5),]$naics4digit) %>%
  arrange(desc(EmpS)) %>% 
  transmute(
    `Green jobs related to Energy from renewable sources` = label, 
    Jobs = prettyNum(round(EmpS,-2),big.mark=","), 
    `Average Earnings` = paste0("$",prettyNum(round(EarnS,-2),big.mark=","))
  ) 

kable(
  green1_jobs_sjc_18, 
  booktabs = TRUE, 
  caption = 'Job counts and earnings by NAICS industry sector classified by BLS to contain green jobs and services related to "Energy from renewable sources" for San Joaquin County 2018.'
  ) %>% 
  kable_styling() %>%
  scroll_box(width = "100%")
```

$~$

```{r sjc-jobs2}
green2_jobs_sjc_18 <-
  qwi_sjc %>% 
  filter(year == 2018, industry %in% green_jobs_summary[which(green_jobs_summary$green2>0.5),]$naics4digit) %>%
  arrange(desc(EmpS)) %>% 
  transmute(
    `Green jobs related to Energy Efficiency` = label, 
    Jobs = prettyNum(EmpS,big.mark=","), 
    `Average Earnings` = paste0("$",prettyNum(EarnS,big.mark=","))
  ) 

kable(
  green2_jobs_sjc_18, 
  booktabs = TRUE, 
  caption = 'Job counts and earnings by NAICS industry sector classified by BLS to contain green jobs and services related to "Energy efficiency" for San Joaquin County 2018.'
  ) %>% 
  kable_styling() %>%
  scroll_box(width = "100%")
```

$~$

```{r sjc-jobs3}
green3_jobs_sjc_18 <-
  qwi_sjc %>% 
  filter(year == 2018, industry %in% green_jobs_summary[which(green_jobs_summary$green3>0.5),]$naics4digit) %>%
  arrange(desc(EmpS)) %>% 
  transmute(
    `Green jobs related to Pollution reduction and removal, greenhouse gas reduction, and recycling and reuse` = label, 
    Jobs = prettyNum(round(EmpS,-2),big.mark=","), 
    `Average Earnings` = paste0("$",prettyNum(round(EarnS,-2),big.mark=","))
  ) 

kable(
  green3_jobs_sjc_18, 
  booktabs = TRUE, 
  caption = 'Job counts and earnings by NAICS industry sector classified by BLS to contain green jobs and services related to "Pollution reduction and removal, greenhouse gas reduction, and recycling and reuse" for San Joaquin County 2018.'
  ) %>% 
  kable_styling() %>%
  scroll_box(width = "100%")
```

$~$

```{r sjc-jobs4}
green4_jobs_sjc_18 <-
  qwi_sjc %>% 
  filter(year == 2018, industry %in% green_jobs_summary[which(green_jobs_summary$green4>0.5),]$naics4digit) %>%
  arrange(desc(EmpS)) %>% 
  transmute(
    `Green jobs related to Natural resource conservation` = label, 
    Jobs = prettyNum(round(EmpS,-2),big.mark=","), 
    `Average Earnings` = paste0("$",prettyNum(round(EarnS,-2),big.mark=","))
  ) 

kable(
  green4_jobs_sjc_18, 
  booktabs = TRUE, 
  caption = 'Job counts and earnings by NAICS industry sector classified by BLS to contain green jobs and services related to "Natural resource conservation" for San Joaquin County 2018.'
  ) %>% 
  kable_styling() %>%
  scroll_box(width = "100%")
```

$~$

```{r sjc-jobs5}
green5_jobs_sjc_18 <-
  qwi_sjc %>% 
  filter(year == 2018, industry %in% green_jobs_summary[which(green_jobs_summary$green5>0.5),]$naics4digit) %>%
  arrange(desc(EmpS)) %>% 
  transmute(
    `Green jobs related to Environmental compliance, education and training, and public awareness` = label, 
    Jobs = prettyNum(round(EmpS,-2),big.mark=","), 
    `Average Earnings` = paste0("$",prettyNum(round(EarnS,-2),big.mark=","))
  ) 

kable(
  green5_jobs_sjc_18, 
  booktabs = TRUE, 
  caption = 'Job counts and earnings by NAICS industry sector classified by BLS to contain green jobs and services related to "Environmental compliance, education and training, and public awareness" for San Joaquin County 2017.'
  ) %>% 
  kable_styling() %>%
  scroll_box(width = "100%")
```

$~$

## 2005-2016 GHG Inventory

The State of California Governor's Office of Planning and Research recommends that California local governments follow ICLEI's [Community Greenhouse Gas Emissions Protocol](http://icleiusa.org/) when undertaking their greenhouse gas emissions inventories. ICLEI helped to produce Stockton's most recent [GHG Inventory in 2016](https://drive.google.com/open?id=1Zbb6apJ1eAT0BgLPOmBE0IYkDKZooUhd) which was compared to the previous inventory produced by ICF for the 2005 baseline year. The results from that report are copied below.

```{r iclei}
iclei_2005_2016 <-
  data.frame(
    "Year" = c(2005,2016),
    "Transportation" = c(1308696,1344846.19),
    "Solid Waste" = c(65720,61175),
    "Water/Wastewater" = c(115511,321486.42),
    "Agriculture" = c(928,947.298),
    "Commercial Energy" = c(369354,192191),
    "Industrial Energy" = c(60802,746225.84),
    "Residential Energy" = c(345862,267466),
    "Fugitive Emissions" = c(113080,159578.1397)
  ) %>% 
  rename(
    `Solid Waste` = Solid.Waste,
    `Water/Wastewater` = Water.Wastewater,
    `Commercial Energy` = Commercial.Energy,
    `Industrial Energy` = Industrial.Energy,
    `Residential Energy` = Residential.Energy,
    `Fugitive Emissions` = Fugitive.Emissions
  )

iclei_2005_2016_plot <-
  iclei_2005_2016 %>% 
  gather(
    key = "Type",
    value = "tCO2e",
    -Year
  ) %>% 
  arrange(Year,desc(tCO2e))

iclei_2005_2016_table <-
  iclei_2005_2016 %>% 
  transmute(
    Year = Year,
    Transportation = prettyNum(round(Transportation,-3),big.mark = ","),
    `Solid Waste` = prettyNum(round(`Solid Waste`,-3),big.mark = ","),
    `Water/Wastewater` = prettyNum(round(`Water/Wastewater`,-3),big.mark = ","),
    Agriculture = prettyNum(round(Agriculture,-2),big.mark = ","),
    `Commercial Energy` = prettyNum(round(`Commercial Energy`,-3),big.mark = ","),
    `Industrial Energy` = prettyNum(round(`Industrial Energy`,-3),big.mark = ","),
    `Residential Energy` = prettyNum(round(`Residential Energy`,-3),big.mark = ","),
    `Fugitive Emissions` = prettyNum(round(`Fugitive Emissions`,-3),big.mark = ",")
  )

kable(
  iclei_2005_2016_table, 
  booktabs = TRUE, 
  caption = 'Inventory comparisons for Stockton 2005-2016, from ICLEI. All units are in tCO2e.'
  ) %>% 
  kable_styling() %>%
  scroll_box(width = "100%")
```

$~$

```{r iclei-graph, fig.cap = "Inventory comparisons for Stockton 2005-2016, from ICLEI."}
iclei_2005_2016_plot %>% 
  mutate(
    Year = factor(
      as.character(Year), 
      levels = 
        c(
          "2016",
          "2005"
        )
      ),
    Type = factor(
      Type,
      levels = 
        c(
          "Transportation",
          "Solid Waste",
          "Water/Wastewater",
          "Agriculture",
          "Commercial Energy",
          "Industrial Energy",
          "Residential Energy",
          "Fugitive Emissions"
        )
    )
  ) %>% 
  ggplot() +
  geom_bar(
    aes(
      fill = Type, 
      x = Year, 
      weight = `tCO2e`
    ),
    position = "stack"
  ) +
  coord_flip() +
  theme(legend.position = "bottom") +
  labs(title = "GHG Inventory Comparisons for Stockton, 2005-2016", x = "Year", y = "tCO2e")
```

$~$

It is not within the scope of this project to formally update the 2016 ICLEI GHG Inventory for 2018, which is best completed by ICLEI or another similar organization. In fact, many of the significant components of ICLEI's formal GHG analysis, like "Water Energy" for example, are simply based off of an interpolation of population changes, given the lack of official data -- in other words, it is similar to what we have already done to project GHGs to 2040. We believe the following three focus areas are essential:

1. Normalization of the emissions by the incremental unit of activity, which is usually population, to understand the baseline rate of GHG emissions per actor. Unless we intend to directly limit the number of actors, these activity emission rates are fundamentally the factors that determine how large Stockton's footprint is. The reduction of activity emissions rates therefore becomes the critical problem to solve, either through behavior change, technology, or other means. We have already normalized overall emission sectors by jobs and population, but to get to the level of concrete green economy strategies, we will need to disaggregate further by specific key activities. The next few sections pursue this goal, focusing on some of the largest emitting activities: passenger vehicle driving and building energy.
2. Focusing on activity emissions rates also requires having direct measurement data in those same activity sectors to be able to calibrate our rates. For the two sectors we will focus on in the subsequent sections, passenger vehicle driving and building energy, there are fortunately recent public data sources we can use to calibrate our baseline rates, and we can expect these data sources to be available in the future so we can check whether rates have fallen in the ways we will have been hoping for, given our various strategic interventions. Part of our contribution through this project is to prepare scripts that can more easily update measurements in the future as soon as new public data is available, so that feedback can be obtained as efficiently as possible. These scripts also essentially help to update the most significant components of an overall GHG inventory analysis.
3. Since the availability of direct measurement data is critical to both the updating of GHG inventories and the understanding of the efficacy of our investments, we should also seek to increase the availability of direct measurement data in the sectors in which it is less readily available. These areas include industrial energy consumption (which is often restricted because of the California Public Utilities Commission's 15/15 rule, which means that utilities cannot provide data at aggregations with fewer than 15 customers or one customer greater than 15% of usage), water consumption (given the existence of private water providers), and waste production specific to Stockton residents (given that data is collected at the landfill but isn't disaggregated by truck routes or individual properties). These are all areas with opportunity for novel data sharing agreements to be negotiated by the City (e.g. the [PG&E Green Communities Program](https://www.pge.com/includes/docs/pdfs/mybusiness/environment/whatyoucando/greencommunities/GreenCommunities_SummaryPlanningReports.pdf), which effectively will enlist PG&E to directly complete the 3 steps outlined here for Stockton's building energy sector), and these efforts will improve the overall green economy initiative.

The following table shows a preliminary normalization of the 2005 and 2016 GHG emissions by residents and jobs, using the following allocation:

- Residential Energy and Transportation were allocated entirely to residents
- Commercial Energy, Agriculture, and Fugitive Emissions were allocated entirely to jobs
- Solid Waste and Water/Wastewater were distributed proportionally between residents and jobs
- Industrial Energy was not included, given the significant difference in methodology between 2005 and 2016 as documented by ICLEI

```{r iclei-norm}
# ca_wac_2005 <- 
#   grab_lodes(
#     state = "ca",
#     year = 2005,
#     lodes_type = "wac",
#     job_type = "JT01",
#     segment = "S000",
#     state_part = "main",
#     agg_geo = "bg"
#   )
# save(ca_wac_2005, file = "C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/ca_wac_2005.Rdata")
load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/ca_wac_2005.Rdata")

stockton_jobs_2005 <-
  stockton_bgs_full %>%
  geo_join(ca_wac_2005, "GEOID", "w_bg") %>% 
  pull(C000) %>% 
  sum(na.rm = TRUE)

iclei_2005_2016_normalized <- 
  iclei_2005_2016 %>% 
  transmute(
    Year = Year,
    `Total tCO2e` = `Residential Energy` + `Commercial Energy` + Agriculture + `Fugitive Emissions` + `Solid Waste` + `Water/Wastewater` + Transportation,
    Population = unlist(c(
      278515,
      pop_stockton[which(pop_stockton$year == 2016),"PopulationStockton"]
    )),
    Jobs = unlist(c(
      stockton_jobs_2005,
      jobs_stockton[which(jobs_stockton$year == 2016),"Jobs"] %>% st_set_geometry(NULL)
    )),
    PercResident = Population/(Population + Jobs),
    PercJob = Jobs/(Population + Jobs),
    `tCO2e per Resident` = (`Residential Energy` + Transportation + PercResident*(`Solid Waste` + `Water/Wastewater`))/Population,
    `tCO2e per Job` = (`Commercial Energy` + Agriculture + `Fugitive Emissions` + PercJob*(`Solid Waste` + `Water/Wastewater`))/Population
  ) %>% 
  dplyr::select(-PercResident,-PercJob)

iclei_2005_2016_normalized_table <-
  iclei_2005_2016_normalized %>% 
  mutate(
    `Total tCO2e` = prettyNum(round(`Total tCO2e`,-3),big.mark = ","),
    Population = prettyNum(round(Population,-3),big.mark = ","),
    Jobs = prettyNum(round(Jobs,-3),big.mark = ","),
    `tCO2e per Resident` = round(`tCO2e per Resident`,2),
    `tCO2e per Job` = round(`tCO2e per Job`,2)
  )

kable(
  iclei_2005_2016_normalized_table, 
  booktabs = TRUE, 
  caption = 'Inventory comparisons for Stockton 2005-2016, normalized by residents and jobs. Industrial emissions were removed for this table because of the differences in methodology between 2005 and 2016.'
  ) %>% 
  kable_styling() %>%
  scroll_box(width = "100%")
```

$~$

Based on the allocation assumptions, it appears that emissions per resident has decreased by 3.8% between 2005-2016, while emissions per job has decreased by 23%. These are both good signs, though there are gaps in the GHG inventories. Next, it is useful to drill down into the sub-sectors to reveal deeper insights.

## Origin-Destination Commute Analysis

As seen in the previous section, transportation is the largest single contributor of GHG emissions in Stockton, [as is true for all of California](https://ww2.arb.ca.gov/ghg-inventory-data). Within this sector, passenger vehicle emissions are by far the largest portion, and these are relatively easy to relate to their direct proxy, vehicle miles traveled (VMT), and normalize by drivers to understand current driving behavior. Specifically, commutes (driving to work) are the largest share of passenger vehicle emissions (other driving to/from amenities can be analyzed separately), and we can access data as recent as 2017 to understand commute patterns of Stockton residents to different job destinations inside and outside of SJC. What we find is that VMT is significant, and significantly locked in to the nature of job opportunity in faraway locations like the Bay Area. This means that VMT reduction is a crucial component in any overall green economy strategy, and it can be tackled directly through transportation strategies like public transit and EV deployment, but also indirectly by attracting high-quality jobs to Stockton, which on average will shift workers from faraway jobs to local jobs, thereby reducing VMTs. A comprehensive origin-destination commute analysis, as performed below, helps us quantify total VMTs attributable to commuting as well as model the specific impacts of different direct or indirect VMT reduction strategies.

In this section, we first examine the distribution of job locations for SJC in comparison to neighboring counties, as well as Stockton in particular. The following section will then analyze vehicle miles traveled for these commute trips.

### County-level Analysis

Our key dataset is from [Longitudinal Employer-Household Dynamics Origin-Destination Employment Statistics](https://lehd.ces.census.gov/data/) (LODES), which can be downloaded by state and is available up to 2017. 

Some reported workplaces in LODES are as far away as Los Angeles County and are likely data errors (e.g. the company headquarters is in Los Angeles but the actual workplace is much closer, or the employee works from home). These workplaces are left in the datasets shown in this section, but are removed later when calculating VMTs.

The LODES dataset also disaggregates jobs by three age groups:

- Number of jobs of workers age 29 or younger
- Number of jobs for workers age 30 to 54
- Number of jobs for workers age 55 or older

It also disaggregates jobs by three wage tiers:

- Number of jobs with earnings $1250/month or less
- Number of jobs with earnings \$1251/month to $3333/month
- Number of jobs with earnings greater than $3333/month 

It also disaggregates jobs by three broad sectors:

- Number of jobs in Goods Producing industry sectors
- Number of jobs in Trade, Transportation, and Utilities industry sectors
- Number of jobs in All Other Services industry sectors

The following table shows the counts of jobs in these subcategories that are held by SJC residents traveling to a workplace in SJC or its top 14 contiguous neighboring counties. The percent jobs shown are percentages of SJC employed residents; so of all SJC employed residents, 48% work within SJC.

```{r sjc-lodes-w-top-counties-table}
# for(year in 2002:2017){
# 
#   ca_lodes <-
#     grab_lodes(
#       state = "ca",
#       year = year,
#       lodes_type = "od",
#       job_type = "JT01", #Primary Jobs
#       segment = "S000",
#       state_part = "main",
#       agg_geo = "tract"
#     )
# 
#   for(county in county_neighbors$COUNTYFP){
#     county_tracts <-
#       ca_tracts %>%
#       filter(COUNTYFP == county)
# 
#     county_lodes_h <-
#       ca_lodes[which(ca_lodes$h_tract %in% county_tracts$GEOID),]
# 
#     save(county_lodes_h, file = paste0("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/county_lodes_",county,"_",year,"_tract_noroute.Rdata"))
# 
#   }
# }

load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/county_lodes_077_2017_tract_noroute.Rdata")

sjc_lodes_w_counties <- 
  county_lodes_h %>% 
  mutate(
    COUNTY = substr(w_tract,3,5)
  ) %>% 
  group_by(COUNTY) %>% 
  summarise_at(
    c("S000","SA01","SA02","SA03","SE01","SE02","SE03","SI01","SI02","SI03"), 
    sum,
    na.rm=T
  ) %>% 
  transmute(
    County = COUNTY,
    Jobs = S000,
    `Percent Jobs` = S000/sum(S000, na.rm=T),
    `Percent of jobs for workers age 29 or younger` = SA01/sum(SA01, na.rm=T),
    `Percent of jobs for workers age 30 to 54` = SA02/sum(SA02, na.rm=T),
    `Percent of jobs for workers age 55 or older` = SA03/sum(SA03, na.rm=T),
    `Percent of jobs with earnings $1250/month or less` = SE01/sum(SE01, na.rm=T),
    `Percent of jobs with earnings $1251/month to $3333/month` = SE02/sum(SE02, na.rm=T),
    `Percent of jobs with earnings greater than $3333/month` = SE03/sum(SE03, na.rm=T),
    `Percent of jobs in Goods Producing industry sectors` = SI01/sum(SI01, na.rm=T),
    `Percent of jobs in Trade, Transportation, and Utilities industry sectors` = SI02/sum(SI02, na.rm=T),
    `Percent of jobs in All Other Services industry sectors` = SI03/sum(SI03, na.rm=T)
  ) %>% 
  arrange(desc(Jobs))

sjc_lodes_w_top_counties <- 
  sjc_lodes_w_counties[1:19,] %>% 
  left_join(ca_counties %>% 
  dplyr::select(COUNTYFP, NAME), by = c("County" = "COUNTYFP")) %>% 
  dplyr::select(-County) %>%
  dplyr::select(NAME,everything()) %>% 
  rename(County = NAME) %>% 
  arrange(desc(Jobs)) %>% 
  filter(!County %in% c("Los Angeles","San Bernardino","Orange","San Diego")) %>% 
  st_as_sf()

sjc_lodes_w_top_counties_table <- 
  sjc_lodes_w_top_counties %>% 
  st_set_geometry(NULL) %>% 
  transmute(
    `County (where SJC residents work)` = County,
    `Jobs (held by SJC residents)` = prettyNum(round(Jobs,-2),big.mark=","),
    `Percent jobs (held by SJC residents)` = paste0(round(`Percent Jobs`*100),"%"),
    `Percent of jobs for workers age 29 or younger` = paste0(round(`Percent of jobs for workers age 29 or younger`*100),"%"),
    `Percent of jobs for workers age 30 to 54` = paste0(round(`Percent of jobs for workers age 30 to 54`*100),"%"),
    `Percent of jobs for workers age 55 or older` = paste0(round(`Percent of jobs for workers age 55 or older`*100),"%"),
    `Percent of jobs with earnings $1250/month or less` = paste0(round(`Percent of jobs with earnings $1250/month or less`*100),"%"),
    `Percent of jobs with earnings $1251/month to $3333/month` = paste0(round(`Percent of jobs with earnings $1251/month to $3333/month`*100),"%"),
    `Percent of jobs with earnings greater than $3333/month` = paste0(round(`Percent of jobs with earnings greater than $3333/month`*100),"%"),
    `Percent of jobs in Goods Producing industry sectors` = paste0(round(`Percent of jobs in Goods Producing industry sectors`*100),"%"),
    `Percent of jobs in Trade, Transportation, and Utilities industry sectors` = paste0(round(`Percent of jobs in Trade, Transportation, and Utilities industry sectors`*100),"%"),
    `Percent of jobs in All Other Services industry sectors` = paste0(round(`Percent of jobs in All Other Services industry sectors`*100),"%")
  )

kable(
  sjc_lodes_w_top_counties_table, 
  booktabs = TRUE, 
  caption = 'Top 15 counties where SJC residents work, including SJC. Los Angeles, San Bernardino, Orange, and San Diego Counties were removed. Data from LODES, 2017.'
  ) %>% 
  kable_styling() %>%
  scroll_box(width = "100%")
```

$~$

The following table compares SJC with neighboring counties in terms of the percentage of jobs held by its residents that are "local", meaning within the same county. This figure mirrors Figure 2.3, which showed J/ER ratio for the same counties, all stagnating or in decline. The figure below provides one contribution, which is declining local jobs for local residents, not just for SJC but for its neighboring counties.

```{r county-localjobs, fig.cap="Percent of county residents who work within their home county, 2002 to 2017. Data from LODES."}
county_localjobs <- NULL

for(year in 2002:2017){
  for(county in county_neighbors$COUNTYFP){
    load(paste0("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/county_lodes_",county,"_",year,"_tract_noroute.Rdata"))
    
    county_lodes_w_counties <- 
      county_lodes_h %>% 
      mutate(
        COUNTY = substr(w_tract,3,5)
      ) %>%
      group_by(COUNTY) %>% 
      summarise_at(
        c("S000","SA01","SA02","SA03","SE01","SE02","SE03","SI01","SI02","SI03"), 
        sum,
        na.rm=T
      ) %>% 
      transmute(
        Year = year,
        County = COUNTY,
        Jobs = S000,
        `Percent Jobs` = S000/sum(S000, na.rm=T),
        `Percent of jobs for workers age 29 or younger` = SA01/sum(SA01, na.rm=T),
        `Percent of jobs for workers age 30 to 54` = SA02/sum(SA02, na.rm=T),
        `Percent of jobs for workers age 55 or older` = SA03/sum(SA03, na.rm=T),
        `Percent of jobs with earnings $1250/month or less` = SE01/sum(SE01, na.rm=T),
        `Percent of jobs with earnings $1251/month to $3333/month` = SE02/sum(SE02, na.rm=T),
        `Percent of jobs with earnings greater than $3333/month` = SE03/sum(SE03, na.rm=T),
        `Percent of jobs in Goods Producing industry sectors` = SI01/sum(SI01, na.rm=T),
        `Percent of jobs in Trade, Transportation, and Utilities industry sectors` = SI02/sum(SI02, na.rm=T),
        `Percent of jobs in All Other Services industry sectors` = SI03/sum(SI03, na.rm=T)
      ) %>% 
      filter(County == county) %>% 
      mutate(County = county_neighbors[which(county_neighbors$COUNTYFP == county),]$NAME)
    
    county_localjobs <-
      county_localjobs %>% 
      rbind(
        county_lodes_w_counties
      )
  }
}

county_localjobs %>% 
  filter(County %in% c("San Joaquin","Alameda","Fresno","Stanislaus","Sacramento","Contra Costa")) %>%
  ggplot(
    aes(
      x = Year,
      y = `Percent Jobs`,
      colour = County
    )
  ) +
  geom_line()
```

$~$

### City-level Analysis

The following table shows the counts of jobs in these subcategories for the top 15 contiguous neighboring counties to Stockton, including SJC. Note that the jobs being counted are those held by Stockton residents who are traveling to a workplace in the listed regions. 41% of Stockton employed residents work within Stockton. These jobs could be considered valuable for avoiding the "brain drain" of local talent to other places, as well as for creating the smallest transportation footprint.

```{r stockton-lodes-w-top-counties-table}
# for(year in 2002:2017){
# 
#   ca_lodes <-
#     grab_lodes(
#       state = "ca",
#       year = year,
#       lodes_type = "od",
#       job_type = "JT01", #Primary Jobs
#       segment = "S000",
#       state_part = "main",
#       agg_geo = "bg"
#     )
# 
#     stockton_lodes_h <-
#       ca_lodes[which(ca_lodes$h_bg %in% stockton_bgs_full$GEOID),]
# 
#     save(stockton_lodes_h, file = paste0("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/stockton_lodes_",year,"_tract_noroute.Rdata"))
# 
# }

load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/stockton_lodes_2017_tract_noroute.Rdata")

stockton_lodes_w_counties <- 
  stockton_lodes_h %>% 
  mutate(
    Workplace = ifelse(
      w_bg %in% stockton_bgs_full$GEOID,
      "75000",
      substr(w_bg,3,5)
    )
  ) %>% 
  group_by(Workplace) %>% 
  summarise_at(
    c("S000","SA01","SA02","SA03","SE01","SE02","SE03","SI01","SI02","SI03"), 
    sum,
    na.rm=T
  ) %>% 
  transmute(
    Workplace = Workplace,
    Jobs = S000,
    `Percent Jobs` = S000/sum(S000, na.rm=T),
    `Percent of jobs for workers age 29 or younger` = SA01/sum(SA01, na.rm=T),
    `Percent of jobs for workers age 30 to 54` = SA02/sum(SA02, na.rm=T),
    `Percent of jobs for workers age 55 or older` = SA03/sum(SA03, na.rm=T),
    `Percent of jobs with earnings $1250/month or less` = SE01/sum(SE01, na.rm=T),
    `Percent of jobs with earnings $1251/month to $3333/month` = SE02/sum(SE02, na.rm=T),
    `Percent of jobs with earnings greater than $3333/month` = SE03/sum(SE03, na.rm=T),
    `Percent of jobs in Goods Producing industry sectors` = SI01/sum(SI01, na.rm=T),
    `Percent of jobs in Trade, Transportation, and Utilities industry sectors` = SI02/sum(SI02, na.rm=T),
    `Percent of jobs in All Other Services industry sectors` = SI03/sum(SI03, na.rm=T)
  ) %>%  
  arrange(desc(Jobs))

#merge county shapefile with stockton geometry
ca_counties_and_stockton <-
  ca_counties %>% 
  dplyr::select(COUNTYFP, NAME) %>% 
  rbind(
    stockton_boundary %>% 
      mutate(
        COUNTYFP = PLACEFP
      ) %>% 
      dplyr::select(COUNTYFP, NAME)
  )

ca_counties_and_stockton[which(ca_counties_and_stockton$COUNTYFP == "077"),] <-
  st_difference(
    ca_counties_and_stockton[which(ca_counties_and_stockton$COUNTYFP == "077"),],
    ca_counties_and_stockton[which(ca_counties_and_stockton$NAME == "Stockton"),]
  ) %>% 
  dplyr::select(COUNTYFP,NAME)

ca_counties_and_stockton[which(ca_counties_and_stockton$COUNTYFP == "077"),]$NAME <-
  "San Joaquin (not including Stockton)"

stockton_lodes_w_top_counties <- 
  stockton_lodes_w_counties[1:19,] %>% 
  left_join(ca_counties_and_stockton %>% 
  dplyr::select(COUNTYFP, NAME), by = c("Workplace" = "COUNTYFP")) %>% 
  dplyr::select(-Workplace) %>%
  dplyr::select(NAME,everything()) %>% 
  rename(County = NAME) %>% 
  arrange(desc(Jobs)) %>% 
  filter(!County %in% c("Los Angeles","San Bernardino","Orange","San Diego")) %>% 
  st_as_sf()

stockton_lodes_w_top_counties_table <- 
  stockton_lodes_w_top_counties %>% 
  st_set_geometry(NULL) %>% 
  transmute(
    `Workplace (where Stockton residents work)` = County,
    `Jobs (held by Stockton residents)` = prettyNum(round(Jobs,-2),big.mark=","),
    `Percent jobs (held by Stockton residents)` = paste0(round(`Percent Jobs`*100),"%"),
    `Percent of jobs for workers age 29 or younger` = paste0(round(`Percent of jobs for workers age 29 or younger`*100),"%"),
    `Percent of jobs for workers age 30 to 54` = paste0(round(`Percent of jobs for workers age 30 to 54`*100),"%"),
    `Percent of jobs for workers age 55 or older` = paste0(round(`Percent of jobs for workers age 55 or older`*100),"%"),
    `Percent of jobs with earnings $1250/month or less` = paste0(round(`Percent of jobs with earnings $1250/month or less`*100),"%"),
    `Percent of jobs with earnings $1251/month to $3333/month` = paste0(round(`Percent of jobs with earnings $1251/month to $3333/month`*100),"%"),
    `Percent of jobs with earnings greater than $3333/month` = paste0(round(`Percent of jobs with earnings greater than $3333/month`*100),"%"),
    `Percent of jobs in Goods Producing industry sectors` = paste0(round(`Percent of jobs in Goods Producing industry sectors`*100),"%"),
    `Percent of jobs in Trade, Transportation, and Utilities industry sectors` = paste0(round(`Percent of jobs in Trade, Transportation, and Utilities industry sectors`*100),"%"),
    `Percent of jobs in All Other Services industry sectors` = paste0(round(`Percent of jobs in All Other Services industry sectors`*100),"%")
  )

kable(
  stockton_lodes_w_top_counties_table, 
  booktabs = TRUE, 
  # caption = 'Top 15 workplaces where Stockton residents work. Includes Stockton as a workplace destination separate from the rest of SJC. All other listed workplaces are counties. Los Angeles, San Bernardino, Orange, and San Diego Counties were removed. Data from LODES, 2017.'
  ) %>% 
  kable_styling() %>%
  scroll_box(width = "100%")
```

$~$

The following maps help to visualize the specific distribution of Stockton residents' jobs in the categories of age, earnings, and industry sector. 

37% of younger (under 29) Stockton employed residents work within Stockton, and another 15% work outside of Stockton but within SJC. Beyond that, there are higher concentrations of these younger workers in Sacramento and Alameda County compared to other neighboring counties.

```{r stockton-lodes-w-top-counties-youth, fig.cap="Top 13 counties where Stockton residents work, not including SJC - percent of overall jobs for Stockton workers age 29 or younger located in workplace. Data from LODES, 2017."}
# map <- mapview(stockton_lodes_w_top_counties[-c(1,2),c("Percent of jobs for workers age 29 or younger")], zcol = "Percent of jobs for workers age 29 or younger", map.types = c("OpenStreetMap"), legend = TRUE, layer.name = 'Percent of jobs</br>for workers age</br>29 or younger')
# 
# mapshot(map,url="map-stockton-lodes-w-top-counties-youth.html")

knitr::include_url("http://web.stanford.edu/~douyang1/map-stockton-lodes-w-top-counties-youth.html")
```

$~$

46% of lower-wage (less than $1,250/month) Stockton employed residents work within Stockton, and another 13% work outside of Stockton but within SJC. Beyond that, there is a higher concentration of these lower-wage workers in Sacramento County compared to other neighboring counties.

```{r stockton-lodes-w-top-counties-lowinc, fig.cap="Top 13 counties where Stockton residents work, not including SJC - percent of overall jobs for Stockton workers with earnings $1250/month or less located in workplace. Data from LODES, 2017."} 

# map = mapview(stockton_lodes_w_top_counties[-c(1,2),c("Percent of jobs with earnings $1250/month or less")], zcol = "Percent of jobs with earnings $1250/month or less", map.types = c("OpenStreetMap"), legend = TRUE, layer.name = 'Percent of jobs</br>with earnings</br>$1250/month or less')
# 
# mapshot(map,url="map-stockton-lodes-w-top-counties-lowinc.html")

knitr::include_url("http://web.stanford.edu/~douyang1/map-stockton-lodes-w-top-counties-lowinc.html")
```

$~$

38% of higher-wage (greater than $3,333/month) Stockton employed residents work within Stockton, and another 12% work outside of Stockton but within SJC. Note these percentages are lower than the percentages of lower-wage jobs that remain local. Beyond that, there is a higher concentration of these high-wage workers in Alameda County compared to other neighboring counties. Perhaps targeted marketing of businesses that are providing these higher-wage jobs in Alameda County to move to Stockton could be an effective investment.

```{r stockton-lodes-w-top-counties-highinc, fig.cap="Top 13 counties where Stockton residents work, not including SJC - percent of overall jobs for Stockton residents with earnings greater than $3333/month located in workplace. Data from LODES, 2017."}
# map = mapview(stockton_lodes_w_top_counties[-c(1,2),c("Percent of jobs with earnings greater than $3333/month")], zcol = "Percent of jobs with earnings greater than $3333/month", map.types = c("OpenStreetMap"), legend = TRUE, layer.name = 'Percent of jobs</br>with earnings</br>greater than</br>$3333/month')
# 
# mapshot(map,url="map-stockton-lodes-w-top-counties-highinc.html")

knitr::include_url("http://web.stanford.edu/~douyang1/map-stockton-lodes-w-top-counties-highinc.html")
```

$~$

30% of Stockton employed residents in Goods Producing industry sectors work within Stockton, and another 23% (a notably high percentage) work outside of Stockton but within SJC. Beyond that, there is a higher concentration of these high-wage workers in Alameda County compared to other neighboring counties.

```{r stockton-lodes-w-top-counties-goods, fig.cap="Top 13 counties where Stockton residents work, not including SJC - percent of jobs for Stockton residents in Goods Producing industry sectors located in workplace. Data from LODES, 2017."}
# map = mapview(stockton_lodes_w_top_counties[-c(1,2),c("Percent of jobs in Goods Producing industry sectors")], zcol = "Percent of jobs in Goods Producing industry sectors", map.types = c("OpenStreetMap"), legend = TRUE, layer.name = 'Percent of jobs</br>in Goods Producing</br>industry sectors')
# 
# mapshot(map,url="map-stockton-lodes-w-top-counties-goods.html")

knitr::include_url("http://web.stanford.edu/~douyang1/map-stockton-lodes-w-top-counties-goods.html")
```

$~$

33% of Stockton employed residents in Trade, Transportation, and Utilities industry sectors work within Stockton, and another 18% work outside of Stockton but within SJC. Beyond that, there are higher concentrations of these high-wage workers in Sacramento and Alameda County compared to other neighboring counties.

```{r stockton-lodes-w-top-counties-trade, fig.cap="Top 13 counties where Stockton residents work, not including SJC - percent of jobs for Stockton residents in Trade, Transportation, and Utilities industry sectors located in workplace. Data from LODES, 2017."}
# # map = mapview(stockton_lodes_w_top_counties[-c(1,2),c("Percent of jobs in Trade, Transportation, and Utilities industry sectors")], zcol = "Percent of jobs in Trade, Transportation, and Utilities industry sectors", map.types = c("OpenStreetMap"), legend = TRUE, layer.name = 'Percent of jobs</br>in Trade, Transportation,</br>and Utilities</br>industry sectors')
# 
# mapshot(map,url="map-stockton-lodes-w-top-counties-trade.html")

knitr::include_url("http://web.stanford.edu/~douyang1/map-stockton-lodes-w-top-counties-trade.html")
```

$~$

48% (a notably high percentage) of Stockton employed residents in All Other Services industry sectors work within Stockton, and another 10% work outside of Stockton but within SJC. Beyond that, there is a higher concentrations of these high-wage workers in Alameda County compared to other neighboring counties.

```{r stockton-lodes-w-top-counties-services, fig.cap="Top 13 counties where Stockton residents work, not including SJC - percent of jobs for Stockton residents in All Other Services industry sectors located in workplace. Data from LODES, 2017."}
# map = mapview(stockton_lodes_w_top_counties[-c(1,2),c("Percent of jobs in All Other Services industry sectors")], zcol = "Percent of jobs in All Other Services industry sectors", map.types = c("OpenStreetMap"), legend = TRUE, layer.name = 'Percent of jobs</br>in All Other Services</br>industry sectors')
# 
# mapshot(map,url="map-stockton-lodes-w-top-counties-services.html")

knitr::include_url("http://web.stanford.edu/~douyang1/map-stockton-lodes-w-top-counties-services.html")
```

$~$

While LODES origin-destination data doesn't provide job types at a granularity lower than the three broad industry sector categories in the previous three maps, one possible assumption to make is that the distribution of NAICS industry sectors in a destination block group, which is available through the separate Workplace Area Characteristics dataset from LODES, is the same distribution for specifically Stockton residents who work in that block group. Using this assumption, we created estimates of the locations of specific types of industries and wage levels for Stockton employed residents.

The percentages in the table below should be interpreted as the % of overall jobs held by Stockton residents of that industry sector and wage tier that are based in San Joaquin County (the remainder being based in other counties). Particularly notable here are the low-percentage estimates of high-wage jobs in sectors generally related to the "knowledge economy": Finance and Insurance (38%), Information (28%), and Professional, Scientific, and Technical Services (19%). Also notable is the low percentage of high-wage jobs in Construction (35%), which may include specialized building trades such as solar installation. These percentages are relative to an overall 64% of high-wage jobs being based in SJC, which suggests that the best jobs in these notable industries are significantly underrepresented in the local economy.

```{r stockton-lodes-w-sjc-detail-table}
# ca_wac <-
#   2010:2017 %>%
#   map_dfr(function(year){
#     ca_wac <-
#       grab_lodes(
#         state = "ca",
#         year = year,
#         lodes_type = "wac",
#         job_type = "JT01",
#         segment = "S000",
#         state_part = "main",
#         agg_geo = "bg"
#       )
# 
#     return(ca_wac)
#   })
# 
# save(ca_wac, file = "C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/ca_wac.Rdata")

load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/ca_wac.Rdata")

load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/stockton_lodes_2017_tract_noroute.Rdata")

stockton_lodes_h_join_wac <- 
  stockton_lodes_h %>% 
  dplyr::select(-c(year,state)) %>% 
  left_join(
    ca_wac %>% 
      filter(year == 2017), 
    by = "w_bg"
  )

stockton_lodes_h_join_wac_normalize <-
  stockton_lodes_h_join_wac %>% 
  mutate(
    goodsproducing = CNS01+CNS02+CNS04+CNS05,
    tradetransportutil = CNS03+CNS06+CNS07+CNS08,
    services = CNS09+CNS10+CNS11+CNS12+CNS13+CNS14+CNS15+CNS16+CNS17+CNS18+CNS19+CNS20
  ) %>% 
  mutate_at(
    .vars = vars(CNS01,CNS02,CNS04,CNS05),
    .funs = list(~ SI01*./goodsproducing)
  ) %>% 
  mutate_at(
    .vars = vars(CNS03,CNS06,CNS07,CNS08),
    .funs = list(~ SI02*./tradetransportutil)
  ) %>%
  mutate_at(
    .vars = vars(CNS09:CNS20),
    .funs = list(~ SI03*./services)
  ) %>% 
  dplyr::select(-c(SA01:SA03,C000:CE03,CR01:CFS05),SE01,SE02,SE03) %>% 
  mutate(low=SE01,mid=SE02,high=SE03) %>% 
  gather(key = "type", value, low:high) %>% 
  mutate_at(
    .vars = vars(CNS01:CNS20),
    .funs = list(~ ./S000*value)
  ) %>% 
  gather(key = "type2", value2, CNS01:CNS20) %>% 
  unite(temp,type,type2) %>% 
  spread(temp,value2) %>% 
  filter(value > 0) %>% 
  dplyr::select(-value)

stockton_lodes_w_counties_detail<-
  stockton_lodes_h_join_wac_normalize %>%
  mutate(
    Workplace = ifelse(
      w_bg %in% stockton_bgs_full$GEOID,
      "75000",
      substr(w_bg,3,5)
    )
  ) %>%
  group_by(Workplace) %>%
  summarise_at(
    vars(S000,SE01,SE02,SE03,high_CNS01:mid_CNS20),
    sum, 
    na.rm=T
  ) %>%
  mutate_at(
    .vars = vars(high_CNS01:mid_CNS20),
    .funs = list(~ round(.,0))
  )

stockton_lodes_w_sjc_detail <-
  rbind(
    stockton_lodes_w_counties_detail[which(stockton_lodes_w_counties_detail$Workplace == "75000"),-1],
    stockton_lodes_w_counties_detail[,-1] %>% 
    colSums()
  ) %>% 
  t() %>%
  as.data.frame() %>% 
  rownames_to_column() %>% 
  mutate(
    perc = round(V1/V2*100,0),
    rowname = 
      case_when(
        rowname == "SE01" ~ "low_Total",
        rowname == "SE02" ~ "mid_Total",
        rowname == "SE03" ~ "high_Total",
        TRUE ~ rowname
      )
  ) %>% 
  dplyr::select(-V1,-V2) %>% 
  filter(!rowname %in% c("S000")) %>% 
  separate(
    rowname,
    into = c("wage","industry"),
    sep = "_"
  ) %>% 
  mutate(
    industry =
      case_when(
        industry == "CNS01" ~ "Agriculture, Forestry, Fishing and Hunting",
        industry == "CNS02" ~ "Mining, Quarrying, and Oil and Gas Extraction",
        industry == "CNS03" ~ "Utilities",
        industry == "CNS04" ~ "Construction",
        industry == "CNS05" ~ "Manufacturing",
        industry == "CNS06" ~ "Wholesale Trade",
        industry == "CNS07" ~ "Retail Trade",
        industry == "CNS08" ~ "Transportation and Warehousing",
        industry == "CNS09" ~ "Information",
        industry == "CNS10" ~ "Finance and Insurance",
        industry == "CNS11" ~ "Real Estate and Rental and Leasing",
        industry == "CNS12" ~ "Professional, Scientific, and Technical Services",
        industry == "CNS13" ~ "Management of Companies and Enterprises",
        industry == "CNS14" ~ "Administrative and Support and Waste Management and Remediation Services",
        industry == "CNS15" ~ "Educational Services",
        industry == "CNS16" ~ "Health Care and Social Assistance",
        industry == "CNS17" ~ "Arts, Entertainment, and Recreation",
        industry == "CNS18" ~ "Accommodation and Food Services",
        industry == "CNS20" ~ "Public Administration",
        industry == "CNS19" ~ "Other Services",
        TRUE ~ industry
      )
  ) %>% 
  spread(wage,perc) %>% 
  dplyr::select(
    `NAICS Industry` = industry,
    `% Stockton Jobs in Stockton with earnings $1250/month or less` = low,
    `% Stockton Jobs in Stockton with earnings $1251/month to $3333/month` = mid,
    `% Stockton Jobs in Stockton with earnings greater than $3333/month` = high
  )

stockton_lodes_w_sjc_detail_table <-
  rbind(
    stockton_lodes_w_sjc_detail[which(stockton_lodes_w_sjc_detail$`NAICS Industry`=="Total"),],
    stockton_lodes_w_sjc_detail[which(stockton_lodes_w_sjc_detail$`NAICS Industry`!="Total"),]
  ) %>% 
  mutate_at(
    .vars = vars(-`NAICS Industry`),
    .funs = list(~ paste0(.,"%"))
  )

kable(
  stockton_lodes_w_sjc_detail_table, 
  booktabs = TRUE, 
  caption = 'Percent of Stockton employed residents working in Stockton, by NAICS industry and wage tier. Data from LODES, 2017.'
  ) %>% 
  kable_styling() %>%
  scroll_box(width = "100%")
```

$~$

The following maps highlight where some of these "underrepresented" jobs are distributed throughout the top counties where Stockton residents work.

```{r stockton-lodes-w-construction-high, fig.cap = "Top 10 counties where Stockton residents work, not including jobs in Stockton - number of high-wage jobs in Construction. Amount in Stockton: 900. Data from LODES, 2017."}
stockton_lodes_w_construction_high <-
  ca_counties_and_stockton %>% 
  dplyr::select(COUNTYFP, NAME) %>% 
  left_join(stockton_lodes_w_counties, by = c("COUNTYFP" = "Workplace")) %>% 
  left_join(stockton_lodes_w_counties_detail, by = c("COUNTYFP" = "Workplace")) %>% 
  dplyr::select(-COUNTYFP) %>%
  filter(!NAME %in% c("Stockton","Los Angeles","San Bernardino","Orange","San Diego","Riverside")) %>% 
  filter(!is.na(Jobs)) %>% 
  arrange(desc(Jobs)) %>% 
  dplyr::select(
    County = NAME,
    `Number of High-wage Construction jobs` = high_CNS04
  )

# map = mapview(stockton_lodes_w_construction_high[1:10,c("Number of High-wage Construction jobs")], zcol = "Number of High-wage Construction jobs", map.types = c("OpenStreetMap"), legend = TRUE, layer.name = 'Number of</br>High-wage</br>Construction jobs')
# 
# mapshot(map,url="map-stockton-lodes-w-construction-high.html")

knitr::include_url("http://web.stanford.edu/~douyang1/map-stockton-lodes-w-construction-high.html")
```

$~$

```{r stockton-lodes-w-scientific-high, fig.cap = "Top 10 counties where Stockton residents work, not including jobs in Stockton - number of high-wage jobs in Professional, Scientific, and Technical Services. Amount in Stockton: 400. Data from LODES, 2017."}
stockton_lodes_w_scientific_high <-
  ca_counties_and_stockton %>% 
  dplyr::select(COUNTYFP, NAME) %>% 
  left_join(stockton_lodes_w_counties, by = c("COUNTYFP" = "Workplace")) %>% 
  left_join(stockton_lodes_w_counties_detail, by = c("COUNTYFP" = "Workplace")) %>% 
  dplyr::select(-COUNTYFP) %>%
  filter(!NAME %in% c("Stockton","Los Angeles","San Bernardino","Orange","San Diego","Riverside")) %>% 
  filter(!is.na(Jobs)) %>% 
  arrange(desc(Jobs)) %>% 
  dplyr::select(
    County = NAME,
    `Number of Professional, Scientific, and Technical Services jobs` = high_CNS12
  )

# map = mapview(stockton_lodes_w_scientific_high[1:10,c("Number of Professional, Scientific, and Technical Services jobs")], zcol = "Number of Professional, Scientific, and Technical Services jobs", map.types = c("OpenStreetMap"), legend = TRUE, layer.name = 'Number of</br>Professional,</br>Scientific,</br>and Technical</br>Services jobs')
# 
# mapshot(map,url="map-stockton-lodes-w-scientific-high.html")

knitr::include_url("http://web.stanford.edu/~douyang1/map-stockton-lodes-w-scientific-high.html")
```

$~$

Note that for high-wage jobs in Professional, Scientific, and Technical Services, San Joaquin County isn't even the top employer of Stockton residents. 

## Commute Vehicle Miles Traveled

Building off the Origin-Destination Commute Analysis from the previous section, we isolated every unique pair of SJC or Stockton home block groups and work block groups and used the [Open Source Routing Machine](http://project-osrm.org/) to compute a distance (in miles) and duration (and hours) for a one-way trip. Using this analysis, combined with some estimates of mode choice (single-occupancy vehicle vs. carpool vs. other), we created estimates of vehicle miles traveled for a certain number of jobs and were able to see how see how SJC and Stockton residents have changed their driving behavior over time, and how that behavior has compared to neighboring counties. Finally, we used VMT to estimate the GHG footprint of commuting for Stockton residents. 

Our analysis in this section focuses on destinations with average commute times of less than 3 hours, which eliminates the unrealistic commutes while preserving more than 90% of reported commutes. We suspect that many of the other commutes with purported destinations like Los Angeles County are erroneously reported, and the actual workplace location is unavailable to us. Note, however, that it could be true that some workers commute to southern California, though not every weekday, and it also could be true to some workers commute by flight, which presents its own distinct and potentially significant GHG analysis which is outside the scope of this report.

### County-level Analysis

The following table shows commute data for SJC residents from 2011 to 2017, including estimates of the number of total jobs held by residents, the number of those jobs that are car-dependent, and the number of those jobs that are carpooled (according to ACS). The routing analysis provides distances between each origin and destination, which are totaled up to person miles traveled. The conversion to vehicle miles traveled is based on the following assumptions:

- For each origin-destination block group pair, we used ACS 1-yr 2017 data on commute mode by travel time for the origin block group to estimate a share of travelers commuting by single occupancy vehicle and by carpooling, and applied this factor to the count of jobs from LODES to estimate a total number of vehicle trips and vehicle mildes traveled (VMT).
- For carpool trips, we counted 2-person carpools as 1 vehicle for every 2 jobs, and 3-or-more-person carpools as 1 vehicle for every 3 jobs.

```{r county-commute-vmt-tractmode-table}
# for(year in 2011:2017){
#   for(county in c("013")){
# 
#     print(paste0(county,"-",year))
# 
#     ca_lodes <-
#       grab_lodes(
#         state = "ca",
#         year = year,
#         lodes_type = "od",
#         job_type = "JT01", #Primary Jobs
#         segment = "S000",
#         state_part = "main",
#         agg_geo = "tract"
#       )
#     
#     save(ca_lodes, file = paste0("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/ca_lodes_",year,"_tract.Rdata"))
# 
#     county_tracts <-
#       ca_tracts %>%
#       filter(COUNTYFP == county)
# 
#     county_lodes_h <-
#       ca_lodes[which(ca_lodes$h_tract %in% county_tracts$GEOID),]
# 
#     county_lodes_h_origin_centroids <-
#       st_centroid(ca_tracts[which(ca_tracts$GEOID %in% county_lodes_h$h_tract),])
# 
#     county_lodes_h_dest_centroids <-
#       st_centroid(ca_tracts[which(ca_tracts$GEOID %in% county_lodes_h$w_tract),])
# 
#     route <-
#       1:nrow(county_lodes_h) %>%
#       map_dfr(function(row){
#         print(row)
#         route <- osrmRoute(
#           src = county_lodes_h_origin_centroids[which(county_lodes_h_origin_centroids$GEOID %in% county_lodes_h[row,"h_tract"]),],
#           dst = county_lodes_h_dest_centroids[which(county_lodes_h_dest_centroids$GEOID %in% county_lodes_h[row,"w_tract"]),],
#           overview = FALSE
#         ) %>%
#           as.list() %>%
#           as.data.frame()
#         if(is_empty(route)){
#           return(
#             data.frame(
#               duration = NA,
#               distance = NA
#             )
#           )
#         } else {return(route)}
#       })
# 
#     county_lodes_h_route <-
#       county_lodes_h %>%
#       cbind(route)
# 
#     county_lodes_h_filter <-
#       county_lodes_h_route %>%
#       filter(duration < 180)
# 
#     save(county_lodes_h_route,county_lodes_h_filter, file = paste0("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/county_lodes_",county,"_",year,"_tract.Rdata"))
#   }
# }

# county_commute_vmt_tractmode <- NULL
# 
# for(year in 2011:2017){
#   for(county in c("013")){
#     print(paste0(year,"-",county))
# 
#     load(paste0("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/county_lodes_",county,"_",year,"_tract.Rdata"))
# 
#     load(paste0("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/acs5_vars_",year,".Rdata"))
# 
#     travel_time_mode <-
#       getCensus(
#         name = "acs/acs5",
#         vintage = year,
#         region = "tract:*",
#         regionin = paste0("state:06+county:",county),
#         vars = "group(B08134)"
#       ) %>%
#       mutate(tract = paste0(state,county,tract)) %>%
#       select_if(!names(.) %in% c("GEO_ID","state","county","NAME")) %>%
#       dplyr::select(-c(contains("EA"),contains("MA"),contains("M"))) %>%
#       gather(
#         key = "variable",
#         value = "estimate",
#         -tract
#       ) %>%
#       mutate(
#         label = acs_vars$label[match(variable,acs_vars$name)],
#         time = # This extracts only the time information from our label.
#           substr(
#             label,
#             lapply(
#               label,
#               function(x){
#                 ifelse(
#                   length(unlist(gregexpr('!!',x)))<3,
#                   NA,
#                   max(unlist(gregexpr('!!',x)))+2
#                 )
#               }
#             ),
#             nchar(label)
#           ),
#         mode = # This extracts only the mode information from our label. It doesn't fully deal with double-counting, so some are further removed later on in a filter.
#           substr(
#             label,
#             lapply(
#               label,
#               function(x){
#                 ifelse(
#                   length(unlist(gregexpr('!!',x)))<3,
#                   NA,
#                   unlist(gregexpr('!!',x))[length(unlist(gregexpr('!!',x)))-1]+2
#                 )
#               }
#             ),
#             lapply(
#               label,
#               function(x){
#                 max(unlist(gregexpr('!!',x)))-1
#               }
#             )
#           )
#       ) %>%
#       filter(!is.na(time)) %>% # This removes the grand total rows that are usually at the top of the ACS data.
#       filter(!mode %in% c("Car, truck, or van","Car truck or van","Carpooled","Public transportation (excluding taxicab)")) %>% # This removes double-counted subtotals.
#       dplyr::select(-variable,-label)
# 
#     travel_time_mode_summary <-
#       travel_time_mode %>%
#       group_by(tract,time) %>%
#       summarize(
#         jobs = sum(estimate),
#         jobs_drovealone = sum(estimate[which(mode == "Drove alone")]),
#         jobs_carpool2 = sum(estimate[which(mode == "In 2-person carpool")]),
#         jobs_carpool3 = sum(estimate[which(mode == "In 3-or-more-person carpool")]),
#       ) %>%
#       mutate(
#         vehicles_drovealone = jobs_drovealone,
#         vehicles_carpool2 = jobs_carpool2/2,
#         vehicles_carpool3 = jobs_carpool3/3,
#         jobs_car = jobs_drovealone+jobs_carpool2+jobs_carpool3,
#         jobs_carpool = jobs_carpool2+jobs_carpool3,
#         vehicles = vehicles_drovealone,vehicles_carpool2,vehicles_carpool3,
#         perc_jobs_car = jobs_car/jobs,
#         perc_jobs_carpool = jobs_carpool/jobs,
#         perc_vehicle = vehicles/jobs
#       )
# 
#   county_lodes_h_mode <-
#     county_lodes_h_filter %>%
#     transmute(
#       residence = h_tract,
#       jobs = S000,
#       duration = duration,
#       person_miles = S000*as.numeric(distance)/1.60934,
#       person_hours = S000*as.numeric(duration)/60
#     ) %>%
#     mutate(
#       tier =
#         case_when(
#           duration < 10 ~ "Less than 10 minutes",
#           duration < 15 ~ "10 to 14 minutes",
#           duration < 20 ~ "15 to 19 minutes",
#           duration < 25 ~ "20 to 24 minutes",
#           duration < 30 ~ "25 to 29 minutes",
#           duration < 35 ~ "30 to 34 minutes",
#           duration < 45 ~ "35 to 44 minutes",
#           duration < 60 ~ "45 to 59 minutes",
#           TRUE ~ "60 or more minutes"
#         )
#     ) %>%
#     left_join(
#       travel_time_mode_summary %>%
#         dplyr::select(
#           tract,
#           time,
#           perc_jobs_car,
#           perc_jobs_carpool,
#           perc_vehicle
#         ),
#       by = c("residence" = "tract", "tier" = "time")
#     ) %>%
#     mutate(
#       jobs_car = jobs*perc_jobs_car,
#       jobs_carpool = jobs*perc_jobs_carpool,
#       vehicles = jobs*perc_vehicle,
#       vmt = person_miles*perc_vehicle
#     )
# 
#     county_commute_vmt_tractmode <-
#       rbind(county_commute_vmt_tractmode,
#         data.frame(
#           Year = year,
#           County = county,
#           person_miles = sum(county_lodes_h_mode$person_miles, na.rm=T),
#           jobs = sum(county_lodes_h_mode$jobs, na.rm=T),
#           jobs_car = sum(county_lodes_h_mode$jobs_car, na.rm=T),
#           jobs_carpool = sum(county_lodes_h_mode$jobs_carpool, na.rm=T),
#           vehicles = sum(county_lodes_h_mode$vehicles, na.rm = T),
#           vmt = sum(county_lodes_h_mode$vmt, na.rm=T)
#         )
#       )
# 
#     save(county_commute_vmt_tractmode,file = "C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/county_commute_vmt_tractmode.Rdata")
#   }
# }
#
# county_commute_vmt_countymode <- NULL
# 
# for(year in 2011:2017){
#   for(county in c("013")){
# 
#     print(paste0(year,"-",county))
# 
#     load(paste0("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/county_lodes_",county,"_",year,"_tract.Rdata"))
# 
#     load(paste0("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/acs1_vars_",year,".Rdata"))
# 
#     travel_time_mode <-
#     getCensus(
#       name = "acs/acs1",
#       vintage = year,
#       region = paste0("county:",county),
#       regionin = "state:06",
#       vars = "group(B08134)"
#     ) %>%
#     select_if(!names(.) %in% c("GEO_ID","state","NAME")) %>%
#     dplyr::select(-c(contains("EA"),contains("MA"),contains("M"))) %>%
#     gather(
#       key = "variable",
#       value = "estimate",
#       -county
#     ) %>%
#     mutate(
#       label = acs_vars$label[match(variable,acs_vars$name)],
#       time = # This extracts only the time information from our label.
#         substr(
#           label,
#           lapply(
#             label,
#             function(x){
#               ifelse(
#                 length(unlist(gregexpr('!!',x)))<3,
#                 NA,
#                 max(unlist(gregexpr('!!',x)))+2
#               )
#             }
#           ),
#           nchar(label)
#         ),
#       mode = # This extracts only the mode information from our label. It doesn't fully deal with double-counting, so some are further removed later on in a filter.
#         substr(
#           label,
#           lapply(
#             label,
#             function(x){
#               ifelse(
#                 length(unlist(gregexpr('!!',x)))<3,
#                 NA,
#                 unlist(gregexpr('!!',x))[length(unlist(gregexpr('!!',x)))-1]+2
#               )
#             }
#           ),
#           lapply(
#             label,
#             function(x){
#               max(unlist(gregexpr('!!',x)))-1
#             }
#           )
#         )
#     ) %>%
#     filter(!is.na(time)) %>% # This removes the grand total rows that are usually at the top of the ACS data.
#     filter(!mode %in% c("Car, truck, or van","Car truck or van","Carpooled","Public transportation (excluding taxicab)")) %>% # This removes double-counted subtotals.
#     dplyr::select(-variable,-label)
# 
#     travel_time_mode_summary <-
#       travel_time_mode %>%
#       group_by(time) %>%
#       summarize(
#         jobs = sum(estimate),
#         jobs_drovealone = sum(estimate[which(mode == "Drove alone")]),
#         jobs_carpool2 = sum(estimate[which(mode == "In 2-person carpool")]),
#         jobs_carpool3 = sum(estimate[which(mode == "In 3-or-more-person carpool")]),
#       ) %>%
#       mutate(
#         vehicles_drovealone = jobs_drovealone,
#         vehicles_carpool2 = jobs_carpool2/2,
#         vehicles_carpool3 = jobs_carpool3/3,
#         jobs_car = jobs_drovealone+jobs_carpool2+jobs_carpool3,
#         jobs_carpool = jobs_carpool2+jobs_carpool3,
#         vehicles = vehicles_drovealone,vehicles_carpool2,vehicles_carpool3,
#         perc_jobs_car = jobs_car/jobs,
#         perc_jobs_carpool = jobs_carpool/jobs,
#         perc_vehicle = vehicles/jobs
#       )
# 
#   county_lodes_h_mode <-
#     county_lodes_h_filter %>%
#     transmute(
#       jobs = S000,
#       duration = duration,
#       person_miles = S000*as.numeric(distance)/1.60934,
#       person_hours = S000*as.numeric(duration)/60
#     ) %>%
#     mutate(
#       tier =
#         case_when(
#           duration < 10 ~ "Less than 10 minutes",
#           duration < 15 ~ "10 to 14 minutes",
#           duration < 20 ~ "15 to 19 minutes",
#           duration < 25 ~ "20 to 24 minutes",
#           duration < 30 ~ "25 to 29 minutes",
#           duration < 35 ~ "30 to 34 minutes",
#           duration < 45 ~ "35 to 44 minutes",
#           duration < 60 ~ "45 to 59 minutes",
#           TRUE ~ "60 or more minutes"
#         )
#     ) %>%
#     left_join(
#       travel_time_mode_summary %>%
#         dplyr::select(
#           time,
#           perc_jobs_car,
#           perc_jobs_carpool,
#           perc_vehicle
#         ),
#       by = c("tier" = "time")
#     ) %>%
#     mutate(
#       jobs_car = jobs*perc_jobs_car,
#       jobs_carpool = jobs*perc_jobs_carpool,
#       vehicles = jobs*perc_vehicle,
#       vmt = person_miles*perc_vehicle
#     )
# 
#     county_commute_vmt_countymode <-
#       rbind(county_commute_vmt_countymode,
#         data.frame(
#           Year = year,
#           County = county,
#           person_miles = sum(county_lodes_h_mode$person_miles, na.rm=T),
#           jobs = sum(county_lodes_h_mode$jobs, na.rm=T),
#           jobs_car = sum(county_lodes_h_mode$jobs_car, na.rm=T),
#           jobs_carpool = sum(county_lodes_h_mode$jobs_carpool, na.rm=T),
#           vehicles = sum(county_lodes_h_mode$vehicles, na.rm = T),
#           vmt = sum(county_lodes_h_mode$vmt, na.rm=T)
#         )
#       )
#   }
# }
# 
# save(county_commute_vmt_countymode, file = "C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/county_commute_vmt_countymode.Rdata")
# load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/county_commute_vmt_countymode.Rdata")
# 
# county_commute_vmt_countymode %>% 
#   filter(jobs_car != 0) %>% 
#   ggplot(
#     aes(
#       x = Year,
#       y = vmt/jobs,
#       colour = County
#     )
#   ) +
#   geom_line()
# 
# load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/county_commute_vmt_tractmode.Rdata")
# 
# load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/county_commute_vmt_countymode.Rdata")
# 
# county_commute_vmt_compare <-
#   rbind(
#     county_commute_vmt_tractmode %>% 
#       mutate(type = "tract"),
#     county_commute_vmt_countymode %>% 
#       mutate(type = "county")
#   )
# 
# county_commute_vmt_compare %>% 
#   filter(jobs_car != 0) %>% 
#   ggplot(
#     aes(
#       x = Year,
#       y = vmt/jobs,
#       linetype = type,
#       colour = County
#     )
#   ) +
#   geom_line()

load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/county_commute_vmt_tractmode.Rdata")

county_commute_vmt_tractmode_table <-
  county_commute_vmt_tractmode %>% 
  filter(County == "077") %>%
  left_join(county_neighbors, by = c("County" = "COUNTYFP")) %>% 
  transmute(
    Year = Year,
    `Jobs held by SJC residents` = prettyNum(round(jobs,-3),big.mark=","),
    `Car-dependent jobs` = prettyNum(round(jobs_car,-3),big.mark=","),
    `Carpooled jobs` = prettyNum(round(jobs_carpool,-3),big.mark=","),
    `Vehicles driven by SJC residents` = prettyNum(round(vehicles,-3),big.mark=","),
    `Person miles traveled` = prettyNum(round(person_miles,-4),big.mark=","),
    `Vehicle miles traveled` = prettyNum(round(vmt,-4),big.mark=",")
  )

kable(
  county_commute_vmt_tractmode_table,
  booktabs = TRUE,
  caption = 'Commute data for SJC residents, 2011 to 2017. Data from LODES.'
) %>% 
  kable_styling() %>% 
  scroll_box(width = "100%")
```

$~$

The following figure shows one-way commute VMT/job for SJC and its neighboring counties from 2011 to 2017. Note that this VMT/job ratio divides VMTs equally among all car-dependent jobs, leaving out non-car-dependent jobs (never more than 10% of jobs, as can be seen in the previous table).

SJC is at the top of the figure, 25 miles/job in 2017, vying with Stanislaus County to have the highest average commute distance per car-dependent worker.

```{r county-commute-vmt-tractmode-graph, fig.cap="One-way commute miles per car-dependent worker by county, 2011 to 2017. Data from LODES."}
county_commute_vmt_tractmode %>% 
  left_join(county_neighbors, by = c("County" = "COUNTYFP")) %>% 
  ggplot(
    aes(
      x = Year,
      y = vmt/jobs_car,
      colour = NAME
    )
  ) +
  geom_line() + 
  labs(y = "One-way commute VMT per\ncar-dependent worker") + 
  scale_color_discrete(name = "County")
```

$~$

One of the possible contributions to an increasing VMT/job isn't necessarily further away jobs but less carpooling to get to those jobs. The following figure shows that the percent of car-dependent SJC workers who carpool has declined from 2015 to 2017, similar to Stanislaus and Sacramento County.

```{r county-modeshare, fig.cap="Percent of car-dependent commuters traveling by carpool, by county, 2011 to 2017. Data from LODES and ACS."}
# county_modeshare <- NULL
# 
# for(year in 2011:2017){
#   for(county in county_neighbors$COUNTYFP){
#     
#     print(paste0(year,"-",county))
#     
#     load(paste0("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/acs1_vars_",year,".Rdata"))
#     
#     travel_time_mode <-
#     getCensus(
#       name = "acs/acs1",
#       vintage = year,
#       region = paste0("county:",county),
#       regionin = "state:06",
#       vars = "group(B08134)"
#     ) %>%
#     select_if(!names(.) %in% c("GEO_ID","state","NAME")) %>%
#     dplyr::select(-c(contains("EA"),contains("MA"),contains("M"))) %>%
#     gather(
#       key = "variable",
#       value = "estimate",
#       -county
#     ) %>%
#     mutate(
#       label = acs_vars$label[match(variable,acs_vars$name)],
#       time = # This extracts only the time information from our label.
#         substr(
#           label,
#           lapply(
#             label,
#             function(x){
#               ifelse(
#                 length(unlist(gregexpr('!!',x)))<3,
#                 NA,
#                 max(unlist(gregexpr('!!',x)))+2
#               )
#             }
#           ),
#           nchar(label)
#         ),
#       mode = # This extracts only the mode information from our label. It doesn't fully deal with double-counting, so some are further removed later on in a filter.
#         substr(
#           label,
#           lapply(
#             label,
#             function(x){
#               ifelse(
#                 length(unlist(gregexpr('!!',x)))<3,
#                 NA,
#                 unlist(gregexpr('!!',x))[length(unlist(gregexpr('!!',x)))-1]+2
#               )
#             }
#           ),
#           lapply(
#             label,
#             function(x){
#               max(unlist(gregexpr('!!',x)))-1
#             }
#           )
#         )
#     ) %>%
#     filter(!is.na(time)) %>% # This removes the grand total rows that are usually at the top of the ACS data.
#     filter(!mode %in% c("Car, truck, or van","Car truck or van","Carpooled","Public transportation (excluding taxicab)")) %>% # This removes double-counted subtotals.
#     dplyr::select(-variable,-label)
#     
#     travel_time_mode_summary <-
#       travel_time_mode %>%
#       summarize(
#         jobs = sum(estimate),
#         jobs_drovealone = sum(estimate[which(mode == "Drove alone")]),
#         jobs_carpool2 = sum(estimate[which(mode == "In 2-person carpool")]),
#         jobs_carpool3 = sum(estimate[which(mode == "In 3-or-more-person carpool")]),
#       ) %>% 
#       mutate(
#         vehicles_drovealone = jobs_drovealone,
#         vehicles_carpool2 = jobs_carpool2/2,
#         vehicles_carpool3 = jobs_carpool3/3,
#         jobs_car = jobs_drovealone+jobs_carpool2+jobs_carpool3,
#         jobs_carpool = jobs_carpool2+jobs_carpool3,
#         vehicles = vehicles_drovealone,vehicles_carpool2,vehicles_carpool3,
#         perc_jobs_car = jobs_car/jobs,
#         perc_jobs_carpool = jobs_carpool/jobs,
#         perc_vehicle = vehicles/jobs
#       )
#     
#     county_modeshare <-
#       county_modeshare %>% 
#       rbind(
#         data.frame(
#           year = year,
#           county = county,
#           jobs = travel_time_mode_summary$jobs,
#           perc_jobs_car = travel_time_mode_summary$perc_jobs_car,
#           perc_jobs_carpool = travel_time_mode_summary$perc_jobs_carpool,
#           perc_vehicle = travel_time_mode_summary$perc_vehicle
#         )
#       )
#   }
# }
# 
# save(county_modeshare, file = "C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/county_modeshare.Rdata")
# load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/county_modeshare.Rdata")
# 
# county_modeshare %>% 
#   filter(county %in% c("077","001","013","067","099")) %>% 
#   filter(jobs != 0) %>% 
#   left_join(county_neighbors, by = c("county" = "COUNTYFP")) %>% 
#   ggplot(
#     aes(
#       x = year,
#       y = perc_jobs_carpool/perc_jobs_car*100,
#       colour = NAME
#     )
#   ) +
#   geom_line() +
#   labs(x = "Year", y = "% Car-dependent workers who carpool") + 
#   scale_color_discrete(name = "County")

county_commute_vmt_tractmode %>% 
  left_join(county_neighbors, by = c("County" = "COUNTYFP")) %>% 
  ggplot(
    aes(
      x = Year,
      y = jobs_carpool/jobs_car,
      colour = NAME
    )
  ) +
  geom_line() + 
  labs(y = "% Car-dependent workers who carpool") + 
  scale_color_discrete(name = "County")
```

$~$

### City-level Analysis

The following graph shows the distribution of workplaces by distance from home for Stockton residents.

```{r stockton-commute-vmt-distribution-2017, fig.cap="Distribution of workplaces by distance from home for Stockton employed residents. Trips greater than 3 hours are removed. Data from LODES, 2017."}
# for(year in 2011:2017){
#   
#   print(year)
#   
#   ca_lodes <-
#     grab_lodes(
#       state = "ca",
#       year = year,
#       lodes_type = "od",
#       job_type = "JT01", #Primary Jobs
#       segment = "S000",
#       state_part = "main",
#       agg_geo = "bg"
#     )
#   
#   stockton_lodes_h <-
#     ca_lodes[which(ca_lodes$h_bg %in% stockton_bgs_full$GEOID),]
#   
#   stockton_lodes_h_origin_centroids <-
#     st_centroid(ca_bgs[which(ca_bgs$GEOID %in% stockton_lodes_h$h_bg),])
#   
#   stockton_lodes_h_dest_centroids <-
#     st_centroid(ca_bgs[which(ca_bgs$GEOID %in% stockton_lodes_h$w_bg),])
#   
#   route <-
#     1:nrow(stockton_lodes_h) %>%
#     map_dfr(function(row){
#       print(row)
#       route <- osrmRoute(
#         src = stockton_lodes_h_origin_centroids[which(stockton_lodes_h_origin_centroids$GEOID %in% stockton_lodes_h[row,"h_bg"]),],
#         dst = stockton_lodes_h_dest_centroids[which(stockton_lodes_h_dest_centroids$GEOID %in% stockton_lodes_h[row,"w_bg"]),],
#         overview = FALSE
#       ) %>%
#         as.list() %>%
#         as.data.frame()
#       if(is_empty(route)){
#         return(
#           data.frame(
#             duration = NA,
#             distance = NA
#           )
#         )
#       } else {return(route)}
#     })
#   
#   stockton_lodes_h_route <-
#     stockton_lodes_h %>%
#     cbind(route)
#   
#   stockton_lodes_h_filter <-
#     stockton_lodes_h_route %>%
#     filter(duration < 180)
#   
#   save(stockton_lodes_h_route,stockton_lodes_h_filter, file = paste0("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/stockton_lodes_",year,".Rdata"))
# }

load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/stockton_lodes_2017_tract.Rdata")

ggplot(
  stockton_lodes_h_filter, 
  aes(
    x = as.numeric(distance)/1.60934, 
    weight = S000
  )
) +
  geom_histogram(binwidth = 5) +
  labs(title = "Workplace Commute Distance to Work for Stockton Employed Residents", x = "Commute Distance to Work, Miles", y = "Number of Residents")
```

$~$

The map below demonstrates the extent of geographic spread of Stockton residents across the greater Northern California region, potentially on a day-to-day basis. Most of the tracts shown have only a handful of estimated Stockton workers, but interesting concentrations of workers can be seen by zooming in and hovering over areas like the East Bay.

```{r stockton-jobs-map, fig.cap="Tracts where Stockton residents work - number of jobs. Data from LODES, 2017."}
stockton_jobs_map <-
  stockton_lodes_h_filter %>% 
  group_by(w_tract) %>% 
  summarize(
    `Jobs held by Stockton residents` = sum(S000, na.rm=T)
  ) %>% 
  left_join(ca_tracts, by = c("w_tract" = "GEOID")) %>%
  st_as_sf()

# map = mapview(stockton_jobs_map[,c("Jobs held by Stockton residents")], zcol = "Jobs held by Stockton residents", col.regions = colorRampPalette(c("snow", "black", "grey")), map.types = c("OpenStreetMap"), legend = TRUE, layer.name = 'Jobs held by</br>Stockton residents')
# 
# mapshot(map,url="map-stockton-jobs-map.html")

knitr::include_url("http://web.stanford.edu/~douyang1/map-stockton-jobs-map.html")
```

$~$

The previous map can be considered in combination with the map below, which essentially shows the average distance in miles traveled one-way by Stockton workers to those tracts. Evidently, workers traveling to further-away tracts are responsible for a disproportionate share of the transportation emissions compared to other Stockton workers.

```{r stockton-commute-avg, fig.cap="Tracts where Stockton residents work - average commute time, in hours. Data from LODES, 2017."}
stockton_commute_avg <-
  stockton_lodes_h_filter %>% 
  group_by(w_tract) %>% 
  summarize(
    `Average Commute Time, Hours` = mean(duration, na.rm=T)
  ) %>% 
  left_join(ca_tracts, by = c("w_tract" = "GEOID")) %>%
  st_as_sf()

# map = mapview(stockton_commute_avg[,c("Average Commute Time, Hours")], zcol = "Average Commute Time, Hours", map.types = c("OpenStreetMap"), legend = TRUE, layer.name = 'Average Commute</br>Time, Hours')
# 
# mapshot(map,url="map-stockton-commute-avg.html")

knitr::include_url("http://web.stanford.edu/~douyang1/map-stockton-commute-avg.html")
```

$~$

Similar to the county-level analysis, we calculated the change in VMT/job over time, which might give more important relative insight given the many assumptions that go into the specific quantity of VMTs in any given year.

```{r stockton-commute-vmt-table}
load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/stockton_commute_vmt_tractmode.Rdata")

stockton_commute_vmt_tractmode_table <-
  stockton_commute_vmt_tractmode %>% 
  transmute(
    Year = Year,
    `Commute One-Way VMT` = prettyNum(round(vmt,-3), big.mark=","),
    `Workers` = prettyNum(round(jobs,-3), big.mark=","),
    `One-Way VMT/Workers` = round(vmt/jobs_car,1),
    `% Car-Dependent Workers who Carpool` = paste0(round(jobs_carpool/jobs_car*100,1),"%")
  )

kable(
  stockton_commute_vmt_tractmode_table,
  booktabs = TRUE,
  caption = 'Stockton commute one-way VMT from 2011-2017. Data from LODES and ACS 1-yr.'
) %>%
  kable_styling() %>%
  scroll_box(width = "100%")
```

$~$

The average one-way commute trip for the Stockton worker appears to have increased by 13% over the last 6 years. This could be explained by existing residents changing to jobs that are further and further away from home, where better employment opportunities can be found, and by new residents moving to Stockton to find affordable housing but retaining their faraway jobs.

The following figure compares Stockton and SJC VMT/job. The trends are similar, though Stockton residents commute less distance than SJC residents overall.

```{r stockton-commute-vmt-tractmode, fig.cap="One-way commute miles per car-dependent worker in Stockton vs. SJC, 2011 to 2017. Data from LODES."}
# stockton_commute_vmt_bgmode <- NULL
# 
# for(year in 2011:2017){
#     print(year)
# 
#     load(paste0("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/stockton_lodes_",year,".Rdata"))
# 
#     load(paste0("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/acs5_vars_",year,".Rdata"))
# 
#     travel_time_mode <-
#       getCensus(
#         name = "acs/acs5",
#         vintage = ifelse(
#           year < 2013,
#           2013,
#           year
#         ),
#         region = "block group:*",
#         regionin = "state:06+county:077",
#         vars = "group(B08134)"
#       ) %>%
#       mutate(bg = paste0(state,county,tract,block_group)) %>%
#       select_if(!names(.) %in% c("GEO_ID","state","county","tract","block_group","NAME")) %>%
#       dplyr::select(-c(contains("EA"),contains("MA"),contains("M"))) %>%
#       gather(
#         key = "variable",
#         value = "estimate",
#         -bg
#       ) %>%
#       mutate(
#         label = acs_vars$label[match(variable,acs_vars$name)],
#         time = # This extracts only the time information from our label.
#           substr(
#             label,
#             lapply(
#               label,
#               function(x){
#                 ifelse(
#                   length(unlist(gregexpr('!!',x)))<3,
#                   NA,
#                   max(unlist(gregexpr('!!',x)))+2
#                 )
#               }
#             ),
#             nchar(label)
#           ),
#         mode = # This extracts only the mode information from our label. It doesn't fully deal with double-counting, so some are further removed later on in a filter.
#           substr(
#             label,
#             lapply(
#               label,
#               function(x){
#                 ifelse(
#                   length(unlist(gregexpr('!!',x)))<3,
#                   NA,
#                   unlist(gregexpr('!!',x))[length(unlist(gregexpr('!!',x)))-1]+2
#                 )
#               }
#             ),
#             lapply(
#               label,
#               function(x){
#                 max(unlist(gregexpr('!!',x)))-1
#               }
#             )
#           )
#       ) %>%
#       filter(!is.na(time)) %>% # This removes the grand total rows that are usually at the top of the ACS data.
#       filter(!mode %in% c("Car, truck, or van","Car truck or van","Carpooled","Public transportation (excluding taxicab)")) %>% # This removes double-counted subtotals.
#       dplyr::select(-variable,-label)
# 
#     travel_time_mode_summary <-
#       travel_time_mode %>%
#       group_by(bg,time) %>%
#       summarize(
#         jobs = sum(estimate),
#         jobs_drovealone = sum(estimate[which(mode == "Drove alone")]),
#         jobs_carpool2 = sum(estimate[which(mode == "In 2-person carpool")]),
#         jobs_carpool3 = sum(estimate[which(mode == "In 3-or-more-person carpool")]),
#       ) %>%
#       mutate(
#         vehicles_drovealone = jobs_drovealone,
#         vehicles_carpool2 = jobs_carpool2/2,
#         vehicles_carpool3 = jobs_carpool3/3,
#         jobs_car = jobs_drovealone+jobs_carpool2+jobs_carpool3,
#         jobs_carpool = jobs_carpool2+jobs_carpool3,
#         vehicles = vehicles_drovealone,vehicles_carpool2,vehicles_carpool3,
#         perc_jobs_car = jobs_car/jobs,
#         perc_jobs_carpool = jobs_carpool/jobs,
#         perc_vehicle = vehicles/jobs
#       )
# 
#   stockton_lodes_h_mode <-
#     stockton_lodes_h_filter %>%
#     transmute(
#       residence = h_bg,
#       jobs = S000,
#       duration = duration,
#       person_miles = S000*as.numeric(distance)/1.60934,
#       person_hours = S000*as.numeric(duration)/60
#     ) %>%
#     mutate(
#       tier =
#         case_when(
#           duration < 10 ~ "Less than 10 minutes",
#           duration < 15 ~ "10 to 14 minutes",
#           duration < 20 ~ "15 to 19 minutes",
#           duration < 25 ~ "20 to 24 minutes",
#           duration < 30 ~ "25 to 29 minutes",
#           duration < 35 ~ "30 to 34 minutes",
#           duration < 45 ~ "35 to 44 minutes",
#           duration < 60 ~ "45 to 59 minutes",
#           TRUE ~ "60 or more minutes"
#         )
#     ) %>%
#     left_join(
#       travel_time_mode_summary %>%
#         dplyr::select(
#           bg,
#           time,
#           perc_jobs_car,
#           perc_jobs_carpool,
#           perc_vehicle
#         ),
#       by = c("residence" = "bg", "tier" = "time")
#     ) %>%
#     mutate(
#       jobs_car = jobs*perc_jobs_car,
#       jobs_carpool = jobs*perc_jobs_carpool,
#       vehicles = jobs*perc_vehicle,
#       vmt = person_miles*perc_vehicle
#     )
# 
#     stockton_commute_vmt_bgmode <-
#       rbind(stockton_commute_vmt_bgmode,
#         data.frame(
#           Year = year,
#           person_miles = sum(stockton_lodes_h_mode$person_miles, na.rm=T),
#           jobs = sum(stockton_lodes_h_mode$jobs, na.rm=T),
#           jobs_car = sum(stockton_lodes_h_mode$jobs_car, na.rm=T),
#           jobs_carpool = sum(stockton_lodes_h_mode$jobs_carpool, na.rm=T),
#           vehicles = sum(stockton_lodes_h_mode$vehicles, na.rm = T),
#           vmt = sum(stockton_lodes_h_mode$vmt, na.rm=T)
#         )
#       )
# 
#     save(stockton_commute_vmt_bgmode,file = "C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/stockton_commute_vmt_bgmode.Rdata")
# }
#
# stockton_commute_vmt_tractmode <- NULL
# 
# for(year in 2011:2017){
#     print(year)
# 
#     load(paste0("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/stockton_lodes_",year,"_tract.Rdata"))
# 
#     load(paste0("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/acs5_vars_",year,".Rdata"))
# 
#     travel_time_mode <-
#       getCensus(
#         name = "acs/acs5",
#         vintage = year,
#         region = "tract:*",
#         regionin = "state:06+county:077",
#         vars = "group(B08134)"
#       ) %>%
#       mutate(tract = paste0(state,county,tract)) %>%
#       select_if(!names(.) %in% c("GEO_ID","state","county","NAME")) %>%
#       dplyr::select(-c(contains("EA"),contains("MA"),contains("M"))) %>%
#       gather(
#         key = "variable",
#         value = "estimate",
#         -tract
#       ) %>%
#       mutate(
#         label = acs_vars$label[match(variable,acs_vars$name)],
#         time = # This extracts only the time information from our label.
#           substr(
#             label,
#             lapply(
#               label,
#               function(x){
#                 ifelse(
#                   length(unlist(gregexpr('!!',x)))<3,
#                   NA,
#                   max(unlist(gregexpr('!!',x)))+2
#                 )
#               }
#             ),
#             nchar(label)
#           ),
#         mode = # This extracts only the mode information from our label. It doesn't fully deal with double-counting, so some are further removed later on in a filter.
#           substr(
#             label,
#             lapply(
#               label,
#               function(x){
#                 ifelse(
#                   length(unlist(gregexpr('!!',x)))<3,
#                   NA,
#                   unlist(gregexpr('!!',x))[length(unlist(gregexpr('!!',x)))-1]+2
#                 )
#               }
#             ),
#             lapply(
#               label,
#               function(x){
#                 max(unlist(gregexpr('!!',x)))-1
#               }
#             )
#           )
#       ) %>%
#       filter(!is.na(time)) %>% # This removes the grand total rows that are usually at the top of the ACS data.
#       filter(!mode %in% c("Car, truck, or van","Car truck or van","Carpooled","Public transportation (excluding taxicab)")) %>% # This removes double-counted subtotals.
#       dplyr::select(-variable,-label)
# 
#     travel_time_mode_summary <-
#       travel_time_mode %>%
#       group_by(tract,time) %>%
#       summarize(
#         jobs = sum(estimate),
#         jobs_drovealone = sum(estimate[which(mode == "Drove alone")]),
#         jobs_carpool2 = sum(estimate[which(mode == "In 2-person carpool")]),
#         jobs_carpool3 = sum(estimate[which(mode == "In 3-or-more-person carpool")]),
#       ) %>%
#       mutate(
#         vehicles_drovealone = jobs_drovealone,
#         vehicles_carpool2 = jobs_carpool2/2,
#         vehicles_carpool3 = jobs_carpool3/3,
#         jobs_car = jobs_drovealone+jobs_carpool2+jobs_carpool3,
#         jobs_carpool = jobs_carpool2+jobs_carpool3,
#         vehicles = vehicles_drovealone,vehicles_carpool2,vehicles_carpool3,
#         perc_jobs_car = jobs_car/jobs,
#         perc_jobs_carpool = jobs_carpool/jobs,
#         perc_vehicle = vehicles/jobs
#       )
# 
#   stockton_lodes_h_mode <-
#     stockton_lodes_h_filter %>%
#     transmute(
#       residence = h_tract,
#       jobs = S000,
#       duration = duration,
#       person_miles = S000*as.numeric(distance)/1.60934,
#       person_hours = S000*as.numeric(duration)/60
#     ) %>%
#     mutate(
#       tier =
#         case_when(
#           duration < 10 ~ "Less than 10 minutes",
#           duration < 15 ~ "10 to 14 minutes",
#           duration < 20 ~ "15 to 19 minutes",
#           duration < 25 ~ "20 to 24 minutes",
#           duration < 30 ~ "25 to 29 minutes",
#           duration < 35 ~ "30 to 34 minutes",
#           duration < 45 ~ "35 to 44 minutes",
#           duration < 60 ~ "45 to 59 minutes",
#           TRUE ~ "60 or more minutes"
#         )
#     ) %>%
#     left_join(
#       travel_time_mode_summary %>%
#         dplyr::select(
#           tract,
#           time,
#           perc_jobs_car,
#           perc_jobs_carpool,
#           perc_vehicle
#         ),
#       by = c("residence" = "tract", "tier" = "time")
#     ) %>%
#     mutate(
#       jobs_car = jobs*perc_jobs_car,
#       jobs_carpool = jobs*perc_jobs_carpool,
#       vehicles = jobs*perc_vehicle,
#       vmt = person_miles*perc_vehicle
#     )
# 
#     stockton_commute_vmt_tractmode <-
#       rbind(stockton_commute_vmt_tractmode,
#         data.frame(
#           Year = year,
#           person_miles = sum(stockton_lodes_h_mode$person_miles, na.rm=T),
#           jobs = sum(stockton_lodes_h_mode$jobs, na.rm=T),
#           jobs_car = sum(stockton_lodes_h_mode$jobs_car, na.rm=T),
#           jobs_carpool = sum(stockton_lodes_h_mode$jobs_carpool, na.rm=T),
#           vehicles = sum(stockton_lodes_h_mode$vehicles, na.rm = T),
#           vmt = sum(stockton_lodes_h_mode$vmt, na.rm=T)
#         )
#       )
# 
#     save(stockton_commute_vmt_tractmode,file = "C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/stockton_commute_vmt_tractmode.Rdata")
# }
# load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/stockton_commute_vmt_tractmode.Rdata")
# 
# stockton_commute_vmt_tractmode %>%
#   ggplot(
#     aes(
#       x = Year,
#       y = vmt/jobs
#     )
#   ) +
#   geom_line()
# 
# stockton_commute_vmt_countymode <- NULL
# 
# for(year in 2011:2017){
# 
#   print(year)
# 
#   load(paste0("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/stockton_lodes_",year,"_tract.Rdata"))
# 
#   load(paste0("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/acs1_vars_",year,".Rdata"))
# 
#   travel_time_mode <-
#     getCensus(
#       name = "acs/acs1",
#       vintage = year,
#       region = "county:077",
#       regionin = "state:06",
#       vars = "group(B08134)"
#     ) %>%
#     select_if(!names(.) %in% c("GEO_ID","state","NAME")) %>%
#     dplyr::select(-c(contains("EA"),contains("MA"),contains("M"))) %>%
#     gather(
#       key = "variable",
#       value = "estimate",
#       -county
#     ) %>%
#     mutate(
#       label = acs_vars$label[match(variable,acs_vars$name)],
#       time = # This extracts only the time information from our label.
#         substr(
#           label,
#           lapply(
#             label,
#             function(x){
#               ifelse(
#                 length(unlist(gregexpr('!!',x)))<3,
#                 NA,
#                 max(unlist(gregexpr('!!',x)))+2
#               )
#             }
#           ),
#           nchar(label)
#         ),
#       mode = # This extracts only the mode information from our label. It doesn't fully deal with double-counting, so some are further removed later on in a filter.
#         substr(
#           label,
#           lapply(
#             label,
#             function(x){
#               ifelse(
#                 length(unlist(gregexpr('!!',x)))<3,
#                 NA,
#                 unlist(gregexpr('!!',x))[length(unlist(gregexpr('!!',x)))-1]+2
#               )
#             }
#           ),
#           lapply(
#             label,
#             function(x){
#               max(unlist(gregexpr('!!',x)))-1
#             }
#           )
#         )
#     ) %>%
#     filter(!is.na(time)) %>% # This removes the grand total rows that are usually at the top of the ACS data.
#     filter(!mode %in% c("Car, truck, or van","Car truck or van","Carpooled","Public transportation (excluding taxicab)")) %>% # This removes double-counted subtotals.
#     dplyr::select(-variable,-label)
# 
#     travel_time_mode_summary <-
#       travel_time_mode %>%
#       group_by(time) %>%
#       summarize(
#         jobs = sum(estimate),
#         jobs_drovealone = sum(estimate[which(mode == "Drove alone")]),
#         jobs_carpool2 = sum(estimate[which(mode == "In 2-person carpool")]),
#         jobs_carpool3 = sum(estimate[which(mode == "In 3-or-more-person carpool")]),
#       ) %>%
#       mutate(
#         vehicles_drovealone = jobs_drovealone,
#         vehicles_carpool2 = jobs_carpool2/2,
#         vehicles_carpool3 = jobs_carpool3/3,
#         jobs_car = jobs_drovealone+jobs_carpool2+jobs_carpool3,
#         jobs_carpool = jobs_carpool2+jobs_carpool3,
#         vehicles = vehicles_drovealone,vehicles_carpool2,vehicles_carpool3,
#         perc_jobs_car = jobs_car/jobs,
#         perc_jobs_carpool = jobs_carpool/jobs,
#         perc_vehicle = vehicles/jobs
#       )
# 
#   stockton_lodes_h_mode <-
#     stockton_lodes_h_filter %>%
#     transmute(
#       jobs = S000,
#       duration = duration,
#       person_miles = S000*as.numeric(distance)/1.60934,
#       person_hours = S000*as.numeric(duration)/60
#     ) %>%
#     mutate(
#       tier =
#         case_when(
#           duration < 10 ~ "Less than 10 minutes",
#           duration < 15 ~ "10 to 14 minutes",
#           duration < 20 ~ "15 to 19 minutes",
#           duration < 25 ~ "20 to 24 minutes",
#           duration < 30 ~ "25 to 29 minutes",
#           duration < 35 ~ "30 to 34 minutes",
#           duration < 45 ~ "35 to 44 minutes",
#           duration < 60 ~ "45 to 59 minutes",
#           TRUE ~ "60 or more minutes"
#         )
#     ) %>%
#     left_join(
#       travel_time_mode_summary %>%
#         dplyr::select(
#           time,
#           perc_jobs_car,
#           perc_jobs_carpool,
#           perc_vehicle
#         ),
#       by = c("tier" = "time")
#     ) %>%
#     mutate(
#       jobs_car = jobs*perc_jobs_car,
#       jobs_carpool = jobs*perc_jobs_carpool,
#       vehicles = jobs*perc_vehicle,
#       vmt = person_miles*perc_vehicle
#     )
# 
#     stockton_commute_vmt_countymode <-
#       rbind(stockton_commute_vmt_countymode,
#         data.frame(
#           Year = year,
#           person_miles = sum(stockton_lodes_h_mode$person_miles, na.rm=T),
#           jobs = sum(stockton_lodes_h_mode$jobs, na.rm=T),
#           jobs_car = sum(stockton_lodes_h_mode$jobs_car, na.rm=T),
#           jobs_carpool = sum(stockton_lodes_h_mode$jobs_carpool, na.rm=T),
#           vehicles = sum(stockton_lodes_h_mode$vehicles, na.rm = T),
#           vmt = sum(stockton_lodes_h_mode$vmt, na.rm=T)
#         )
#       )
# }
# 
# save(stockton_commute_vmt_countymode, file = "C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/stockton_commute_vmt_countymode.Rdata")
# load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/stockton_commute_vmt_countymode.Rdata")
# 
# stockton_commute_vmt_countymode %>%
#   ggplot(
#     aes(
#       x = Year,
#       y = vmt/jobs
#     )
#   ) +
#   geom_line()
# 
# load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/stockton_commute_vmt_bgmode.Rdata")
# 
# load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/stockton_commute_vmt_tractmode.Rdata")
# 
# load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/stockton_commute_vmt_countymode.Rdata")
# 
# stockton_commute_vmt_compare <-
#   rbind(
#     stockton_commute_vmt_bgmode %>% 
#       mutate(mode = "block group"),
#     stockton_commute_vmt_tractmode %>% 
#       mutate(mode = "tract"),
#     stockton_commute_vmt_countymode %>% 
#       mutate(mode = "county")
#   )
# 
# stockton_commute_vmt_compare %>%
#   ggplot(
#     aes(
#       x = Year,
#       y = vmt/jobs,
#       linetype = mode
#     )
#   ) +
#   geom_line()

county_commute_vmt_tractmode %>% 
  filter(County == "077") %>% 
  ggplot(
    aes(
      x = Year,
      y = vmt/jobs_car,
      linetype = "SJC"
    )
  ) +
  geom_line() + 
  geom_line(
    data = stockton_commute_vmt_tractmode,
    aes(
      x = Year,
      y = vmt/jobs_car,
      linetype = "Stockton"
    )
  ) +
  labs(y = "One-way commute miles\nper car-dependent worker", linetype = "Group")
```

$~$

The following figure compares the percent of car-dependent workers who carpool in Stockton and SJC. Stockton workers overall are more likely to carpool than SJC workers overall, but the trends are again similar between Stockton and SJC, with a decline in carpooling in the last two years of data.

```{r stockton-county-commute-vmt-compare, fig.cap="Percent of car-dependent commuters traveling by carpool, Stockton vs. SJC, 2011 to 2017. Data from LODES and ACS."}
load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/stockton_commute_vmt_tractmode.Rdata")

load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/county_commute_vmt_tractmode.Rdata")

stockton_county_commute_vmt_compare <-
  rbind(
    county_commute_vmt_tractmode %>% 
      filter(County == "077") %>% 
      dplyr::select(-County) %>% 
      mutate(type = "SJC"), 
    stockton_commute_vmt_tractmode %>% 
      mutate(type = "Stockton")
  )

stockton_county_commute_vmt_compare %>%
  ggplot(
    aes(
      x = Year,
      y = jobs_carpool/jobs_car*100,
      linetype = type
    )
  ) +
  geom_line() +
  labs(y = "% Car-dependent workers who carpool", linetype = "Group")
```

$~$

## Non-Commute Vehicle Miles Traveled

While commute-related driving is the primary way cities currently evaluate their GHG transportation footprint, residents also do a significant amount of non-commute-related driving, which also has its own GHG footprint. We are developing a methodology to produce an order-of-magnitude estimation of VMTs associated with Stockton residents traveling to places of economic activity, such as grocery stores and restaurants. 

The full analytical methodology is still being refined and deserves its own separate report to detail, but generally follows these steps:

We used 2018 [Safegraph](https://marketplace.arcgis.com/listing.html?id=3425348e4bee4059af2b353e52df43c2) data to collect trip visit data to amenities in and around Stockton by Stockton residents. Safegraph reports total visits from its panel of monitored devices each month, which can be weighted to represent the full population. It indicates any census block group which is the origin of more than 5 monitored devices in a given month, which can be used to estimate the routes and VMTs for Stockton visitors, similar to how origin-destination data is used in the commute VMT analysis. We also applied revision factors to the analysis to account for: (1) converting Safegraph
s reported median travel distance to mean; (2) linked trips, such as dropping by the grocery store and library on the same trip, which reduce the total VMTs; (3) carpooling; and other factors.

The map below shows the location of all points of interest in California that had recorded visitors from Stockton in 2018. Each point is colored and sized based on the VMTs we calculated associated with Stockton visitors; purple/small is low, yellow/large is high.

```{r amenity-vmt-location, fig.cap="Location of points of interest with Stockton visitors in 2018. Source: Safegraph."}
load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/results.Rdata")

amenity_VMT <- location_VMT_new_join_agg
colnames(amenity_VMT)[2] <- "location name"
colnames(amenity_VMT)[3] <- "total VMT"
colnames(amenity_VMT)[4] <- "business type"
colnames(amenity_VMT)[7] <- "street address"
colnames(amenity_VMT)[10] <- "zip code"

amenity_VMT$full_address <- NULL
amenity_VMT$sub_category <- NULL
amenity_VMT$naics_code <- NULL

amenity_VMT <- amenity_VMT[,c("total VMT", "location name", "business type", "street address", "city", "state", "zip code", "geometry")]

# map <- mapview(amenity_VMT, zcol = "total VMT", legend = TRUE, cex= "total VMT", alpha = 0)
# 
# mapshot(map, url = "map-amenity-vmt-location.html")

knitr::include_url("http://web.stanford.edu/~douyang1/map-amenity-vmt-location.html")
```

$~$

The following plot shows the distribution of VMTs by amenity type (out of hundreds available). The largest category by far is the second tall bar, "Restaurants and Other Eating Places", followed by "Traveler Accommodations" and "Gas Stations".

```{r vmt-amenity-location-chart, fig.cap = "Non-commute VMT by type of amenity. Source: Safegraph 2018."}
business_listing <- unique(location_VMT_new_join_agg$top_category)
bus_list_df <- data.frame(matrix(data = 0, nrow = length(business_listing), ncol = 3))
colnames(bus_list_df) <- c("business type", "total VMT", "% VMT")

count <- 0

for (business_iter in business_listing){
  
  count <- count + 1
  bus_iter_df <- location_VMT_new_join_agg[location_VMT_new_join_agg$top_category == business_iter, ]

  bus_list_df[count, "business type"] <- business_iter
  bus_list_df[count, "total VMT"] <- sum(bus_iter_df$VMT_total, na.rm = TRUE)
  
}

bus_list_df[, "% VMT"] <- bus_list_df[, "total VMT"] / sum(bus_list_df[, "total VMT"]) * 100

bus_list_df_ordered <- bus_list_df[order(-bus_list_df$`total VMT`),]
colnames(bus_list_df_ordered) <- c("business_type", "total_VMT", "p_VMT")

bus_list_df_ordered_other_label <- "Other"
bus_list_df_ordered_other_VMT <- sum(as.numeric(bus_list_df_ordered[21:nrow(bus_list_df_ordered),'total_VMT']))
bus_list_df_ordered_other_perc <- sum(as.numeric(bus_list_df_ordered[21:nrow(bus_list_df_ordered),'p_VMT']))
bus_list_df_ordered_other <- cbind(bus_list_df_ordered_other_label, bus_list_df_ordered_other_VMT, bus_list_df_ordered_other_perc)
colnames(bus_list_df_ordered_other) <- c("business_type", "total_VMT", "p_VMT")

bus_list_df_ordered_new <- rbind(bus_list_df_ordered[1:20,], bus_list_df_ordered_other)
colnames(bus_list_df_ordered_new) <- c("business_type", "total_VMT", "p_VMT")
bus_list_df_ordered_new$total_VMT <- as.numeric(bus_list_df_ordered_new$total_VMT)

ggplot(
  bus_list_df_ordered_new,
  aes(
    x = business_type,
    y = total_VMT
  )
) + 
  geom_bar(stat = 'identity', aes(fill = total_VMT), position = "dodge") +
  labs(x = "Amenity Type", y = "Total VMT", title = "Amenity Type VMT Count") +
  theme(axis.text.x = element_text(angle = 35, hjust = 1)) +
  theme(legend.position = "none")
```

$~$

The following table shows the top 50 individual points of interest from the same dataset. 

```{r amenity-vmt-location-table}
location_VMT_CA_table <-
  location_VMT_new_join_agg %>%
  transmute(
    'Location Name' = location_name,
    'Total Stockton VMT' = VMT_total %>% as.numeric(),
    'Amenity Type' = top_category,
    'Street Address' = street_address,
    'City' = city
  ) %>% 
  arrange(desc(`Total Stockton VMT`))

location_VMT_CA_table$geometry <- NULL
location_VMT_CA_table$`Total Stockton VMT` <- prettyNum(round(location_VMT_CA_table$`Total Stockton VMT`,-4),big.mark=",")

kable(location_VMT_CA_table[1:50,], booktabs = TRUE, caption = "Top 50 points of interest for Stockton residents in 2018. Source: Safegraph.") %>% kable_styling() %>% scroll_box(width = "100%", height = "500px")
```

$~$

The following map shows the same data aggregated back to Stockton blockgroups, and shown as VMT per capita. For most of Stockton there is no clear pattern, but some there are notable block groups at the periphery that have high VMT per capita. Transit and ride-sharing strategies, or land use policy and development that brings needed amenities closer to where people live, could target VMT reduction where it is needed the most.

```{r amenity-vmt-map, fig.cap="Non-commute VMT per capita by block group. Source: Safegraph 2018."}
# map <- mapview(bg_VMT, zcol = c("per_capita"), legend = TRUE, layer.name = "Non-commute<br>VMTper capita")
# 
# mapshot(map, url = "map-amenity-vmt-bg.html")

knitr::include_url("http://web.stanford.edu/~douyang1/map-amenity-vmt-bg.html")
```

$~$

Overall, the VMTs associated with non-commute travel in 2018 sum up to about 1.2 billion, compared to an estimated 2.2 billion for commute travel, a roughly 1:2 ratio. This preliminary work suggests that strategies to reduce non-commute travel, which may be much more actionable for local cities, may have impacts up to half the size of commuter-oriented strategies, and should not be ignored.

## Vehicle Emissions

The previous two sections estimated the total VMTs due to commuting for Stockton workers from 2011 to 2017, and non-commuting travel for 2018, which can be used to forecast VMTs through 2040. While VMTs themselves are an important indicator of quality of life and economic vitality, from a GHG perspective we need to convert vehicle miles to emissions.

We followed the standard method for calculating vehicle emissions in California using the California Air Resources Board (CARB) [Emission Factors (EMFAC) model](https://ww2.arb.ca.gov/our-work/programs/mobile-source-emissions-inventory/msei-modeling-tools). Using the EMFAC2017 model, we downloaded emissions rates data for 2013-2018, 2020, 2025, 2030, and 2040 in the San Joaquin Valley air basin. The data includes CARB's model estimates for daily vehicles across passenger cars and trucks of different fuel types, along with emissions per mile for CO2 and other pollutants. A summary of the EMFAC data is provided below.

```{r emfac}
emfac <- read_csv("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/emfac.csv")

emfac_summary <-
  emfac %>% 
  dplyr::select(
    Year = `Calendar Year`,
    `Vehicle Category`,
    `Fuel Type` = Fuel,
    Population,
    CO2_RUNEX,
    CO2_STREX
  ) %>% 
  group_by(Year) %>% 
  mutate(
    `Percent Vehicles` = round(Population/sum(Population)*100,2) %>% as.numeric(),
    `gCO2 Running Exhaust` = CO2_RUNEX %>% as.integer(),
    `gCO2 Start Exhaust` = CO2_STREX %>% as.integer()
  ) %>% 
  ungroup() %>% 
  dplyr::select(-Population, -CO2_RUNEX, -CO2_STREX) %>% 
  mutate(
    `Fuel Type` = 
      case_when(
        `Fuel Type` == "GAS" ~ "Gasoline",
        `Fuel Type` == "DSL" ~ "Diesel",
        TRUE ~ "Electric"
      ),
    `Vehicle Category` = 
      case_when(
        `Vehicle Category` == "LDA" ~ "Passenger Car",
        TRUE ~ "Light Duty Truck"
      )
  ) %>% 
  group_by(Year, `Vehicle Category`, `Fuel Type`) %>% 
  summarize_all(sum)
  
kable(
  emfac_summary,
  booktabs = TRUE,
  caption = 'EMFAC2017 emission rates for vehicles in San Joaquin Valley, 2013 through 2040.'
) %>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "500px")
```

$~$

Emissions from N2O and CH4, along with emissions from other types of vehicles, were left out of this analysis. 

We applied the CO2 emission rates above to our 2017 commute VMTs to estimate the total and average GHG emissions for Stockton workers commuting to each of the top 15 counties (filtering out counties further than 3 hours away). We made the following assumptions:

- Assuming that the distribution vehicle types for Stockton commuters matches the EMFAC breakdown, the average GHG emissions is about 440 g/mile running exhaust, and 93 g/trip start exhaust.
- For daily VMT, each vehicle was assumed to take 2 one-way trips.
- To convert daily VMT to annual VMT, the same annualization factor was used as ICLEI: 369.39. The factor appears to account for both expected reductions in VMT because of sick days, as well as expected increases in VMT because of chained trips.

The following table is sorted by total annual GHG from transportation.

```{r ghg}
load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/stockton_lodes_2017.Rdata")

stockton_lodes_h_counties_ghg <- 
  stockton_lodes_h_mode %>%
  st_set_geometry(NULL) %>% 
  mutate(
    Workplace = ifelse(
      workplace %in% stockton_bgs_full$GEOID,
      "75000",
      substr(workplace,3,5)
    )
  ) %>%
  group_by(Workplace) %>%
  summarise_at(
    vars(jobs,person_miles,person_hours,vehicles,vmt),
    sum, na.rm=T
  ) %>% 
  mutate(
    perc_jobs = jobs/sum(jobs),
    annual_vmt = vmt*2*369.39,
    annual_ghg = annual_vmt*439.462*1.1023e-6 + 2*369.39*vehicles*92.582*1.1023e-6,
    perc_ghg = annual_ghg/sum(annual_ghg),
    avg_ghg = annual_ghg/jobs
  ) %>% 
  left_join(ca_counties_and_stockton %>% 
  dplyr::select(COUNTYFP, NAME), by = c("Workplace" = "COUNTYFP")) %>% 
  dplyr::select(-Workplace) %>%
  dplyr::select(NAME,everything()) %>% 
  st_as_sf() %>% 
  arrange(desc(annual_ghg))
  
stockton_lodes_h_counties_ghg_table <- 
  stockton_lodes_h_counties_ghg[1:15,] %>%
  transmute(
    `Workplace (where Stockton residents work)` = NAME,
    `Jobs (held by Stockton residents)` = prettyNum(round(jobs,-2),big.mark=","),
    `Percent Jobs` = paste0(round(perc_jobs*100),"%"),
    `VMT (millions)` = prettyNum(round(annual_vmt/1000000),big.mark=","),
    `Total Annual GHG (tCO2e)` = prettyNum(round(annual_ghg,-3),big.mark=","),
    `Percent Annual GHG` = paste0(round(perc_ghg*100),"%"),
    `Average Annual GHG/worker (tCO2e)` = round(avg_ghg,1)
  )

kable(
  stockton_lodes_h_counties_ghg_table %>% st_set_geometry(NULL),
  booktabs = TRUE,
  caption = 'Top 15 workplaces where Stockton residents work, GHG emissions from transportation. Includes Stockton as a workplace destination separate from the rest of SJC. All other listed workplaces are counties. Los Angeles, San Bernardino, Orange, and San Diego Counties were removed. Data from LODES, 2017.'
) %>%
  kable_styling() %>%
  scroll_box(width = "100%")
```

$~$

According to the table above, 59% percent of Stockton residents work in San Joaquin County and collectively contribute 19% of all commute GHGs. The next 14 counties comprise another 39% of Stockton residents, but they collectively contribute 73% of all commute GHGs. This significant difference comes down to difference in average commute distance to each county, which is directly related to average GHG emissions per worker. In a later section, we will explore opportunities to stimulate local job creation so that some of these long-distance commutes can be converted into local commutes, reducing both the toll on the environment and the tolls on health and well-being for Stockton residents.

```{r ghg-map-2, fig.cap="Top 15 Counties where Stockton residents work - annual GHG emissions from driving. Data from LODES, 2017."}
# map = mapview(stockton_lodes_h_counties_ghg[1:15,c("annual_ghg")], zcol = "annual_ghg", map.types = c("OpenStreetMap"), legend = TRUE, layer.name = 'Total Annual</br>GHG (tCO2e)')
# 
# mapshot(map,url="map-ghg-map-2.html")

knitr::include_url("http://web.stanford.edu/~douyang1/map-ghg-map-2.html")
```

$~$

To conclude this section, we plotted changes in emissions per mile (just running exhaust) and the percentage of electric vehicles in San Joaquin County from 2013-2040. These projections will contribute to modeling business-as-usual GHG emissions.

```{r vehicle-emissions-trend, fig.cap="Average GHG emissions per mile for vehicles in San Joaquin Valley Air Basin, 2013-2040. Source: EMFAC2017."}
vehicle_emissions_trend <-
  emfac_summary %>% 
    mutate(
      product = `Percent Vehicles`/100*`gCO2 Running Exhaust`,
      product2 = `Percent Vehicles`/100*`gCO2 Start Exhaust`
    ) %>% 
    group_by(Year) %>% 
    summarize(
      `gCO2/mile` = sum(product),
      `gCO2/trip` = sum(product2)
    )

vehicle_emissions_trend %>% 
  ggplot(
    aes(
      x = Year,
      y = `gCO2/mile`
    )
  )+
  geom_line(size = 2, colour = "orange") + 
  labs(title = "San Joaquin Valley Air Basin", y = "gCO2/mile running exhaust")
```

$~$

```{r vehicle-electric-trend, fig.cap="Percentage of electric vehicles in San Joaquin Valley Air Basin, 2013-2040. Source: EMFAC2017."}
vehicle_electric_trend <-
  emfac_summary %>% 
  mutate(
    `Fuel Type` = ifelse(`Fuel Type` == "Electric", "Electric", "Other")
  ) %>% 
  group_by(Year, `Fuel Type`) %>% 
  summarize(count = sum(`Percent Vehicles`)) %>% 
  filter(`Fuel Type` == "Electric")

vehicle_electric_trend %>% 
  ggplot(
    aes(
      x = Year,
      y = `count`
    )
  )+
  geom_line(size = 2, colour = "forest green") + 
  labs(title = "San Joaquin Valley Air Basin", y = "Percentage electric vehicles on road")
```

$~$

The projected busines-as-usual increase in electric vehicles on the road is a driver of the reduction in emissions/mile (along with fuel efficiency improvements and other factors). Later, one of our strategies will model the GHG reductions associated with even more progressive EV adoption beyond 5% by 2040.

## Energy

After transportation, buildings are the next largest source of emissions based on the ICLEI GHG inventories. Our best source of energy data is from [PG&E's Energy Data Request Program](https://pge-energydatarequest.com/public_datasets), which provides total customers, total kWh of electricity, and total therms of gas usage per zipcode per month dating back to 2013. We used the following zip code tabulation areas (ZCTAs), close proxies of customer zip codes, to represent Stockton.

```{r zcta, fig.cap = "Zip code tabulation areas used to represent Stockton population estimates. The red outline is the official city boundary."}
zcta <- zctas(starts_with="95") %>% 
  mutate(ZCTA5CE10 = as.numeric(ZCTA5CE10))
# zips_stockton <- st_read("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/ZipCodes/ZipCodes.shp") %>% st_transform(st_crs(zcta)) #this was downloaded from Stockton GIS site to do a quick visual check of the difference between ZCTA and zip code. We determined they were pretty much the same.

stockton_boundary_influence <- st_read("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/SpheresOfInfluence/SpheresOfInfluence.shp", quiet = TRUE) %>% 
  filter(SPHERE == "STOCKTON") %>% 
  st_transform(st_crs(zcta)) #stockton boundary is legit but really spotty, so i prefer using sphere of influence from the County GIS page.

#2 of the 3 shapes are tiny little triangles to get rid of.
stockton_boundary_influence <- stockton_boundary_influence[1,] 

zcta_stockton <- zcta[stockton_boundary_influence,] %>% 
  filter(!ZCTA5CE10 %in% c("95242","95240","95336","95330")) %>% 
  dplyr::select(ZCTA5CE10) %>% 
  rename(ZIPCODE = ZCTA5CE10) %>% 
  mutate(ZIPCODE = as.numeric(ZIPCODE))
  #these are some extraneous zip codes that just barely touch the sphere of influence that i manually decided to remove.
# zcta_stockton <- zcta[which(zcta$ZCTA5CE10 %in% st_centroid(zcta)[stockton_boundary_influence,]$ZCTA5CE10),] #this would be the go-to script to do a location by centroid within, but it's not as useful in this specific case.

# map = mapview(zcta_stockton$geometry) + mapview(stockton_boundary$geometry, alpha.regions = 0, color = "red", lwd = 4)
# 
# mapshot(map, url = "map-zcta.html")

knitr::include_url("http://web.stanford.edu/~douyang1/map-zcta.html")
```

$~$

PG&E's data had some minor formatting errors that were manually corrected:

- For 2014 Q3 Gas, fields "Total Therms" and "Average Therms" renamed to match the fields in all other datasets.
- For 2017 Q4 Electricity and 2017 Q4 Gas, duplicate September values were removed.

Also, because of privacy regulations, the PG&E data has many gaps in industrial and agricultural energy usage. Even though industrial energy usage may be a significant contributor to emissions, as the ICLEI report suggests, without more consistent data we decided to leave industrial energy analysis out of our report. 

After downloading and aggregating the PG&E residential and commercial data by month and year, we converted electricity and gas energy usage to tCO2e. For gas, we converted therms to tCO2e based a factor from the [U.S. Energy Information Administration](https://www.eia.gov/environment/emissions/co2_vol_mass.php) (assuming that PG&E's natural gas emits at this rate, and that it doesnt change from year to year). For electricity, we converted kWh to tCO2e for the appropriate year using the table provided by PG&E in their [2019 Corporate Responsibility Report](http://www.pgecorp.com/corp_responsibility/reports/2019/en02_climate_change.html), under the table titled "Benchmarking Greenhouse Gas Emissions for Delivered Electricity". Because the latest emissions data is 210 lbs CO2 per MWh for 2017, and SB 100 signed into law September 2018 requires state energy agencies to adopt a 100 percent clean energy by 2045 planning goal, we assume the emissions factor will decrease by 7.5 lbs CO2 per MWh each year, resulting in a value of 202.5 for 2018.

```{r summary-TCO2E-average-table}
#Note: Elec- Industrial mostly 0's, 95206 suddenly shows up with ~70 customers in 2014 Q3/Q4, 2015 Q1, 2016 M2/M3, 2018 M6/M9

pge_elec_emissions_factor <-
  data.frame(
    year = c(2013:2018,2020,2025,2030,2035,2040),
    factor = c(427,434.92,404.51,293.67,210,202.5,187.5,150,112.5,75,37.5)
  )
# 
# pge_data <-
#   2013:2018 %>% # Supply a list of years, 2013 to 2018. Recall the syntax for a list of numbers from past assignments.
#   map_dfr(function(year){ # This is another variation of map() that automatically binds rows together into a dataframe (what we used rbindlist() in the past for), assuming youre working with dataframes. Otherwise it works exactly the same way as map().
# 
#     factor <- pge_elec_emissions_factor$factor[match(year,pge_elec_emissions_factor$year)] # You will want to use match() to get the correct emissions factor from the lookup table you made in the previous chunk. Refer back to the lines where we used match() on acs_vars in the past for the correct syntax.
# 
#     1:4 %>% # Look closely at the PG&E datasets and youll see that the data is organized by quarter, and well need to refer to the quarter in the filename when we load CSVs. Supply a list of quarters here.
#       map_dfr(function(quarter){
# 
#         c("Electric","Gas") %>% # The datasets are either for Electricity or Gas. Look carefully at how these are written in the filenames, and supply a c() with both strings here.
#           map_dfr(function(type){
# 
#             filename <-
#               paste0(
#                 "F:/Data Library/PG&E/PGE_",
#                 year,
#                 "_Q",
#                 quarter,
#                 "_",
#                 type,
#                 "UsageByZip.csv"
#               )
# 
#             data <- # This will load the CSV and then manipulate
#               read_csv(filename) %>%
#               rename_all(toupper) %>% # This is part of cleaning the messy CSVs, since sometimes the field names were lowercase and sometimes they were uppercase. This makes them all uppercase so there is no issue referring to them below.
#               filter(ZIPCODE %in% zcta_stockton$ZIPCODE) %>%
#               mutate(
#                 CUSTOMERCLASS =
#                   case_when(
#                     CUSTOMERCLASS == "Elec- Residential" ~ "ER",
#                     CUSTOMERCLASS == "Gas- Residential" ~ "GR",
#                     CUSTOMERCLASS == "Elec- Commercial" ~ "EC",
#                     CUSTOMERCLASS == "Elec- Industrial" ~ "EI",
#                     CUSTOMERCLASS == "Elec- Agricultural" ~ "EA",
#                     TRUE ~ "GC"
#                   ),
#                 TOTALKBTU =
#                   ifelse(
#                     substr(CUSTOMERCLASS,1,1) == "E",
#                     TOTALKWH*3.4121416331,
#                     TOTALTHM*99.9761
#                   ),
#                 TOTALTCO2E =
#                   ifelse(
#                     substr(CUSTOMERCLASS,1,1) == "E",
#                     TOTALKWH*factor/1000*0.000453592,
#                     TOTALTHM*0.00531
#                   )
#               ) %>%
#               dplyr::select(
#                 ZIPCODE,
#                 YEAR,
#                 MONTH,
#                 CUSTOMERCLASS,
#                 TOTALKBTU,
#                 TOTALTCO2E,
#                 TOTALCUSTOMERS
#               )
# 
#           })
# 
#       })
# 
#   }) %>%
#   mutate(
#     KBTUPERCUST = TOTALKBTU/TOTALCUSTOMERS,
#     TCO2EPERCUST = TOTALTCO2E/TOTALCUSTOMERS
#   )
# 
# save(pge_data, file= "C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/stockton_pge.Rdata")
load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/LODES/stockton_pge.Rdata")

summary_TCO2E_average <- 
  pge_data %>% 
  filter(!CUSTOMERCLASS %in% c("EI","EA")) %>%
  mutate(
    ENERGYTYPE = substr(CUSTOMERCLASS,1,1)
  ) %>% 
  group_by(ZIPCODE, ENERGYTYPE, YEAR) %>%
  summarize(
    TOTALKBTU = sum(TOTALKBTU, na.rm=T),
    TOTALTCO2E = sum(TOTALTCO2E, na.rm=T), 
    TOTALCUSTOMERS = mean(TOTALCUSTOMERS, na.rm=T)
  ) %>% 
  group_by(ENERGYTYPE, YEAR) %>%
  summarize_at(
    vars(TOTALKBTU,TOTALTCO2E,TOTALCUSTOMERS),
    sum,
    na.rm=T
  ) %>% 
  ungroup()

summary_TCO2E_average_table <-
  summary_TCO2E_average %>% 
  arrange(YEAR) %>% 
  transmute(
    Year = YEAR,
    `Energy Type` = 
      ifelse(
        ENERGYTYPE == "E",
        "Electricity",
        "Gas"
      ),
    `Total Annual Customers` = prettyNum(round(TOTALCUSTOMERS,-3), big.mark=","),
    `Total GBTU` = prettyNum(round(TOTALKBTU/1000000,-2), big.mark=","),
    `Total tCO2e` = prettyNum(round(TOTALTCO2E,-3), big.mark=",")
  )

kable(
  summary_TCO2E_average_table,
  booktabs = TRUE,
  caption = 'Stockton annual residential and commercial energy usage, 2013 to 2018. Data from PG&E.'
) %>% 
  kable_styling() %>% 
  scroll_box(width = "100%")
```

$~$

The graphs below illustrate that total energy usage (in kBTU) for electricity and gas has stayed roughly level across the last six years, but given that electricity has become cleaner through renewable power sources, the overall carbon footprint of electricity has decreased dramatically in comparison to gas.

```{r summary-kBTU-average, fig.cap="Stockton annual residential and commercial energy usage, 2013 to 2018, in kBTU. Data from PG&E."}
ggplot(
  summary_TCO2E_average, 
  aes(
    x = as.factor(YEAR), 
    y = TOTALKBTU/1000000
  )
) + 
  geom_bar(stat = "identity", aes(fill = ENERGYTYPE), position = "dodge") + 
  labs(x = "Year", y = "GBTU", title = "Stockton Annual Energy Usage, 2013 to 2018") + 
  scale_fill_discrete(name="Energy Type",labels = c("Electricity","Gas"))
```

$~$

```{r summary-TCO2E-average, fig.cap="Stockton annual residential and commercial energy usage, 2013 to 2018, in tCO2e. Data from PG&E."}
ggplot(
  summary_TCO2E_average, 
  aes(
    x = as.factor(YEAR), 
    y = TOTALTCO2E
  )
) + 
  geom_bar(stat = "identity", aes(fill = ENERGYTYPE), position = "dodge") + 
  labs(x = "Year", y = "tCO2e", title = "Stockton Annual Energy Usage, 2013 to 2018") + 
  scale_fill_discrete(name="Energy Type",labels = c("Electricity","Gas"))
```

$~$

The following graph plots monthly tCO2e for electricity vs. gas. The peaks in gas usage occur in January, corresponding to heating load, and the peaks in electricity usage occur in July, corresponding to cooling load, and overall decreasing as previously noted. As we'll explore in a later section, electrification of air and water heating in buildings may be a particularly effective strategy to shift the peak gas consumption to less carbon-intensive electricity loads.

```{r summary-TCO2E-monthly, fig.cap = "Stockton monthly residential and commercial energy usage, 2013 to 2018, in tCO2e. Data from PG&E."}
summary_TCO2E_monthly <- 
  pge_data %>% 
  filter(!CUSTOMERCLASS %in% c("EI","EA")) %>%
  mutate(
    ENERGYTYPE = substr(CUSTOMERCLASS,1,1),
    MONTH = paste0(as.character(YEAR),substr(as.character(round(MONTH/100,2)),2,4))
  ) %>% 
  group_by(MONTH, ENERGYTYPE) %>%
  summarize_at(
    vars(TOTALKBTU,TOTALTCO2E,TOTALCUSTOMERS),
    sum,
    na.rm=T
  ) %>% 
  ungroup() %>% 
  mutate(
    MONTH =
      as.Date(
        paste0(
          gsub(
            "\\.",
            "\\/",
            ifelse(
              nchar(MONTH) == 6,
              paste0(MONTH,"0"),
              MONTH
            )
          ),
          "/01"
        )
      )
  )

ggplot(
  summary_TCO2E_monthly, 
  aes(
    x = MONTH, 
  )
) + 
  geom_line(
    aes(
      y = TOTALTCO2E,
      color = ENERGYTYPE
    )
  ) + 
  labs(x = "Month", y = "tCO2e", title = "Stockton Monthly Energy Usage, 2013 to 2018") + 
  scale_color_manual(
    name= "Energy Type",
    values = c("blue","red"),
    labels = c("Electricity","Gas")
  ) +
  scale_x_date(
    name = 'Year', 
    date_breaks = '1 year',
    date_labels = '%Y'
  )
```

$~$

Note that heating and cooling loads, which appear to contribute to significant seasonal variation within years, is also heavily dependent on the specific weather in any given year, typically measured in heating degree days (HDDs) and cooling degree days (CDDs). A more accurate comparison of annual energy consumption would control for change in HDDs and CDDs year-to-year; a more accurate forecasting of energy consumption into the future would also factor in climate model predictions of future HDDs and CDDs.

We used the [Cal-Adapt Degree Day tool](https://cal-adapt.org/tools/degree-days) to collect HDDs and CDDs for Stockton from 2010 to 2018, and on to 2040, using the average simulation (CanESM2) under the Representative Concentration Pathway (RCP) 4.5 scenario (in which global GHG emissions peak around 2040, then decline). The graph below shows the data from Cal-Adapt, as well as linear trendlines, with a clear overall upwards trend for CDDs (meaning that temperatures are rising and more cooling power is needed), and a clear overall downwards trend for HDDs. 

```{r hdd-cdd, fig.cap="Stockton heating and cooling degree days under RCP 4.5 scenario, 2010 to 2040. Data from Cal-Adapt."}
hdd <- 
  read_csv("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/hdd.csv") %>% 
  transmute(
    YEAR = year,
    hdd = degree_days
  )
cdd <- 
  read_csv("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/cdd.csv") %>% 
  filter(model == "CanESM2") %>% 
  transmute(
    YEAR = year,
    cdd = degree_days
  )

hdd %>% 
  filter(YEAR >= 2010 & YEAR <=2040) %>% 
  left_join(cdd, by = "YEAR") %>% 
  ggplot(
    aes(
      x = YEAR
    )
  ) + 
  geom_line(
    aes(
      y = hdd,
      colour = "Heating",
      linetype = "Cal-Adapt"
    )
  ) +
  geom_smooth(
    aes(
      y = hdd,
      colour = "Heating",
      linetype = "Trendline"
    ),
    method = lm,
    se = FALSE
  ) +
  geom_line(
    aes(
      y = cdd,
      colour = "Cooling",
      linetype = "Cal-Adapt"
    )
  ) +
  geom_smooth(
    aes(
      y = cdd,
      colour = "Cooling",
      linetype = "Trendline"
    ),
    method = lm,
    se = FALSE
  ) +
  geom_vline(aes(xintercept = 2018), color = "dark grey") +
  annotate("text",label= "Historical\n", color = "dark grey", x=2018, y=2600, angle = 90, size=4) +
  annotate("text",label= "\nForecast", color = "dark grey", x=2018, y=2600, angle = 90, size=4) +
  scale_colour_manual(values = c("red","blue")) + 
  scale_linetype_manual(values = c("solid","dotted")) +
  labs(title = "Stockton Heating and Cooling Degree Days", y = "Degree Days", colour = "")
```

$~$

The following table shows historical 2013-2018 annual energy usage per capita (residents for residential energy, jobs for commercial energy) per degree day (HDDs for gas, CDDs for electricity), and the graph that follows shows these four energy use factors with downward trends. This may be through a combination of changing building energy efficiency as well as changing building utilization (e.g. more or less space per occupant), though we don't have the data to be able to separate these two factors.

```{r summary-TCO2E-norm-all}
summary_TCO2E_norm <- 
  pge_data %>% 
  filter(!CUSTOMERCLASS %in% c("EI","EA")) %>%
  group_by(ZIPCODE, CUSTOMERCLASS, YEAR) %>%
  summarize(
    TOTALKBTU = sum(TOTALKBTU, na.rm=T),
    TOTALTCO2E = sum(TOTALTCO2E, na.rm=T), 
    TOTALCUSTOMERS = mean(TOTALCUSTOMERS, na.rm=T)
  ) %>% 
  group_by(CUSTOMERCLASS, YEAR) %>%
  summarize_at(
    vars(TOTALKBTU,TOTALTCO2E,TOTALCUSTOMERS),
    sum,
    na.rm=T
  ) %>% 
  left_join(hdd, by = "YEAR") %>% 
  left_join(cdd, by = "YEAR") %>% 
  left_join(pop_stockton, by = c("YEAR" = "year")) %>% 
  left_join(jobs_stockton, by = c("YEAR" = "year"))

summary_TCO2E_norm_ER <-
  summary_TCO2E_norm %>% 
  filter(CUSTOMERCLASS == "ER") %>% 
  mutate(
    KBTU_res_cdd =
      TOTALKBTU/PopulationStockton/cdd,
    TCO2E_res_cdd = 
      TOTALTCO2E/PopulationStockton/cdd
  )

summary_TCO2E_norm_GR <-
  summary_TCO2E_norm %>% 
  filter(CUSTOMERCLASS == "GR") %>% 
  mutate(
    KBTU_res_hdd =
      TOTALKBTU/PopulationStockton/hdd,
    TCO2E_res_hdd = 
      TOTALTCO2E/PopulationStockton/hdd
  )

summary_TCO2E_norm_EC <-
  summary_TCO2E_norm %>% 
  filter(CUSTOMERCLASS == "EC") %>% 
  mutate(
    KBTU_job_cdd =
      TOTALKBTU/Jobs/cdd,
    TCO2E_job_cdd = 
      TOTALTCO2E/Jobs/cdd
  )

summary_TCO2E_norm_GC <-
  summary_TCO2E_norm %>% 
  filter(CUSTOMERCLASS == "GC") %>% 
  mutate(
    KBTU_job_hdd =
      TOTALKBTU/Jobs/hdd,
    TCO2E_job_hdd = 
      TOTALTCO2E/Jobs/hdd
  )

summary_TCO2E_norm_all <-
  summary_TCO2E_norm_ER %>% 
  ungroup() %>% 
  transmute(
    Year = YEAR,
    `Heating Degree Days` = prettyNum(round(hdd,-2),big.mark=","),
    `Cooling Degree Days` = prettyNum(round(cdd,-2),big.mark=","),
    Residents = prettyNum(round(PopulationStockton,-3),big.mark=","),
    Jobs = prettyNum(round(Jobs,-3),big.mark=","),
    `Residential Electricity, kBTU/resident/CDD` = round(KBTU_res_cdd,1)
  ) %>% 
  mutate(
    `Residential Gas, kBTU/resident/HDD` = round(summary_TCO2E_norm_GR$KBTU_res_hdd,1),
    `Commercial Electricity, kBTU/job/CDD` = round(summary_TCO2E_norm_EC$KBTU_job_cdd,1),
    `Commercial Gas, kBTU/job/HDD` = round(summary_TCO2E_norm_GC$KBTU_job_hdd,1)
  )
  
kable(
  summary_TCO2E_norm_all,
  booktabs = TRUE,
  caption = 'Stockton annual energy use per capita per degree-day, 2013 to 2018.'
) %>% 
  kable_styling() %>% 
  scroll_box(width = "100%")
```

$~$

```{r summary-TCO2E-norm-all-graph, fig.cap="Stockton annual energy use per capita per degree-day, 2013 to 2018."}
summary_TCO2E_norm_all %>%
  ggplot(
    aes(
      x = Year
    )
  ) +
  geom_line(
    aes(
      y = `Residential Electricity, kBTU/resident/CDD`,
      colour = "Residential Electricity\n(kBTU/resident/CDD)",
      linetype = "Historical"
    )
  ) +
  geom_smooth(
    aes(
      y = `Residential Electricity, kBTU/resident/CDD`,
      colour = "Residential Electricity\n(kBTU/resident/CDD)",
      linetype = "Trendline"
    ),
    method = lm,
    se = FALSE
  )+
  geom_line(
    aes(
      y = `Residential Gas, kBTU/resident/HDD`,
      colour = "Residential Gas\n(kBTU/resident/HDD)",
      linetype = "Historical"
    )
  ) +
  geom_smooth(
    aes(
      y = `Residential Gas, kBTU/resident/HDD`,
      colour = "Residential Gas\n(kBTU/resident/HDD)",
      linetype = "Trendline"
    ),
    method = lm,
    se = FALSE
  ) +
  geom_line(
    aes(
      y = `Commercial Electricity, kBTU/job/CDD`,
      colour = "Commercial Electricity\n(kBTU/job/CDD)",
      linetype = "Historical"
    )
  ) +
  geom_smooth(
    aes(
      y = `Commercial Electricity, kBTU/job/CDD`,
      colour = "Commercial Electricity\n(kBTU/job/CDD)",
      linetype = "Trendline"
    ),
    method = lm,
    se = FALSE
  ) +
  geom_line(
    aes(
      y = `Commercial Gas, kBTU/job/HDD`,
      colour = "Commercial Gas\n(kBTU/job/HDD)",
      linetype = "Historical"
    )
  ) +
  geom_smooth(
    aes(
      y = `Commercial Gas, kBTU/job/HDD`,
      colour = "Commercial Gas\n(kBTU/job/HDD)",
      linetype = "Trendline"
    ),
    method = lm,
    se = FALSE
  ) +
  scale_colour_manual(values = c("red","blue","orange", "green")) +
  scale_linetype_manual(values = c("solid","dotted")) +
  labs(title = "Stockton Energy Use per Capita per Degree-Day", y = "kBTU/cap/degree-day", colour = "Energy Factor", linetype = "Data Type")
```

$~$

A full forecast of energy usage will also depend on predicted changes in resident and job populations, which will lead to more buildings and more energy used in buildings, predicted changes in building energy efficiency and utilization, predicted changes in weather, and many other factors that are outside the scope of this analysis. One last available dataset to incorporate into our understanding of energy use relates to buildings.

## Buildings

2018 data from the local County Assessor's Office includes property use type and total building square footage for every parcel in Stockton. Because the assessor's record of total building square footage is of poor quality, we chose to instead use [Microsoft's U.S. Building Footprint Data](https://github.com/microsoft/USBuildingFootprints), joined each building footprint to a parcel (thereby also assigning a residential or commercial type based on the zoning of the parcel), and multiplied this footprint area by number of stories, which came either from the assessor's record or from the Microsoft data. This dataset may still contain significant errors (e.g. mixed use parcels are mis-identified, the stories record may be incorrect, Microsoft's building footprints may be incorrect, etc.), but we decided it was the best representation of total building square footage in Stockton. 

The following maps show the density of residents per acre across Stockton, followed by the density of jobs per acre of commercials buildings, at the block group level. Residential population was obtained from ACS 2017 5-yr data, and job count was obtained from LODES 2017.

```{r residential-density, fig.cap="Stockton residents per 1,000 sqft of residential building area, per block group."}
pge_stockton_filtered <- 
  pge_data %>% 
  filter(!CUSTOMERCLASS %in% c("EI","EA") & (YEAR == 2018)) %>%
  dplyr::select(-YEAR,-TOTALTCO2E,-TCO2EPERCUST)

zips_spread <- 
  pge_stockton_filtered %>% 
  group_by(ZIPCODE, CUSTOMERCLASS) %>% 
  summarise(
    TOTALKBTU = sum(TOTALKBTU, na.rm=T),
    TOTALCUSTOMERS = mean(TOTALCUSTOMERS, na.rm=T)
  ) %>% 
  mutate(KBTUPERCUST = TOTALKBTU/TOTALCUSTOMERS) %>% 
  gather(key = "type", value, TOTALKBTU:KBTUPERCUST) %>% 
  unite(temp,CUSTOMERCLASS,type) %>% 
  spread(temp,value) 

#next, since the previous line fully disaggregates by type AND class, but i also consider it valuable to disaggregate by type OR class individually on their own, i do a second and third spread. all of these "spreads" will be joined back to an original in the final step.
zips_spread_2 <- 
  pge_stockton_filtered %>% 
  group_by(ZIPCODE, CUSTOMERCLASS) %>% 
  summarise(
    TOTALKBTU = sum(TOTALKBTU, na.rm=T),
    TOTALCUSTOMERS = mean(TOTALCUSTOMERS, na.rm=T)
  ) %>% 
  ungroup() %>% 
  mutate(ENERGYTYPE = substr(CUSTOMERCLASS,1,1)) %>% 
  dplyr::select(-CUSTOMERCLASS) %>% 
  group_by(ZIPCODE, ENERGYTYPE) %>% 
  summarise(
    TOTALKBTU = sum(TOTALKBTU, na.rm=T),
    TOTALCUSTOMERS = sum(TOTALCUSTOMERS, na.rm=T)
  ) %>% 
  mutate(KBTUPERCUST = TOTALKBTU/TOTALCUSTOMERS) %>% 
  gather(key = "type", value, TOTALKBTU:KBTUPERCUST) %>% 
  unite(temp,ENERGYTYPE,type) %>% 
  spread(temp,value)

#note that when combining into SECTOR, say electricity and gas for commercial, the summary function for TOTALCUSTOMERS switches to max(), with the reasoning that many of these commercial customers have both electricity and gas, so we would assume that the correct total # of customers is closer to the max of either, than to add them together (which presumes that there are no overlapping electricity and gas customers).
zips_spread_3 <- 
  pge_stockton_filtered %>%
  group_by(ZIPCODE, CUSTOMERCLASS) %>% 
  summarise(
    TOTALKBTU = sum(TOTALKBTU, na.rm=T),
    TOTALCUSTOMERS = mean(TOTALCUSTOMERS, na.rm=T)
  ) %>% 
  ungroup() %>% 
  mutate(SECTOR = substr(CUSTOMERCLASS,2,2)) %>% 
  dplyr::select(-CUSTOMERCLASS) %>% 
  group_by(ZIPCODE, SECTOR) %>% 
  summarise(TOTALKBTU = sum(TOTALKBTU, na.rm=T),
            TOTALCUSTOMERS = max(TOTALCUSTOMERS, na.rm=T)) %>% 
  mutate(KBTUPERCUST = TOTALKBTU/TOTALCUSTOMERS) %>% 
  gather(key = "type", value, TOTALKBTU:KBTUPERCUST) %>% 
  unite(temp,SECTOR,type) %>% 
  spread(temp,value)

#the final step here is to get the actual total totals for kbtu and TCO2E indicators, and then join all the "subtotals" from the previous 3 spreads.
zips_total <- 
  pge_stockton_filtered %>% 
  group_by(ZIPCODE) %>% 
  summarize(TOTALKBTU = sum(TOTALKBTU, na.rm=T)) %>% 
  left_join(zips_spread_3, by = "ZIPCODE") %>% 
  mutate(TOTALCUSTOMERS = R_TOTALCUSTOMERS + C_TOTALCUSTOMERS) %>% 
  left_join(zips_spread_2, by = "ZIPCODE") %>% 
  left_join(zips_spread, by = "ZIPCODE")

#join this massive summary back to the zcta geometries
zcta_stockton_joined <- 
  zcta_stockton %>% 
  left_join(zips_total, by="ZIPCODE")

#below I've brought in all the code from stockton_bldg.R, but it can all be skipped by going to the load() of stockton_bldg.Rdata at the bottom. Kevin, whatever refinements you've made, go ahead and make them here.

# sjc_bldg <- 
#   read_csv("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/USBuildingFootprints/ca_06077_footprints.csv") %>% 
#   st_as_sf(wkt = "WKT") %>% 
#   st_set_crs(4326) %>% 
#   st_transform(st_crs(zcta_stockton)) %>% 
#   mutate(id = row_number())
# 
# stockton_bldg <- 
#   sjc_bldg[which(sjc_bldg$id %in% st_centroid(sjc_bldg)[stockton_boundary_influence,]$id),]
# 
# sjc_parcels <- 
#   st_read("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/Parcels/Parcels.shp") %>% 
#   st_transform(st_crs(zcta_stockton)) %>% 
#   st_make_valid()
# 
# save(sjc_parcels, file = "C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/Parcels/sjc_parcels.Rdata")
# 
# stockton_parcels <- 
#   sjc_parcels[stockton_boundary_influence,]
# 
# bldg_parcel_join <- 
#   st_join(st_centroid(stockton_bldg), stockton_parcels) %>%
#   dplyr::select(APN, id, STAREA__) %>% 
#   rename(area = STAREA__) %>% 
#   st_set_geometry(NULL)
# 
# sjc_zoning <- 
#   st_read("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/Zoning/Zoning.shp") %>% 
#   st_transform(st_crs(zcta_stockton)) %>% 
#   filter(ZNLABEL != "STOCKTON")
# 
# stockton_zoning <- 
#   st_read("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/Stockton_Zoning/Zoning.shp") %>% 
#   st_transform(st_crs(zcta_stockton))
# 
# bldg_zoning_join <- 
#   st_join(st_centroid(stockton_bldg), stockton_zoning) %>% 
#   dplyr::select(ZONE, id) %>% 
#   st_set_geometry(NULL)
# 
# bldg_zoning_join_uninc <- 
#   st_join(st_centroid(stockton_bldg), sjc_zoning) %>% 
#   dplyr::select(ZNCODE, id) %>% 
#   st_set_geometry(NULL)
# 
# bldg_zoning_join %<>% 
#   merge(bldg_zoning_join_uninc) %>% 
#   mutate(ZONE = ifelse(is.na(ZONE),as.character(ZNCODE),as.character(ZONE))) %>% 
#   dplyr::select(ZONE, id)
# 
# sjc_bgs <- 
#   block_groups("California", "San Joaquin County")
# 
# stockton_bgs <- 
#   sjc_bgs[stockton_boundary_influence,]
# 
# bldg_bg_join <- 
#   st_join(st_centroid(stockton_bldg), stockton_bgs) %>% 
#   dplyr::select(GEOID, id) %>% 
#   st_set_geometry(NULL)
# 
# bldg_zcta_join <- 
#   st_join(st_centroid(stockton_bldg), zcta_stockton) %>% 
#   dplyr::select(ZIPCODE, id) %>% 
#   st_set_geometry(NULL)
# 
# load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/tax_sjc.Rdata")
# 
# tax_sjc <- 
#   tax_sjc %>% 
#   mutate(APN = as.numeric(apn)) %>% 
#   st_set_geometry(NULL)
# 
# stockton_bldg_final <-
#   stockton_bldg %>%
#   left_join(bldg_parcel_join, by="id") %>%
#   left_join(bldg_zoning_join, by="id") %>%
#   left_join(bldg_bg_join, by="id") %>%
#   left_join(bldg_zcta_join, by="id") %>%
#   left_join(tax_sjc, by="APN") %>%
#   mutate( # the following takes the bldg data, computes bldgground (ground footprint, where the factor conversion is sqm to sqft) and bldgtot (total sqft).
#     bldgground = as.numeric(st_area(WKT))*10.7639,
#     bldgtot =
#       ifelse(
#         is.na(stories),
#         bldgground,
#         bldgground*stories
#       ),
#     ZIPCODE = as.numeric(ZIPCODE),
#     ZONING = 
#       case_when(
#         substr(ZONE,1,1) == "R" ~ "R",
#         substr(ZONE,1,2) == "(R" ~ "R",
#         substr(ZONE,1,1) %in% c("C","P","M","U") ~ "C", 
#         substr(ZONE,1,2) %in% c("(C","(P") ~ "C",
#         TRUE ~ "O"
#       )
#   )
# 
# save(stockton_bldg_final, file = "C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/stockton_bldg.Rdata")
load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/stockton_bldg.Rdata")
# 
# stockton_bldg_17 <- 
#   readOGR(dsn = "C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/USBuildingFootprints/Stockton2017", layer = "Stockton") %>% 
#   st_as_sf() %>% 
#   st_transform(st_crs(stockton_bldg_final))
# 
# save(stockton_bldg_17, file = "C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/USBuildingFootprints/stockton_bldg_17.Rdata")
# load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/USBuildingFootprints/stockton_bldg_17.Rdata")

# # match height from 2017 data
# bldg_join <-
#   stockton_bldg_final %>%
#   st_join(
#     stockton_bldg_17 %>%
#       st_transform(26910) %>%
#       st_buffer(-1) %>%
#       st_transform(st_crs(stockton_bldg_final))
#   ) %>%
#   group_by(id) %>%
#   summarize(
#     Height = mean(Height,na.rm=T)
#   ) %>%
#   left_join(stockton_bldg_final %>% st_set_geometry(NULL),by="id")
# 
# bldg_join <-
#   bldg_join %>% 
#   mutate(
#     stories_by_height =
#       case_when(
#         GEOID == "060770039001" ~ 1, #Naval base
#         is.na(Height) & is.na(stories) ~ 1,
#         is.na(Height) ~ round(stories),
#         !is.na(stories) ~ round(stories),
#         Height < mean(bldg_join[which(!is.na(bldg_join$Height)&round(bldg_join$stories)==1),]$Height) + sd(bldg_join[which(!is.na(bldg_join$Height)&round(bldg_join$stories)==1),]$Height) ~ 1,
#         Height < mean(bldg_join[which(!is.na(bldg_join$Height)&round(bldg_join$stories)==2),]$Height) + sd(bldg_join[which(!is.na(bldg_join$Height)&round(bldg_join$stories)==2),]$Height) ~ 2,
#         Height < mean(bldg_join[which(!is.na(bldg_join$Height)&round(bldg_join$stories)==3),]$Height) + sd(bldg_join[which(!is.na(bldg_join$Height)&round(bldg_join$stories)==3),]$Height) ~ 3,
#         Height < mean(bldg_join[which(!is.na(bldg_join$Height)&round(bldg_join$stories)==4),]$Height) + sd(bldg_join[which(!is.na(bldg_join$Height)&round(bldg_join$stories)==4),]$Height) ~ 4,
#         TRUE ~ round(Height/5)
#       ),
#     bldg_tot =
#       bldgground*stories_by_height
#   )
# # 6033 unmatched when using -1m buffer. #2637 of those did not have assessor stories data, set to 1F. Of other 3396, 2090 1F, 1248 2F, 58 3F.
# # 70757 had both 2017 heights and assessor stories data, go with assessor stories data. 51676 had assessor stories = 1, kept at 1F. 18974 had assessor stories = 2, kept at 2F. 107 had assessor stories > 2, set to 2.5F.
# # mean height for assessor 1F: 11.30, sd 1.63. mean height for assessor 2F: 13.98, sd 2.25. mean height for assessor 3F: 15.39, sd 2.99. mean height for assessor 4F: 14.42, sd 5.35.
# # 24660 had no assessor stories data but had 2017 heights, use mean + 1 sd from above as thresholds. 1F: 12.92. 2F: 16.23. 3F: 18.38. 4F: 19.77
# # 15991 1F, 5642 2F, 908 3F, 1512 4F, 541 5F, 29 6F, 12 7F, 15 8F, 4 9F, 5 10F, 1 12F.
# 
# save(bldg_join, file = "C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/USBuildingFootprints/bldg_join.Rdata")
load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/USBuildingFootprints/bldg_join.Rdata")

bg_bldg <-
  bldg_join %>% 
  st_set_geometry(NULL) %>% 
  group_by(GEOID, ZONING) %>% 
  summarize(
    numbldg = n(),
    bldgtot = sum(bldgtot, na.rm=T)
  ) %>% 
  ungroup() %>% 
  left_join(stockton_bgs_full, by = "GEOID") %>% 
  st_as_sf() %>% 
  filter(!is.na(st_dimension(.)))

#res/sqft per block group
bg_pop <-
  getCensus(
    name = "acs/acs5",
    vintage = 2017, # satellite imagery is from around 2014/2015
    vars = c("B01003_001E"),
    region = "block group:*",
    regionin = "state:06+county:077"
  ) %>%
  transmute(
    GEOID = paste0(state,county,tract,block_group),
    pop = B01003_001E
  )

bg_bldg_norm_r <-
  bg_bldg %>% 
  filter(ZONING == "R") %>% 
  left_join(bg_pop, by = "GEOID") %>% 
  mutate(
    `Residents per 1,000 sqft` = pop/bldgtot*1000,
    residential_density = bldgtot/(as.numeric(st_area(.))/4046.86)
  )

# map = mapview(bg_bldg_norm_r[,c("residential_density")],zcol=c("residential_density"), legend = TRUE, layer.name = "Residential</br>density</br>per acre")
# 
# mapshot(map, url = "map-residential-density.html")

knitr::include_url("http://web.stanford.edu/~douyang1/map-residential-density.html")
```

$~$

```{r commercial-density, fig.cap="Stockton jobs per 1,000 sqft of commercial building area, per block group."}
# bldg_norm_r <-
#   bg_bldg %>% 
#   filter(ZONING == "R") %>% 
#   left_join(bg_pop, by = "GEOID") %>% 
#   summarize(
#     pop = sum(pop, na.rm=T),
#     bldgtot = sum(bldgtot, na.rm=T)
#   ) %>% 
#   mutate(`Residents/1000sqft` = pop/bldgtot*1000)
# 
# bldg_norm_c <-
#   bg_bldg %>% 
#   filter(ZONING == "C") %>% 
#   left_join(
#     stockton_wac %>% 
#       filter(year == 2017) %>% 
#       dplyr::select(jobs = C000, GEOID), 
#     by = "GEOID"
#   ) %>% 
#   summarize(
#     jobs = sum(jobs, na.rm=T),
#     bldgtot = sum(bldgtot, na.rm=T)
#   ) %>% 
#   mutate(`Jobs/1000sqft` = jobs/bldgtot*1000)

bg_bldg_norm_c <-
  bg_bldg %>% 
  filter(ZONING == "C") %>% 
  left_join(
    stockton_wac %>% 
      as.data.frame() %>% 
      filter(year == 2015) %>% 
      dplyr::select(jobs=C000,GEOID), 
    by = "GEOID"
  ) %>% 
  mutate(
    `Jobs per 1,000 sqft` = jobs/bldgtot*1000,
    commercial_density = bldgtot/(as.numeric(st_area(.))/4046.86)
  ) %>% 
  filter(!GEOID %in% c("060770039001","060770039002"))

# map = mapview(bg_bldg_norm_c[,c("commercial_density")],zcol=c("commercial_density"), legend = TRUE, layer.name = "Commercial</br>density</br>per acre")
# 
# mapshot(map, url = "map-commercial-density.html")

knitr::include_url("http://web.stanford.edu/~douyang1/map-commercial-density.html")
```

$~$

Because we do not have robust historical building datasets, we cannot analyze the change in building square footages over time. For forecasting, we assumed an overall fixed building utilization estimate of 1.7 residents per 1000 sqft of residential buildings, and 1.3 jobs per 1000 sqft of commercial buildings. In the intervention stage, if we expect a strategy would change building utilization, we would make a reduction in energy consumption relative to these baseline utilization rates.

As one last couple of building-specific analyses, we aggregated building square footage information up to the zipcode level and compared with energy usage data to see residential and commercial building energy efficiency at a recent snapshot of time, spatially distributed across Stockton.

```{r res-customer, fig.cap="Stockton residential kBTU per sqft of residential building area, per zip code."}
#disaggregating by zipcode and zoning type of the buildings to get summaries of # of buildings, total ground footprint, and total bldg sqft. the filter removes NAs in the data, which could be missing zones in specific zipcodes.
zcta_bldg_spread <- 
  stockton_bldg_final %>% 
  st_set_geometry(NULL) %>% 
  group_by(ZIPCODE, ZONING) %>% 
  summarise(
    NUMBLDG = n(),
    TOTSQFTGROUND = sum(bldgground, na.rm=T),
    TOTSQFT = sum(bldgtot, na.rm=T)
  ) %>% 
  filter(!is.na(ZIPCODE) & !is.na(ZONING)) %>% 
  gather(key, value, NUMBLDG:TOTSQFT) %>% 
  unite(temp,ZONING,key) %>% 
  spread(temp,value)

#summarize totals by zipcode, then join the zoning-specific subtotals to it.
zcta_bldg_summary <-
  stockton_bldg_final %>% 
  st_set_geometry(NULL) %>% 
  group_by(ZIPCODE) %>% 
  summarise(
    NUMBLDG = n(),
    TOTSQFTGROUND = sum(bldgground, na.rm=T),
    TOTSQFT = sum(bldgtot, na.rm=T)
  ) %>% 
  left_join(zcta_bldg_spread, by = "ZIPCODE")

zcta_bldg_stockton_joined <- 
  zcta_stockton_joined %>% 
  filter(ZIPCODE != 95211) %>% 
  left_join(zcta_bldg_summary, by = "ZIPCODE") %>% 
  mutate(
    ER_KBTUperSQFT = ER_TOTALKBTU/R_TOTSQFT, 
    GR_KBTUperSQFT = GR_TOTALKBTU/R_TOTSQFT, 
    EC_KBTUperSQFT = EC_TOTALKBTU/C_TOTSQFT, 
    GC_KBTUperSQFT = GC_TOTALKBTU/C_TOTSQFT, 
    R_KBTUperSQFT = R_TOTALKBTU/R_TOTSQFT, 
    C_KBTUperSQFT = C_TOTALKBTU/C_TOTSQFT, 
    E_KBTUperSQFT = E_TOTALKBTU/TOTSQFT, 
    G_KBTUperSQFT = G_TOTALKBTU/TOTSQFT, 
    KBTUperSQFT = TOTALKBTU/TOTSQFT
  )

# map = mapview(zcta_bldg_stockton_joined[,c("R_KBTUPERCUST")], zcol=c("R_KBTUPERCUST"), legend = TRUE, layer.name = "kBTU per customer,</br>Residential")
# 
# mapshot(map, url = "map-res-customer.html")

knitr::include_url("http://web.stanford.edu/~douyang1/map-res-customer.html")
```

$~$

```{r comm-customer, fig.cap="Stockton commercial kBTU per sqft of commercial building area, per zip code."}
# map = mapview(zcta_bldg_stockton_joined[,c("C_KBTUPERCUST")], zcol=c("C_KBTUPERCUST"), legend = TRUE, layer.name = "kBTU per customer,</br>Commercial")
# 
# mapshot(map, url = "map-comm-customer.html")

knitr::include_url("http://web.stanford.edu/~douyang1/map-comm-customer.html")
```

$~$

```{r zcta-bldg-stockton-table}
zcta_bldg_stockton_summary <- 
  zcta_bldg_stockton_joined %>% 
  st_set_geometry(NULL) %>% 
  summarise_at(
    c(
      "NUMBLDG", 
      "R_NUMBLDG", 
      "C_NUMBLDG",
      "TOTSQFTGROUND",
      "TOTSQFT",
      "R_TOTSQFT",
      "C_TOTSQFT",
      "R_TOTSQFTGROUND",
      "C_TOTSQFTGROUND",
      "TOTALKBTU",
      "E_TOTALKBTU",
      "G_TOTALKBTU",
      "R_TOTALKBTU",
      "C_TOTALKBTU", 
      "ER_TOTALKBTU", 
      "GR_TOTALKBTU", 
      "EC_TOTALKBTU", 
      "GC_TOTALKBTU"
    ), sum, na.rm=T
  ) %>% 
  mutate(
    ER_KBTUperSQFT = ER_TOTALKBTU/R_TOTSQFT, 
    GR_KBTUperSQFT = GR_TOTALKBTU/R_TOTSQFT, 
    EC_KBTUperSQFT = EC_TOTALKBTU/C_TOTSQFT, 
    GC_KBTUperSQFT = GC_TOTALKBTU/C_TOTSQFT, 
    R_KBTUperSQFT = R_TOTALKBTU/R_TOTSQFT, 
    C_KBTUperSQFT = C_TOTALKBTU/C_TOTSQFT, 
    E_KBTUperSQFT = E_TOTALKBTU/TOTSQFT, 
    G_KBTUperSQFT = G_TOTALKBTU/TOTSQFT, 
    KBTUperSQFT = TOTALKBTU/TOTSQFT,
  )

zcta_bldg_stockton_table <-
  data.frame(
    Type = c(
      "Residential Electricity",
      "Residential Gas",
      "Commercial Electricity",
      "Commercial Gas",
      "Residential Total",
      "Commercial Total",
      "Electricity Total",
      "Gas Total",
      "Total"
    ),
    Bldg = c(
      NA,
      NA,
      NA,
      NA,
      zcta_bldg_stockton_summary$R_NUMBLDG,
      zcta_bldg_stockton_summary$C_NUMBLDG,
      NA,
      NA,
      zcta_bldg_stockton_summary$R_NUMBLDG+zcta_bldg_stockton_summary$C_NUMBLDG
    ),
    Footprint = c(
      NA,
      NA,
      NA,
      NA,
      zcta_bldg_stockton_summary$R_TOTSQFTGROUND,
      zcta_bldg_stockton_summary$C_TOTSQFTGROUND,
      NA,
      NA,
      zcta_bldg_stockton_summary$R_TOTSQFTGROUND+zcta_bldg_stockton_summary$C_TOTSQFTGROUND
    ),
    sqft = c(
      NA,
      NA,
      NA,
      NA,
      zcta_bldg_stockton_summary$R_TOTSQFT,
      zcta_bldg_stockton_summary$C_TOTSQFT,
      NA,
      NA,
      zcta_bldg_stockton_summary$R_TOTSQFT+zcta_bldg_stockton_summary$C_TOTSQFT
    ),
    kbtu = c(
      zcta_bldg_stockton_summary$ER_TOTALKBTU,
      zcta_bldg_stockton_summary$GR_TOTALKBTU,
      zcta_bldg_stockton_summary$EC_TOTALKBTU,
      zcta_bldg_stockton_summary$GC_TOTALKBTU,
      zcta_bldg_stockton_summary$R_TOTALKBTU,
      zcta_bldg_stockton_summary$C_TOTALKBTU,
      zcta_bldg_stockton_summary$E_TOTALKBTU,
      zcta_bldg_stockton_summary$G_TOTALKBTU,
      zcta_bldg_stockton_summary$TOTALKBTU
    ),
    kbtusqft = c(
      zcta_bldg_stockton_summary$ER_KBTUperSQFT,
      zcta_bldg_stockton_summary$GR_KBTUperSQFT,
      zcta_bldg_stockton_summary$EC_KBTUperSQFT,
      zcta_bldg_stockton_summary$GC_KBTUperSQFT,
      zcta_bldg_stockton_summary$R_KBTUperSQFT,
      zcta_bldg_stockton_summary$C_KBTUperSQFT,
      zcta_bldg_stockton_summary$E_KBTUperSQFT,
      zcta_bldg_stockton_summary$G_KBTUperSQFT,
      zcta_bldg_stockton_summary$TOTALKBTU/(zcta_bldg_stockton_summary$R_TOTSQFT+zcta_bldg_stockton_summary$C_TOTSQFT)
    )
  ) %>% 
  transmute(
    Type = Type,
    `Number of Buildings` = 
      ifelse(
        is.na(Bldg),
        "",
        prettyNum(round(Bldg,-3),big.mark = ",")
      ),
    `Total Footprint` =
      ifelse(
        is.na(Footprint),
        "",
        prettyNum(round(Footprint,-6),big.mark = ",")
      ),
    `Total Sqft` =
      ifelse(
        is.na(sqft),
        "",
        prettyNum(round(sqft,-6),big.mark = ",")
      ),
    `Total kBTU` = prettyNum(round(kbtu,-7),big.mark = ","),
    `kBTU/sqft` = prettyNum(round(kbtusqft),big.mark = ",")
  )

kable(
  zcta_bldg_stockton_table, 
  booktabs = TRUE,
  caption = 'Summary of Building count, size, and energy usage for residential/commercial and electricity/gas. Data from PG&E, 2018.'
) %>% 
  kable_styling() %>% 
  scroll_box(width = "100%")
```

$~$

## GHG Forecast

For our "business-as-usual" forecast of GHG emissions through 2040, and for our subsequent exploration of intervention strategies, we will focus on the following sectors for which we have used available data to refine our models: transportation, commercial energy, and residential energy. These sectors represented 58% of ICLEI's modeled emissions in 2016. The other sectors, particularly industrial energy which comprised 24% of 2016 emissions, are also significant opportunities for GHG reductions, but are outside of the scope of this analysis without better data.

Our simplified model of transportation emissions assumes that commute one-way vehicle miles traveled per worker is on a linear trend based on recent data. Otherwise, our forecasts of growth in the number of employed residents drives changes in VMT and thus transportation emissions. Other "business-as-usual" factors, like a forecasted adoption of EVs, are not considered in this analysis.

Our simplified model of energy emissions will assume that building square footage increases with population and job growth through fixed ratios, and an underlying energy use factor for commercial and residential electricity and gas will follow the same trends as the last six years through 2040. Otherwise, a basic climate change model of heating and cooling degree days will drive additional changes in the forecasts.

In summary, the following assumptions go into inputs for the forecasts, which are also shown in the table below:

- From Section 2.1, we derived future population, employed resident, and job forecasts, specifically for the years 2020, 2025, 2030, 2035, and 2040.
- From Section 2.5, we derived commute one-way VMT/workers for 2011-2017. The table below projects this trend to 2040.
- From Section 2.6, we derived non-commute annual VMT/capita using 2018 data. Without further data, we will assume a constant rate through 2040 of 4100 miles/capita/year, so that non-commute travel increases proportionally with population growth.
- From Section 2.7, we derived simplified aggregate vehicle emission rates for San Joaquin County through 2040. Average gCO2/mile and % electric vehicles are projected in the table below.
- From Section 2.7, we derived a linear forecast of PG&E's electricity emissions factor which runs from 2017's data point towards a 2045 target of 100% clean energy.
- From Section 2.7, we derived linear forecasts of heating and cooling degree days through 2040 from Cal-Adapt's HDD and CDD projections.
- From Section 2.7, we derived linear forecasts of energy use per capita per degree-day through 2040. For Commercial Gas, we leveled out the forecast at 1 kBTU/job/HDD from 2035 on.

```{r ghg-forecast-prep}
summary_TCO2E_norm_projection <-
  summary_TCO2E_norm_all

summary_TCO2E_norm_projection[7:11,1] <- c(2020,2025,2030,2035,2040)

ghg_forecast_prep <-
  summary_TCO2E_norm_projection %>% 
  dplyr::select(-`Heating Degree Days`,-`Cooling Degree Days`,-Residents,-Jobs) %>% 
  mutate(
    `Residential Electricity, kBTU/resident/CDD` =
      ifelse(
        Year < 2020,
        `Residential Electricity, kBTU/resident/CDD`,
        lm(
          `Residential Electricity, kBTU/resident/CDD`[1:6] ~ Year[1:6]
        )$coefficients[1]+
          lm(
            `Residential Electricity, kBTU/resident/CDD`[1:6] ~ Year[1:6]
          )$coefficients[2]*Year
      ),
    `Residential Gas, kBTU/resident/HDD` =
      ifelse(
        Year < 2020,
        `Residential Gas, kBTU/resident/HDD`,
        lm(
          `Residential Gas, kBTU/resident/HDD`[1:6] ~ Year[1:6]
        )$coefficients[1]+
          lm(
            `Residential Gas, kBTU/resident/HDD`[1:6] ~ Year[1:6]
          )$coefficients[2]*Year
      ),
    `Commercial Electricity, kBTU/job/CDD` =
      ifelse(
        Year < 2020,
        `Commercial Electricity, kBTU/job/CDD`,
        lm(
          `Commercial Electricity, kBTU/job/CDD`[1:6] ~ Year[1:6]
        )$coefficients[1]+
          lm(
            `Commercial Electricity, kBTU/job/CDD`[1:6] ~ Year[1:6]
          )$coefficients[2]*Year
      ),
    `Commercial Gas, kBTU/job/HDD` =
      ifelse(
        Year < 2020,
        `Commercial Gas, kBTU/job/HDD`,
        lm(
          `Commercial Gas, kBTU/job/HDD`[1:6] ~ Year[1:6]
        )$coefficients[1]+
          lm(
            `Commercial Gas, kBTU/job/HDD`[1:6] ~ Year[1:6]
          )$coefficients[2]*Year
      ),
    `Commercial Gas, kBTU/job/HDD` =
      ifelse(
        `Commercial Gas, kBTU/job/HDD` < 1,
        1,
        `Commercial Gas, kBTU/job/HDD`
      )
  ) %>% 
  left_join(hdd, by = c("Year" = "YEAR")) %>% 
  left_join(cdd, by = c("Year" = "YEAR")) %>% 
  left_join(pop_jobs_stockton_w_projection %>% dplyr::select(Year, Population, `Employed Residents`, Jobs), by = "Year") %>% 
  left_join(stockton_commute_vmt_tractmode %>% dplyr::select(Year, vmt, jobs_car), by = "Year") %>% 
  mutate(
    vmtperjob = vmt/jobs_car
  ) %>% 
  dplyr::select(-vmt,-jobs_car) %>% 
  mutate(
    vmtperjob =
      ifelse(
        Year < 2018,
        vmtperjob,
        lm(
          vmtperjob[1:5] ~ Year[1:5]
        )$coefficients[1]+
          lm(
            vmtperjob[1:5] ~ Year[1:5]
          )$coefficients[2]*Year
      )
  ) %>% 
  left_join(pge_elec_emissions_factor, by = c("Year" = "year")) %>% 
  left_join(vehicle_emissions_trend, by = "Year") %>% 
  left_join(vehicle_electric_trend, by = "Year")

ghg_forecast_table_prep <-
  ghg_forecast_prep %>% 
  transmute(
    Year = Year,
    Population = prettyNum(round(Population,-3),big.mark=","),
    `Employed Residents` = prettyNum(round(`Employed Residents`,-3),big.mark=","),
    Jobs = prettyNum(round(Jobs,-3),big.mark=","),
    `One-way Commute VMT per Car-dependent Worker` = round(vmtperjob),
    `gCO2 per Vehicle Mile` = round(`gCO2/mile`),
    `Percent EVs` = count,
    `PG&E Electricity Emissions Factor` = round(factor),
    `Heating Degree Days` = hdd,
    `Cooling Degree Days` = cdd,
    `Residential Electricity, kBTU/resident/CDD` = round(`Residential Electricity, kBTU/resident/CDD`,1),
    `Residential Gas, kBTU/resident/HDD` = round(`Residential Gas, kBTU/resident/HDD`,1),
    `Commercial Electricity, kBTU/job/CDD` = round(`Commercial Electricity, kBTU/job/CDD`,1),
    `Commercial Gas, kBTU/job/HDD` = round(`Commercial Gas, kBTU/job/HDD`,1)
  )

kable(
  ghg_forecast_table_prep,
  booktabs = TRUE,
  caption = 'Input assumptions for GHG forecast to 2040.'
) %>% 
  kable_styling() %>% 
  scroll_box(width = "100%")
```

$~$

The input assumptions above result in the following GHG forecasts.

```{r ghg-forecast}
ghg_forecast <-
  ghg_forecast_prep %>% 
  transmute(
    Year = Year,
    transport = vmtperjob * `Employed Residents` *2*369.39*`gCO2/mile`*1.1023e-6 + `Employed Residents`*2*369.39*`gCO2/trip`*1.1023e-6,
    amenity = 4100 * Population*`gCO2/mile`*1.1023e-6,
    residential = `Residential Electricity, kBTU/resident/CDD`*Population*cdd*2.9307e-7*0.000453592 + `Residential Gas, kBTU/resident/HDD`*Population*hdd/99.9761*0.00531,
    commercial = `Commercial Electricity, kBTU/job/CDD`*Jobs*cdd*2.9307e-7*0.000453592 + `Commercial Gas, kBTU/job/HDD`*Jobs*hdd/99.9761*0.00531
  )

ghg_forecast_table <-
  ghg_forecast %>% 
  transmute(
    Year=Year,
    `Commute tCO2` = prettyNum(round(transport,-4),big.mark=","),
    `Non-Commute tCO2` = prettyNum(round(amenity,-3),big.mark=","),
    `Residential Building tCO2` = prettyNum(round(residential,-3),big.mark=","),
    `Commercial Building tCO2` = prettyNum(round(commercial,-3),big.mark=",")
  )

kable(
  ghg_forecast_table,
  booktabs = TRUE,
  caption = 'GHG forecast to 2040 for three subsets of GHG emissions.'
) %>% 
  kable_styling() %>% 
  scroll_box(width = "100%")
```

$~$

```{r ghg-forecast-plot, fig.cap="GHG forecast to 2040 for three subsets of GHG emissions."}
ghg_forecast %>% 
  gather(-Year, key = "Sector", value = "tCO2") %>% 
  mutate(
    Sector = case_when(
      Sector == "transport" ~ "Commute Transportation",
      Sector == "amenity" ~ "Non-commute Transportation",
      Sector == "residential" ~ "Residential Building",
      TRUE ~ "Commercial Building"
    )
  ) %>% 
  ggplot(
    aes(
      x = Year,
      y = tCO2,
      fill = Sector
    )
  ) + 
  geom_area()
```

$~$

The general insight is that transportation emissions are expected to increase while building emissions are expected to decrease, such that transportation emissions is even greater relative to buiding emissions than it is today.

Many differences in inputs exist between this analysis and ICLEI's 2016 GHG Inventory, including the following:

- ICLEI's VMT data came from a source that was only available at the SJC level and was scaled down to Stockton by population, whereas our VMT data is based on the routed distance of LODES origin-destinations. The difference these methods results in is significant (2.5 billion vs. 1.5 billion annual VMTs) and should be investigated in further work. Our Transportation tCO2 number is only for passenger commuters, whereas ICLEI's number includes many other modes.
- ICLEI's electricity and gas data was obtained directly from PG&E, while ours was downloaded at the zip code level from their public data portal. Since our zip codes include many parcels outside of the Stockton city boundary, it's likely our consumption is for a larger population. As for commercial energy, ICLEI's commercial data was combined with industrial data, while ours is separated, so that could explain why our commercial consumption numbers our lower.

The assumptions built into these forecasts are necessarily simplistic given the scope of this analysis. In particular, linear trendlines should be refined into nonlinear functions given a better understanding of growth limits for each of the domains. It's also worth noting that some trends based on the past few years, like the desirable decline in building emissions, may be heavily influenced by active strategic policymaking, the kind which this report is meant to guide for the future. That means that "business-as-usual" is not necessarily "doing nothing" but "successfully continuing to implement progressive policies" (e.g. PG&E successfully meeting its aggressive decarbonization strategies).

# Overview of Green Economy Strategies

This chapter provides a survey of over fifty green economy strategies that have been implemented, or are being considered, in over eighty cities and regions across the U.S. and beyond. It is organized by overall strategy domain (with explanations for why the domain is chosen) and by specific strategy (where cities with similar examples as the primary case study are grouped together). In Appendix A, this list is re-organized by city or region. [See a matrix summary of the case studies here](https://docs.google.com/spreadsheets/d/1N5Z4KeE4ryFMpzMZZUkxq5P3sjj1ykJ30HubVaFKQ_Y/edit?ts=5e59003d#gid=0).

Given the focus of this body of research on Stockton's green economy strategies, we generally prioritized searching for city-level initiatives over state or federal level policies and private sector initiatives. Compared to the technical analysis elsewhere in this report, which focuses on the GHG footprints of building and transportation and job geography, the strategies in this overview span a broader range of "green" topics, including water and resilience.

The following chapter will revisit each strategy domain with a focus on specific strategies that can be technically evaluated using the quantitative approach that has been developed in Chapter 2, and that may be applicable to Stockton. While this deeper analysis cannot be applied to all the strategies researched in this chapter, we believe the handful that are detailed are good starting points for Stockton's green economy initiative in the 2020s.

## Building Utilization

Building Utilization refers to the amount of building space used per person throughout their daily activities. Specific types of building energy uses like heating and cooling are proportional to space use, and strategies to reduce the amount of space required per person, whether at home or at work, that do not sacrifice comfort can be effective ways to reduce emissions. However, the more profound impact of space efficiency is the densification of all urban activities, which may have an even greater emissions impact by reducing travel distances, as well as many potential social co-benefits. 

### Revise zoning codes in medium to large cities to facilitate upzoning

```{r img-missingmiddle}
include_graphics("images/missingmiddle.png")
```
<br>Illustration of missing middle housing achievable through upzoning. Source: [Missing Middle Housing](https://missingmiddlehousing.com/)

| Location | Oregon |
|:------|:-------------------------------------------------------------------|
| Details | HB 2001 legalizes the development of duplexes on residential land currently zoned for single-family housing in all communities of 10,000 or more. It also allows for the construction of three- to four-unit homes on single family-zoned land in cities of 25,000 or more. |
| Links | [Oregon Legislative Assembly](https://olis.leg.state.or.us/liz/2019R1/Downloads/MeasureDocument/HB2001/B-Engrossed) |
| Implementation Costs & Impact Factor | Besides legislative work, No implementation costs. Fiscally, [50% of Oregon households](https://www.oregon.gov/OHA/PH/ABOUT/Documents/indicators/rentburden.pdf) are rent burdened while [23%](https://nlihc.org/sites/default/files/SHP_OR.pdf) of renter households are extremely low income. These individuals will likely see the biggest impact. However, the law applies to cities of over 10,000. As of the 2010 Census, 2,208,732 Oregonians, which constitute 57.65% of the states population, live in such communities. |
| Scalable Potential | According to tax assessor records, over 65,000 parcels have detached single-family residences. It is not yet clear what the impact of upzoning change is on actual development in other cities over multiple years, but these parcels could be potential candidates for suburban infill development. |
| Similar | [Minneapolis 2040](https://minneapolis2040.com/)<br>[California SB50 (did not pass)](https://leginfo.legislature.ca.gov/faces/billTextClient.xhtml?bill_id=201920200SB50) |

### Eliminate minimum parking

```{r img-parking}
include_graphics("images/parking.png")
```
<br>Illustration of the impact of parking minimums on building design. Source: [Strong Towns](https://www.strongtowns.org/journal/2018/11/20/the-many-costs-of-too-much-parking)

| Location | Buffalo, NY |
|:------|:-------------------------------------------------------------------|
| Details | Developers are no longer required to build a certain number of parking spaces for commercial or residential projects, regardless of whether or not there are mass transit options nearby or if the tenants even need them. |
| Links | [Buffalo Green Code Land Use Plan](http://www.oneregionforward.org/plan/the-buffalo-green-code-draft-land-use-plan/) |
| Implementation Costs & Impact Factor | Besides legislative work, no implementation costs. 28% of land area in Buffalos city center is devoted to parking but only 63% of parking spaces are occupied on an average weekday. |
| Scalable Potential | According to [Stocktons zoning ordinance](http://qcode.us/codes/stockton/view.php?topic=16-3-16_64-16_64_040&frames=on), large shopping centers must build 1 parking space per 250 square feet of retail space. [Anecdotal evidence](https://stocktoncitylimits.com/2013/12/31/why-are-stocktons-parking-lots-so-big-and-empty/) suggests that this is too much space, even during peak hours. Similarly inefficient standards include that colleges and universities must have 1 parking space per classroom plus 0.75 spaces per student. |
| Similar | [Minneapolis 2040](https://minneapolis2040.com/)<br>[San Francisco, CA](https://usa.streetsblog.org/2018/12/17/san-francisco-eliminates-parking-minimums/)<br>[Hartford, CT](https://usa.streetsblog.org/2017/12/13/hartford-eliminates-parking-minimums-citywide/) |
 
### Encourage accessory dwelling units

```{r img-adu}
include_graphics("images/adu.png")
```
<br>Different types of ADUs. Source: [Housable](https://www.housable.com/)

| Location | California |
|:------|:-------------------------------------------------------------------|
| Details | The 2019 California state legislative cycle passed progressive accessory dwelling unit (ADU) laws that, among other changes, supercede local to allow ADUs to be built on every single family parcel. Counties and cities in the Bay Area are in the process of updating their local ADU ordinances as well as offering many proactive resources to encourage ADU development and streamline the permitting process. |
| Links | [San Mateo County, CA](https://secondunitcentersmc.org)<br>[Napa and Sonoma County, CA](https://napasonomaadu.org)<br>[San Jose, CA](https://www.sanjoseca.gov/business/development-services-permit-center/accessory-dwelling-units-adus) |
| Implementation Costs & Impact Factor | Besides legislative work, no implementation costs. Aggregating single unit detached and attached, California has over 8,400,000 units. |
| Scalable Potential | See Chapter 4. |
| Similar | [Seattle, WA](https://www.seattle.gov/Documents/Departments/Council/MAIN_ADU_FEIS_2018.pdf) |

### Encourage micro-units

```{r img-microunit}
include_graphics("images/microunit.jpg")
```
<br>Schematic of a microunit in SF. Source: [SF Gate](https://www.sfgate.com/realestate/article/Micro-apartments-next-for-S-F-3706648.php)

| Location | San Francisco, CA |
|:------|:-------------------------------------------------------------------|
| Details | In 2011, SFHAC worked with District 8 Supervisor Scott Wiener to pass legislation that allows for the construction of micro-units, also known as efficiency dwelling units. The legislation allows for units as small as 220 square feet comprised of 150 square feet of living space, plus a bathroom and kitchen. |
| Links | [San Francisco Planning](https://sfplanning.org/sites/default/files/documents/legis/code-summaries/120996_Cap_on_Efficiency_Dwelling_Units.pdf) |
| Implementation Costs & Impact Factor | Besides legislative work, no implementation costs. Assuming this will be in San Francisco and one will pay 30% of their income on the unit at the suggested price of \$1,400, this could impact 69.5% of San Francisco households. |
| Scalable Potential | Assuming the same development costs and that one will pay 30% of their income on the unit, then this could impact 48.68% of Stockton households. Assuming the same development costs and that one will not save 20% of their income (as recommended) but instead spends it on housing e.g. 50% of their income goes towards housing, then this could impact 62.3% of Stockton households. |
| Similar | [ShareNYC](https://www1.nyc.gov/site/hpd/about/projects-detail.page?project=ShareNYC)<br>[Vancouver, Canada](https://guidelines.vancouver.ca/D015.pdf) |

### Provide a density bonus for affordable housing

```{r img-densitybonus}
include_graphics("images/densitybonus.jpg")
```
<br>Illustration of a density bonus. Source: [City of North Vancouver](https://www.cnv.org/city-services/planning-and-policies/land-use/density-bonusing)

| Location | San Francisco, CA |
|:------|:-------------------------------------------------------------------|
| Details | The 100% Affordable Housing Bonus Program, passed in 2016, provides a 30-foot height bonus for housing developments that completely consist of affordable housing for low- or very low-income households. |
| Links | [HOME-SF](https://sfplanning.org/home-sf) |
| Implementation Costs & Impact Factor | Besides legislative work, no implementation costs. A poorly designed program can disincentivize development overall. Technically affordable housing is for those with the median income or below. For San Francisco, this would then apply to over 440,000 individuals. |
| Scalable Potential | There are currently over 150,000 individuals living below the median income in Stockton. |
| Similar | [Arlington, VA Affordable Housing Density Bonus Program](https://arlingtonva.s3.dualstack.us-east-1.amazonaws.com/wp-content/uploads/sites/38/2016/09/ACZOSection36.pdf) (Section H-7) |

### Develop a shared equity program for high-density housing 

```{r img-dospinos}
include_graphics("images/dos-pinos.png")
```
<br>Dos Pinos Housing Cooperative in Davis, CA. Source: [NBCA](https://ncbaclusa.coop/blog/this-california-housing-co-ops-ownership-model-could-create-affordable-housing-nationwide/)

| Location | Davis, CA |
|:------|:-------------------------------------------------------------------|
| Details | Shared equity housing is a model used by nonprofit housing associations and municipalities targeting first-time buyers, those with bad loan or credit history, and those who cant afford downpayments. Typically, a nonprofit or government entity provides a subsidy to lower the cost of purchase through shared appreciation loans, which are second mortgages provided by a public agency that buyers repay in full at the time of resale along with a percentage of home value appreciation. These funds are reinvested to make home ownership more affordable to another low-income buyer.<br><br>`r include_graphics("images/shared-equity.png")`<br>Mortgage vs. home price index. Source: [FRED](https://fred.stlouisfed.org/) |
| Links | [Urban Insitute](https://www.urban.org/research/publication/shared-equity-homeownership-evaluation-case-study-dos-pinos-housing-cooperative) |
| Implementation Costs & Impact Factor | The Davis cooperative is independently run. In San Francisco, the Mayor's Office BMR program subsidizes homes at about $250,000 below their appraised value. According to the [Urban Institute](https://www.urban.org/research/publication/sharing-equity-future-generations-evaluation-long-term-affordable-homeownership-programs-usa), homes that were passed between shared equity owners remained affordable over time, delinquency and foreclosure rates were low, and families who sold their homes were able to use the proceeds to purchase market-rate homes. |
| Scalable Potential | Stockton's Economic Devleopment Department or the Housing Authority of San Joaquin County could initiate such a program. |
| Similar | [San Francisco Citywide Inclusionary Affordable Housing Program](https://www.urban.org/research/publication/shared-equity-homeownership-evaluation-case-study-san-francisco-citywide-inclusionary-affordable-housing-program) |

### Match homeowners with vacant spaces with individuals looking for affordable housing

```{r img-hiphousing}
include_graphics("images/hiphousing.jpg")
```
<br>Source: [HIP Housing](https://hiphousing.org/)

| Location | San Mateo County, CA  |
|:------|:-------------------------------------------------------------------|
| Details | The San Mateo Home Sharing Program is funded by the Department of Housing. The program matches providers with seekers and must live in San Mateo County. They accept housing vouchers through the program. Most rents range from \$600 to \$1500. Some individuals participating in the program also participate in household chores as a way to pay their rent. |
| Links | [HIP Housing](https://housing.smcgov.org/sites/housing.smcgov.org/files/FAQS%20HomeSharing%202.2019.pdf) |
| Implementation Costs & Impact Factor | The program is run by nonprofit HIP Housing. The average length of stay is 3 years. Since the program's inception in 1979, 65,000 individuals have participated. |
| Scalable Potential | A similar nonprofit could organize in Stockton. |
| Similar | [Santa Clara County Housing Sharing Program, operated by Catholic Charities](https://www.catholiccharitiesscc.org/house-sharing) |

## Building Energy

This domain covers all strategies that reduce the amount of energy use in buildings, which tend to be concentrated in heating or cooling loads but also include lighting and other plug loads. This domain also includes localized power generation and storage, as well as electrification strategies that switch gas use to electricity use where the electricity grid has fewer emissions.

### Promote solar development in Opportunity Zones

```{r img-solar}
include_graphics("images/solar.jpg")
```
<br>Source: [PV Magazine](https://pv-magazine-usa.com/2019/05/06/clean-energy-in-opportunity-zones-an-interview-with-jon-bonanno/)

| Location |  Washington, DC |
|:------|:-------------------------------------------------------------------|
| Details | Use the tax benefits in Opportunity Zones to promote lower cost of capital and opportunities. This allows businesses to absorb tax benefits from Opportunity Zones, as well as those from financing solar projects. |
| Links | [O-Zones for Clean Energy](https://groundswell.org/o-zones-for-clean-energy/)<br>[Opportunity Zones Can Drive Development of U.S. Renewable Energy](https://www.forbes.com/sites/jamesellsmoor/2019/07/02/opportunity-zones-drive-development-of-us-renewable-energy/#692c32975609) |
| Implementation Costs & Impact Factor | Nationally, Opportunity Zone credits will cost [$1.6 billion](https://www.cbpp.org/research/federal-tax/potential-flaws-of-opportunity-zones-loom-as-do-risks-of-large-scale-tax) in lost tax revenue. [31.5 million people](https://eig.org/opportunityzones/facts-and-figures) live in Opportunity Zones. |
| Scalable Potential | Opportunity Zones exist within Stockton. |
| Similar | [Chart House Energy Opportunity Fund, Muskegon, MI](http://www.charthouseenergy.com/default.asp?iId=HILHG)<br>[Norfolk Solar Qualified Opportunity Fund](https://www.norfolksolar.org/programs) |

### Promote a Solar Renewable Energy Certificate program

```{r img-srec}
include_graphics("images/srec.jpg")
```
<br>Source: [Aurora Solar](https://blog.aurorasolar.com/financial-incentives-for-installing-solar/)

| Location |  Washington, DC |
|:------|:-------------------------------------------------------------------|
| Details | Solar Renewable Energy Certificates (SREC) show that a certain amount of electricity was produced using solar. SRECs can be sold back to utilities so they can meet sustainability requirements that are set by each state. This system is contingent on state-level sustainability requirements. |
| Links | [Solar United Neighbors](https://www.solarunitedneighbors.org/learn-the-issues/solar-incentives/solar-renewable-energy-credits-srecs/)<br>[Database of State Incentives for Renewables & Efficiency](https://programs.dsireusa.org/system/program/detail/5686) |
| Implementation Costs & Impact Factor | Depends on the energy market, but SRECs can go for as high as \$440 in Washington, DC or as low as \$7.50 in Ohio. |
| Scalable Potential | System exists in California. Solar construction can be a great source of high-paying local jobs. |
| Similar | [California Solar Initiative Rebates ](https://www.gosolarcalifornia.ca.gov/csi/rebates.php) |

### Set energy savings standards on all public buildings and provide financial and technical assistance for commercial private sector energy savings

```{r img-energystar}
include_graphics("images/energystar.png")
```
<br>Milwaukee utilizes ENERGY STAR Portfolio Manager to help buildings benchmark their performance and to track participant progress for awards. Source: [Better Buildings Challenge Milwaukee](https://city.milwaukee.gov/bbc/services/Benchmarking)

| Location | Milwaukee, WI |
|:------|:-------------------------------------------------------------------|
| Details | Using a five-pronged strategy, the City of Milwaukee has: (1) Established efficiency targets (20% reduction over a decade in participating buildings); (2) Offered incentives and financing through leveraging private capital to supply upfront funding for improvements and collects payments through a voluntary municipal special charge; (3) Set a 20% reduction target in government buildings; (4) Provides training to support building owner and occupant actions; and (5) Provided technical services to identify energy efficient equipment and train workforce to support building operations. |
| Links | [Better Buildings Challenge](https://city.milwaukee.gov/bbc) |
| Implementation Costs & Impact Factor | [Originally a $750,000 grant](https://city.milwaukee.gov/bbc/History), the [program](https://city.milwaukee.gov/bbc) has since affected 133 buildings, totaling 14,660,008 square feet, and led to $2,418,061 in annual savings. |
| Scalable Potential | See Chapter 4. |
| Similar | [San Jose, CA Energy and Water Building Performance Ordinance](https://www.sanjoseca.gov/your-government/departments-offices/environmental-services/climate-smart-san-jos/energy-and-water-building-performance-ordinance) |

### Create a fund to implement energy savings projects

```{r img-boston}
include_graphics("images/boston.png")
```
<br>Map of Renew Boston Trust projects. Source: [City of Boston](https://www.boston.gov/environment-and-energy/renew-boston-trust)

| Location | Boston, MA |
|:------|:-------------------------------------------------------------------|
| Details | In 2018, the City of Boston plans to launched Renew Boston Trust, which aims to use a market-based, self-funding model to increase energy efficiency investments and climate resiliency in its commercial and municipal buildings, nonprofit institutions, and multi-family properties. |
| Links | [Renew Boston Trust](https://www.boston.gov/environment-and-energy/renew-boston-trust) |
| Implementation Costs & Impact Factor | Phase Two involves more than \$40 million of energy conservation measures. Results are TBD. |
| Scalable Potential | Stockton's Department of Public Works could develop a similar initiative. |
| Similar | [New York City Energy Efficiency Corporation](https://www.nyceec.com/)<br>[London Green Fund](https://www.london.gov.uk/what-we-do/funding/european-regional-development-fund/london-green-fund)<br>[Sustainable Melbourne Fund](https://sustainableaustraliafund.com.au/)<br>[The Atmospheric Fund, Toronto](https://taf.ca/) |

### Enable property-assessed clean energy (PACE) financing

```{r img-pace}
include_graphics("images/pace.jpg")
```
<br>Source: [Solect Energy](https://solect.com/deep-dive-c-pace-solar-financing/)

| Location | Hartford, CT |
|:------|:-------------------------------------------------------------------|
| Details | A private company in Hartford operating a mixed-use housing and retail space privately financed a $1 million energy renovation project and paid back the loan through property tax reassessment. Greenworks Lending provided the upfront capital for rooftop solar, fuel cell energy storage, and installation of microgrid. The loan was repaid as a line item assessment of the property tax bill. |
| Links | [Better Buildings Initiative](https://betterbuildingsinitiative.energy.gov/implementation-models/commercial-pace-financing-microgrid-mixed-use-building) |
| Implementation Costs & Impact Factor | \$1 million; In Year 1, $316,927 savings |
| Scalable Potential | Stockton has [multiple existing PACE programs](http://www.stocktonca.gov/government/departments/econDev/eDevBusRes.html). |
| Similar | [GreenFinanceSF](https://sfenvironment.org/article/financing/greenfinancesf-commercial-pace-program)<br>[Los Angeles County PACE](http://pace.lacounty.gov/)<br>[Set the PACE St. Louis](http://setthepacestlouis.com/)<br>[Chicago PACE](https://www.chicagopace.org/)<br>[Arlington C-PACE](https://arlington-pace.us/)<br>[Milwaukee PACE](https://city.milwaukee.gov/bbc/services/PACE-Financing) |

### Provide consumer-oriented programs to incentivize energy efficiency retrofits and appliance improvements

```{r img-ladwp}
include_graphics("images/ladwp.png")
```
<br>Promotional graphics on website. Source: [LADWP](https://www.ladwp.com/ladwp/faces/ladwp/residential/r-savemoney/r-sm-rebatesandprograms?_adf.ctrl-state=twrhey9jv_17&_afrLoop=216411342287214)

| Location | Los Angeles, CA |
|:------|:-------------------------------------------------------------------|
| Details | The Los Angeles Department of Water & Power runs multiple energy efficiency programs in three broad categories. Mass market programs generally serve residential customers and encourage them to upgrade to energy efficient appliances, with a few exceptions. Commercial, industrial, and institutional (CII) programs generally serve large nonresidential customers and range in scope from simple lighting upgrades to entire building overhauls. Lastly, cross-cutting programs serve a wide variety of customer types and employ broad strategies for achieving energy savings (e.g., planting street trees, informing updates to building codes, customer outreach, etc.). |
| Links | [Economic Benefits of Energy Efficiency Programs: A Case Study of Investments by the Los Angeles Department of Water & Power](https://innovation.luskin.ucla.edu/wp-content/uploads/2019/03/Economic_Benefits_of_Energy_Efficiency_Programs.pdf) |
| Implementation Costs & Impact Factor | [See table](https://docs.google.com/spreadsheets/d/1qkdGbvYQW0-jtMELTW88zN5dObpmVcHQqJuyeIpI2Kg/edit?usp=sharing). |
| Scalable Potential | See Chapter 4. |
| Similar | [Austin Energy](https://savings.austinenergy.com/rebates/residential/offerings/home-improvements/weatherization/)<br>[100 Homes, 100 Days, Birmingham, AL](https://www.birminghamal.gov/2018/08/03/everything-you-need-to-know-about-the-100-homes-100-days-program/)<br>[HomeWise, Seattle, WA](http://www.seattle.gov/light/assistance/assistance.asp) |

### Provide incentives for households to install on-site batteries, particularly for vulnerable customers

```{r img-storage}
include_graphics("images/storage.png")
```
<br>Source: [Smart Energy](https://www.smart-energy.com/industry-sectors/smart-energy/two-states-drive-surge-in-residential-battery-storage-installations/)

| Location | California |
|:------|:-------------------------------------------------------------------|
| Details | Recent increases in wildfires and grid outages has meant that large swathes of California are at greater risk of losing power. As a result, the California Public Utilities Commission has launched the Self-Generation Incentive Program, which provides funding for low-income, medically vulnerable, and other select groups who live in Tier 2 and 3 "High Fire Threat Districts." |
| Links | [Green Tech Media](https://www.greentechmedia.com/articles/read/california-finalizes-plan-shifting-key-energy-storage-incentive-toward-blac) |
| Implementation Costs & Impact Factor | $613 million over four years. As of 2016, 2,178 projects have been completed representing 450 MW of capacity. |
| Scalable Potential | Unlikely given fire zone parameters, but incentives are still possible. |
| Similar | [Go Solar California](https://www.gosolarcalifornia.ca.gov/consumers/taxcredits.php)

### Implement "reach" codes which go beyond state minimum requirements for energy use in building design and construction

```{r img-reach}
include_graphics("images/reach.png")
```
<br>Source: [NRDC](https://www.nrdc.org/experts/pierre-delforge/san-joses-proposed-building-reach-code-explained)

| Location | San Jose, CA  |
|:------|:-------------------------------------------------------------------|
| Details | San Jose's reach code aims to make zero-emission electric buildings the default for San Jose. This would include low emission heating, additional charging infrastructure for electric vehicles, and photovoltaic cells on roofs. |
| Links | [National Resource Defense Council](https://www.nrdc.org/experts/pierre-delforge/san-joses-proposed-building-reach-code-explained) |
| Implementation Costs & Impact Factor | By [LEED standards]http://www.greenspacebuildings.com/wp-content/uploads/2011/05/Kats-Green-Buildings-Cost.pdf) (See Figure 3 in PDF), the cost is ten times less than the benefits. |
| Scalable Potential | Contingent upon content of codes |
| Similar | [Palo Alto, CA](https://cityofpaloalto.org/gov/depts/ds/green_building/2019_energy_reach_code_study.asp)

### Use waste to produce electricity

```{r img-bio}
include_graphics("images/bio.jpg")
```
<br>Anaeraboic digestion process. Source: [EESI](https://www.eesi.org/papers/view/fact-sheet-biogasconverting-waste-to-energy)

| Location | Hayward, CA  |
|:------|:-------------------------------------------------------------------|
| Details | Biogas uses methane and carbon dioxide and converts it into clean gas that can be piped straight into residential facilities for use. The facility involved in the treatment process is powered through the gas and excess electricity from the process is used at other City facilities. |
| Links | [City of Hayward](https://www.hayward-ca.gov/your-government/departments/utilities-environmental-services/co-generation-power) |
| Implementation Costs & Impact Factor | Depends on the scale of the project but by one estimate, the cost is about $4,500 per kilowatt generated for plants that generate more than 50 kilowatts. [See table](https://docs.google.com/spreadsheets/d/1fbfF7dC3xmJS6ZKPj3uAPPrH1lImfe8tbPda5vs0Dog/edit#gid=0). |
| Scalable Potential | Large agricultural industry proximal to Stockton could provide a steady supply of fuel. |
| Similar | [Glendale, CA](https://www.glendaleca.gov/government/departments/glendale-water-and-power/biogas-renewable-generation-project)

## Employment Growth

This domain covers strategies with the outcome of increasing the employment rate for the resident population, such as job training. While this strategy domain generally is not restricted to green strategies and can include employment strategies that provide broad economic benefits to Stockton, this report ultimately will focus on green jobs in particular. In addition, any strategies that increase employment opportunity and employment wages can increase the purchasing power of households, enabling them to invest in many of the other GHG reduction strategies considered in this report.

### Provide training and coaching for low-income workers, rather than unemployed workers
| Location | Dayton, OH |
|:------|:-------------------------------------------------------------------|
| Details | The Workforce Advancement and Support Center (WASC) offered participating workers intensive employment retention and advancement services, including career coaching and access to skills training. It also offered them easier access to work support, in an effort to increase their incomes in the short run and help stabilize their employment. The program was found to be most effective in cities with the lowest baseline of work support. |
| Links | [Strategies to Help Low-Wage Workers Advance](https://www.mdrc.org/sites/default/files/full_627.pdf) |
| Implementation Costs & Impact Factor | Based on a [New York City program](http://www.nyc.gov/html/sbs/downloads/pdf/presentation_wasc.pdf), start-up costs of \$615,000 plus three years of \$1.85 million each. [Bridgeport and Dayton](https://www.mdrc.org/sites/default/files/full_627.pdf) experienced 16% increased participation in education and training. Dayton experienced 8% increase in earnings by Year 3. |
| Scalable Potential | Stockton's Economic Development Department could operate a similar program. |
| Similar | San Diego, CA<br>Bridgeport, CT |

### Provide green-oriented job training and education pathways
| Location | Richmond, CA |
|:------|:-------------------------------------------------------------------|
| Details | The construction component of [Richmond BUILD's](http://www.ci.richmond.ca.us/1243/RichmondBUILD) main track is a pre-apprenticeship program. About 25% of the program's placements have been into formal building trades apprenticeship programs. Furthermore, after the completion of the 15-week training program, Richmond BUILD partners with employers to provide on-the-job training, funding half of graduates' wages for a probationary period of 12 weeks.|
| Links | [Making Green Work](https://ellabakercenter.org/sites/default/files/downloads/making-green-work.pdf) |
| Implementation Costs & Impact Factor | Richmond BUILD spends between \$5,000 and \$6,000 per student and yielded a 90% job placement rate (average starting wage rate at $15/hr). 30% of participants have a history with the legal system, and there are 35 available seats in each class. |
| Scalable Potential | See Chapter 4. |
| Similar | [CDTech Green Corps, Los Angeles, CA](http://www.cdtech.org/)<br>[East Los Angeles Skills Center](https://www.eastlaskillscenter.org/)<br>[Los Angeles Trade-Technical College](http://www.lattc.edu/)<br>[Oakland Green Jobs Corps](https://www.cypressmandela.org/)<br>[JobTrain, Menlo Park, CA](http://www.jobtrainworks.org/)<br>[Green Jobs Boston](https://sites.google.com/site/greenjobsboston/home)<br>[Win-Win, New York City, NY](https://www.nycservice.org/organizations/936) |

### Create a scholarship fund for students wishing to pursue eco-conscious careers
| Location | N/A |
|:------|:-------------------------------------------------------------------|
| Details | San Joaquin Delta Community College does not require that you have a GED or High School diploma to attend. However, if you do not have a GED/High School Diploma, you are not eligible for federally funded student aid. Tuition is $46.00 per unit, which may represent a barrier for some students. If a fund were created that did not require GED/High School Diploma eligibility for financial aid and was targeted towards those pursuing environmentally-oriented careers, then it would incentivize more to pursue those careers. |
| Links | [Low-Skill Workers Access to Quality Green Jobs](https://www.urban.org/sites/default/files/publication/32921/412096-Low-Skill-Workers-Access-to-Quality-Green-Jobs.PDF) |
| Implementation Costs & Impact Factor | Contingent upon demand for eco-conscious jobs |
| Scalable Potential | San Joaquin Delta College or Stockton Scholars could explore this idea. |

### Offer continued training and support post-employment
| Location | New York City, NY |
|:------|:-------------------------------------------------------------------|
| Details | WorkAdvance is a sector-based workforce development model that continues training and support post-employment. The developers of the program focused on sectors with strong demand for entry-level and middle-skill employees and relatively short training time. For this program, they focused on transportation & manufacturing, IT, environmental remediation, and healthcare. The program itself has five components including: (1) Intensive screening of program applicants for motivation and readiness; (2) Sector appropriate pre-employment and career readiness, including orientation to the sector and career advancement coaching; (3) Sector-specific occupational skills training aligned with employer needs and leading to certifications that are in demand in the regional labor market; (4) Sector-specific job development and placement services based on strong relationships with employers; and (5) Post-employment retention and advancement services, including ongoing contact, coaching, skills training, and rapid reemployment help if needed. |
| Links | [MRDC Policy Brief](https://www.mdrc.org/sites/default/files/WorkAdvance_2016_PolicyBrief.pdf) |
| Implementation Costs & Impact Factor | [See table](https://docs.google.com/spreadsheets/d/1a3yOtNb3r3SD4LnSfBDs70Mre4OpmGM53iFZc9dxMkc/edit#gid=0). |
| Scalable Potential | According to the 2013-2017 ACS, the number of Stockton residents that are high school graduates and possess a GED or have less than a high school education is over 75,000. |
| Similar | [Towards Employment, Cleveland, OH](https://www.towardsemployment.org/)<br>[Madison Strategies Group, Tulsa, OK](http://www.madisonstrategies.org/) |

## Local Jobs

This domain includes strategies with the outcome of increasing the number of jobs based in Stockton. This is distinct from the previous section because local job creation may be attracting companies and workers who aren't necessarily Stockton residents, so as to increase the jobs to employed residents ratio.

### Offer job creation tax credit
| Location | Philadelphia, PA |
|:------|:-------------------------------------------------------------------|
| Details | Philadelphia's Job Creation Tax Credit rewards businesses that increase the number of jobs available in the City. A business firm can apply this credit to its Business Income and Receipts Tax (BIRT) liability if it either creates 25 new jobs or increases its number of employees by at least 20% within five years of the designated start date. Program participants must commit to maintaining business operations in the City of Philadelphia for five years. The credit amount for jobs created is 2% of annual wages paid for each new job or $5,000 per new job created, whichever is higher, subject to the maximum amount specified in the commitment agreement. |
| Links | [City of Philadelphia](https://www.phila.gov/services/payments-assistance-taxes/tax-credits/job-creation-tax-credit/)<br>[NCSL](https://www.ncsl.org/research/financial-services-and-commerce/job-creation-tax-credits.aspx#California) |
| Implementation Costs & Impact Factor | Cost depends on the size of tax credit expansion. [Estimates](https://digitalcommons.ilr.cornell.edu/cgi/viewcontent.cgi?article=1356&context=cahrswp) suggest that the tax credit creates between 0.13 and 0.3 new jobs at participating firms, primarily for workers 25 and younger. Many of these workers, however, would have been hired without the credit. It is likely that as firm size grows, economies of scale will allow job creation to increase exponentially as the marginal cost of adding an additional employee decreases. |
| Scalable Potential | In California, taxpayers with 20 or fewer employees at the end of the preceding taxable year may qualify for a nonrefundable new jobs credit against the personal income tax and corporation franchise and income taxes for each new qualified employee that is hired. It is equal to \$3,000 for each net increase in qualified full-time employees from the previous taxable year. It is only applicable to firms with 20 or fewer employees (see Sec. 23623, California Rev. & Tax. Code). There have been several proposals for implementing a similar system with local corporate taxes. As of 2018, the [Stockton-Lodi MSA](https://www.labormarketinfo.edd.ca.gov/LMID/Size_of_Business_Data.html) has 2132 business with other 20 employees, 159,052 employees in those businesses, and payrolls equal to $1,830,930,000. |
| Similar | [Columbus, OH](https://www.columbus.gov/development/economic-development/Business-Attraction---Expansion/) |

### Encourage mortgage refinancing
| Location | San Francisco, CA |
|:------|:-------------------------------------------------------------------|
| Details | Mortgage refinancing encourages consumers to take out a new loan to take advantage of lower interest rates. This creates a wealth effect whereby they develop greater disposable income. From a Keynesian perspective, this leads to more consumer spending in the local economy. The corollary to this is that growth in aggregate demand leads to job growth, or at least stability. HUD has a class on First-Time Homebuyer Education and Counseling. |
| Links | [Regional Heterogeneity and the Refinancing Channel of Monetary Policy](http://economics.mit.edu/files/15731)<br>[Low Interest Rates Boost Household Consumption](https://voxeu.org/article/low-interest-rates-can-boost-households-consumption)<br>[San Francisco Mayor's Office of Housing and Community Development](https://sfmohcd.org/refinancing) |
| Implementation Costs & Impact Factor | N/A |
| Impact Factor | [See results](https://docs.google.com/document/d/1OCGHkK8pjBE9zpFcQugDnIXFsLAYPNk7v2rsQ-A_Nj8/edit) for a HUD first-time home buyer program. |
| Scalable Potential | According to [Zillow](https://www.zillow.com/stockton-ca/home-values/), 1.1% of Stockton homes are delinquent on their mortgages while 6.6% of homes have negative equity. |
| Similar | [Dublin, CA](https://dublin.ca.gov/470/Refinancing)<br>[Chicago Department of Housing](https://www.chicago.gov/city/en/depts/doh/provdrs/homeowners/svcs/refinancing-of-affordable-units.html) |

### Develop public employment program
| Location | San Francisco, CA |
|:------|:-------------------------------------------------------------------|
| Details | A public employment program places unemployed, willing-to-work, workers in in-demand jobs across the community. In post-Keynesian thought, the job creation element of a public employment program is two-fold. On one hand, you are giving participants a job. On the other hand, their increase in discretionary income leads to greater aggregate spending and by extension, an increase demand for employment in sectors where money is being spent. Additionally, due to macroeconomic overemployment, it is important to target such a program to those who experience structural unemployment, not frictional. |
| Links | [JobsNOW!, San Francisco Human Services Agency](https://www.sfhsa.org/services/jobs-money/jobsnow)<br>[General Equilibrium Effects of (Improving) Public Employment Programs: Experimental Evidence](https://www.nber.org/papers/w23838.pdf)<br>[Labor Market Considerations for a National Job Guarantee](https://www.brookings.edu/wp-content/uploads/2018/12/JobGuarantee_FP_web_20190206.pdf) |
| Implementation Costs & Impact Factor | [See table](https://docs.google.com/spreadsheets/d/1wRfHpgLv4xkIYSVeNFy-1X3LqU5UAzVUOMWzD9nOe30/edit). Assuming that there wouldn't be a resulting increase in labor force participation (unlikely), this could impact about 18,000 individuals. Keep in mind that this would mean exceeding full employment. |
| Scalable Potential | According to CAP data, the ratio of children under 5 to available childcare slots in Stockton is 6.5. This would necessitate growth in the childcare industry. The Old Age Dependency ratio is 20.3, suggesting that the demand for healthcare services will rise in Stockton, even though there is a statewide shortage of healthcare workers. Most theorized public employment programs, particularly those that occur on a federal level, do mention the importance of building/rebuilding infrastructure. |
| Similar | [RecycleForce, Indianapolis](https://www.brightmarkenergy.com/recycleforce) |

### Provide tax credits to investors in advanced industries
| Location | Nebraska |
|:------|:-------------------------------------------------------------------|
| Details | By making these credits refundable, the State of Nebraska Angel Investment Tax Credit has effectively subsidized the angel investment. If a qualified investor makes a qualified investment of \$100,000 in a Nebraska start-up company, and receives Nebraskas 40% angel investment credit, that investor would receive \$40,000 in cash (in reduced taxes or direct payment) from the state. |
| Links | [Tax Credit Program Report](https://nebraskalegislature.gov/FloorDocs/105/PDF/Agencies/Economic_Development__Department_of/161_20171114-090352.pdf) |
| Implementation Costs & Impact Factor | Between 2011 and 2016,<br>Investments: \$54,884,750<br>Investments (#): 614<br>Investment (mean): \$89,389<br>Credits: \$19,156,848<br>Credits: 614<br>Credits (mean): \$31,200<br>Note certain businesses received multiple credits. Of the 50 businesses that responded to the follow-up survey, 35 reported that they created new jobs, 12 reported they did not, and 3 did not respond. The average number of new jobs created was 11.5. |
| Scalable Potential | Stockton has over 15,000 businesses with 19 employees or fewer, that employ a total of 55,000 individuals. They are broken down by industry as seen [here](https://docs.google.com/spreadsheets/d/15RHLcStF8-YZpp1lp8KHChaGXvK9weAGsgg8MktYK8Q/edit#gid=2038112866). |
| Similar | [Colorado Advanced Industry Investment Tax Credit](https://choosecolorado.com/doing-business/incentives-financing/advanced-industry-investment-tax-credit/) |

### Provide tax credits to investors in community development corporations
| Location | Pennsylvania |
|:------|:-------------------------------------------------------------------|
| Details | The program is broken down into four other subparts: The Neighborhood Partnership Program, Special Priorities Program, Charitable Food Program and the Enterprise Zone Tax Credit. Neighborhood organizations must apply to the program by documenting that they have the capacity to complete the proposed project, confirm their collaborations, demonstrate the need for the project and provide required documentation. Eligible projects must serve distressed areas or support neighborhood conservation in a number of focus areas within community development. Any businesses in the state are then eligible to donate to an eligible project and receive up to a 55% tax credit.  |
| Links | [Neighborhood Assistance Program](https://dced.pa.gov/programs/neighborhood-assistance-program-nap/) |
| Implementation Costs & Impact Factor | Thirty-six million in tax credits is budgeted each year for Neighborhood Assistance Program. According to [this article](http://cedamichigan.org/2019/05/community-investment-tax-credit-programs-catalysts-for-locally-driven-solutions/), in the Lawrenceville neighborhood of Pittsburgh, NAP helped facilitate 36 new neighborhood businesses in two years, development of 120 new housing units worth \$30 million, development of 45,000 square feet of commercial space worth \$9 million, and an average \$2,900 in real estate tax revenue on previously vacant parcels. |
| Scalable Potential | The [Reinvent South Stockton Coalition](https://rsscoalition.org/) is an example of a local CDC that can be supported by such a program. |
| Similar | [Massachusetts Community Investment Tax Credit](https://macdc.org/how-it-works) |

### Pursue public-private partnerships for commercial development
| Location | Georgia |
|:------|:-------------------------------------------------------------------|
| Details | Georgia partnered with Kia to develop a manufacturing plant that suited the needs of the company. No appropriate size plot existed so, Georgia purchased multiple adjacent plots near deepwater ports and leased them to Kia at a low sum. Quick Start, Georgia's innovative workforce training and development program, developed a specific program just for the needs of Kia. |
| Links | [Georgia's Successful Partnership with Kia Serves as Model for Efficiency and Job Growth](https://www.georgia.org/sites/default/files/wp-uploads/2014/08/Kia_Case_Study_Final.pdf) |
| Implementation Costs & Impact Factor | \$9,000,000-$15,000,000 in Job Tax Credits; \$80,700,000 in Department of Transportation capital projects; Direct creation of 3000+ jobs |
| Scalable Potential | Stockton brownfields could be valuable opportunities for large capital projects or commercial development, combining private investment and public facilitation of brownfield remediation. |
| Similar | [Prince George's County Maryland Clean Water Partnership](https://www.epa.gov/G3/prince-georges-county-maryland-clean-water-partnership)<br>[Mission Bay, San Francisco](https://www.mbaydevelopment.com/mission-bay-new) |

### Fund economic development using tax-base sharing
| Location | Montgomery County, OH |
|:------|:-------------------------------------------------------------------|
| Details | The Economic Development and Government Equity Program (ED/GE) serves as a tool to make the County more competitive and enhance cooperation among local jurisdictions. The ED/GE program consists of two parts. The ED side consists of grant funding generated by sales tax revenue. The GE side is a tax-based sharing formula that calculates disbursements based on income and property tax valuations. |
| Links | [How Montgomery County ED/GE funding drives economic development](https://www.bizjournals.com/dayton/news/2019/02/11/how-montgomery-countyed-ge-funding-drives-economic.html) |
| Implementation Costs & Impact Factor | \$1.8 million in funding over 10 economic development projects in 2018. Since its [inception](https://www.mcohio.org/news_detail_T6_R154.php) in 1992, the program has assisted in the creation of 24,000 private sector jobs and retained over 30,000 private sector jobs through \$2.8 billion in leveraged investment. Impact estimated at 900 new jobs throughout the County. |
| Scalable Potential | A [USC study](https://socialinnovation.usc.edu/wp-content/uploads/2017/09/Orfield-Tax-Base-Sharing-Final.pdf) simulating a tax-based sharing program in the Los Angeles region assumed that 40 percent of the growth in local sales tax bases from each local area in the metropolitan area between 2003 and 2013 was allocated to a regional pool. The pool was then distributed back to localities based on their shares of the regions population. Local sales tax base disparities are so dramatic that even this relatively benign distribution formula would result in increases in the local tax bases of communities serving fully 72 percent of the regions population. |
| Similar | [Twin Cities Fiscal Disparities Program](https://ilsr.org/rule/tax-base-sharing/2301-2/)<br>[Sacramento AB 680](https://ilsr.org/rule/tax-base-sharing/2302-2/) |

### Pay remote workers to move to new location
| Location | Vermont |
|:------|:-------------------------------------------------------------------|
| Details | This program offers up to $10,000 a year that can be spent on office supplies, coworking space, relocation, and housing for remote workers to move to Vermont. It also comes with various in-kind benefits. |
| Links | [Think Vermont](https://www.thinkvermont.com/remote-worker-grant-program-2019/)<br>[Stay to Stay](https://www.vermontvacation.com/staytostay) |
| Implementation Costs & Impact Factor | Between January 1 and September 15, 2019, ACCD awarded \$320,834 to 84 new Vermont remote workers. Grants ranged from $400 to \$5,000; the average grant awarded was \$3,819. As of September 15, 2019, the grant application was downloaded 4,201 times. Grantees brought with them an additional 134 family members (including 44 children), for a total of 218 new Vermonters. The top fields of employment represented by grantees were information technology (31%), management (13%), writing and editing (8%), finance and sales (both tied at 6%), and marketing (5%). Other fields represented included insurance, education, project management, and law. Vermont co-working space memberships were purchased by fourteen grantees and six additional grantees indicated they are considering doing so. [Read more here](https://accd.vermont.gov/sites/accdnew/files/documents/DED/Remoteworker/2019RemoteWorkerReport.pdf). |
| Scalable Potential | Stockton's Economic Development Department could develop a similar program to attract remote workers from the Bay Area. Proximity to Silicon Valley may facilitate the networking effects that draw people to the region. Solutions have included [investments](https://www.nber.org/papers/w25913) targeting issues that are unique to Stockton e.g. healthcare access, educational outcomes. There are additional local investments for immigrants on H1B visas. |
| Similar | [Montana House Bill 405](https://montanafreepress.org/2019/03/08/kansas-and-vermont-pay-college-grads-to-move-to-small-towns-montana-could-follow-suit/)<br>[Kansas Rural Opportunity Zone Program](https://www.kansascommerce.gov/wp-content/uploads/2018/12/ROZ-program-guidelines-FY19_201810080934581436.pdf) |

## Vehicle Miles Traveled

This domain includes transportation-oriented strategies that lead to fewer vehicle miles traveled, such as public transit improvements, transportation demand management, and carpooling incentives. Electrification of vehicles is considered as a separate domain. Land use strategies that reduce sprawl are also part of this domain.

### Create local transportation demand management ordinances
| Location | Pasadena, CA |
|:------|:-------------------------------------------------------------------|
| Details | Transportation Demand Management can include a variety of ordinances designed to reduce traffic congestion, increase safety and mobility, and conserve energy and reducing greenhouse gases. The Pasadena TDM focuses on encouraging alternative modes of transportation, such as transit, vanpools, carpools, and bicycles, as well as encouraging alternative work hours to reduce typical peak period demands upon the roadway network. The Trip Reduction Ordinance requires preferential parking spaces for carpool vehicles, providing employees with commuter-matching services and trip reduction information, and providing bicycle parking facilities and/or other non-auto enhancements. |
| Links | [LA Metro](https://www.metro.net/projects/tod-toolkit/tdm-ordinance/) |
| Implementation Costs & Impact Factor | Besides legislative work, no implementation costs. In 2014, 40 projects were subject to the City of Cambridge's Parking and TDM Ordinance Large Project TDM Plans. Of those, 35 projects, or 88 percent completed monitoring reports. Of the 35 projects, 30 projects exceeded non-drive-alone mode split commitments. [Read more here](https://default.sfplanning.org/transportation/tdm/TDM_Technical_Justification_update2018.pdf) (Table 3-3). |
| Scalable Potential | Because Stockton has a low jobs to employed residents ratio, TDM is a less impactful strategy without the support of big employers of Stockton residents outside of the city. |
| Similar | [Downtown Berkeley Parking and Transportation Demand Management](https://www.cityofberkeley.info/Public_Works/Transportation/Downtown_Berkeley_Parking_and_Transportation_Demand_Management_Report.aspx)<br>[SF Planning](https://sfplanning.org/transportation-demand-management-program) |

### Redesign bus network to prioritize ridership over coverage
| Location | Houston, TX |
|:------|:-------------------------------------------------------------------|
| Details | After an extensive community engagement process, the METRO Board of Directors directed the System Reimagining team to design a network where 80% of resources are aimed at maximum ridership and 20% of resources are used for coverage (compared to about 50%-50% today). The result is a simpler, easier to understand network that better aligns with the Houston of today. At all times, the plan strives to keep service to as many existing riders as possible. |
| Links | [Houston METRO Transit Systems Reimagining Project](https://www.ridemetro.org/Pages/Reimagining-FAQs.aspx) |
| Implementation Costs & Impact Factor | The draft plan presented here is a no-growth network plan, which means it is designed to use existing METRO operating funds. The plan reallocates existing service rather than imagining new resources. Thats why the plan doesnt always offer as much service as METRO or its customers would like. Nearly all (94%) current riders will be able to access service at the same stop they do now. The vast majority of current riders (72% up from 49.5% on weekdays and 25% on weekends) will be on or near frequent service that is useful for travel to more places than they can reach easily now. Even if you are already on a frequent line, the plan makes it much easier to transfer to other lines to get to more places. 99.5% of existing riders will have local bus service within 1/4 mile. The small percentage that will be farther from service either live or travel in areas where the pattern of development and the street network make it impossible to run transit efficiently, and as a result they could only be served at a very high cost per rider. About 0.6% of existing riders will have flexible service rather than fixed route service. This service will provide hourly pickups and dropoffs within its defined zone and to reach a point where you can connect to fixed route service. Riders can call ahead to reserve a ride on the service or meet the bus at a designated location and time. Some fixed routes will still run in these zones, but the flexible service will fill in the gaps for those who might find it difficult to walk to a bus stop. |
| Scalable Potential | San Joaquin RTD is still recovering from budget cuts, but can consider a bus network redesign that is budget-neutral and maximizes ridership. |
| Similar | [IndyGo](https://www.indygo.net/projects/)<br>[Austin Capital Metro Connections 2025](https://capmetro.org/connections2025/)<br>[Central Ohio Transit Authority](https://www.cota.com/initiatives/tsr/) |

### Use BRT corridors to reduce travel times on public transit
| Location | San Francisco, CA |
|:------|:-------------------------------------------------------------------|
| Details | Bus rapid transit is a system that allocates designated lanes to buses and light rail, in order to make for faster travel on bus. Additionally, off-board fare collection is key to reduce delay caused by passengers waiting to pay on board. |
| Links | [San Francisco Van Ness Improvement Project](https://www.sfcta.org/projects/van-ness-improvement-project)<br>[Institute for Transportation & Development Policy](https://www.itdp.org/library/standards-and-guides/the-bus-rapid-transit-standard/what-is-brt/) |
| Implementation Costs & Impact Factor | [RTD has planned](http://sanjoaquinrtd.com/wp-content/uploads/2019/02/SRTP-2018-Update_FINAL.pdf) for about $30 million of BRT service expansion between 2019-2026. When fully deployed, RTD's BRT routes will create a high-frequency network covering the major arterials of the County, connecting them with central Stockton. RTD projects almost 3.7 million annual trips on the BRT network by FY 25. By attracting new riders, RTD's BRT network can eliminate over one million tons of carbon emissions. |
| Scalable Potential | BRT service is currently planned for a range of corridors throughout the City of Stockton, with potential service extension to Lodi via BRT Express. RTD will implement BRT Express service over time as funding becomes available and as demand grows due to new development. Therefore, BRT design may differ by corridor but should follow a set of requirements to ensure system characteristics remain consistent. Figure below from RTD 2018 Short Range Transit Plan.<br><br>`r knitr::include_graphics("images/brt.png")` |
| Similar | [Bogota TransMilenio, Mexico City Metrobus, Johannesburg BRT](https://docs.google.com/spreadsheets/d/1JixMHuX0ArT3MDNrJgYliGE77TqYZe5bGwms8D6oblE/edit#gid=0) |

### Promote the use of e-scooters and dockless bicycles to reduce reliance on private cars
| Location | San Francisco, CA |
|:------|:-------------------------------------------------------------------|
| Details | Shared scooters and bikes, which can be used in dedicated bike lanes, have already become a major source of transportation in large metropolitan areas. Bird had 10 million rides in its first 12 months alone, while Lime users took 34 million trips in its first year. Additionally, they are more conducive to the short trips made by most commuters. |
| Links | [Deloitte Insights](https://www2.deloitte.com/us/en/insights/focus/future-of-mobility/micro-mobility-is-the-future-of-urban-transportation.html) |
| Implementation Costs & Impact Factor | Costs average at $100 per scooter. Impact [depends](https://www.vox.com/2018/8/27/17676670/electric-scooter-rental-bird-lime-skip-spin-cities) on where the city gets its energy from e.g. coal, natural gas, or renewable. The majority of scooter trips are less than 2 miles, which may mean that they are not a substitute for ride apps. They do, however, serve to reduce traffic congestion as 60% of car trips fell within the micromobility range of [0-5 miles](https://www.forbes.com/sites/adeyemiajao/2019/02/01/everything-you-want-to-know-about-scooters-and-micro-mobility/). |
| Scalable Potential | Stockton's urban core may not yet experience the congestion issues that create an opportunity for micromobility. |
| Similar | [Pittsburgh Mobility Collective](https://pittsburghpa.gov/press-releases/press-releases.html?id=3152)<br>[Tacoma, WA](https://www.cityoftacoma.org/cms/one.aspx?pageId=158101)<br>[Washington, DC](https://ddot.dc.gov/page/micromobility-district) |

### Rezone areas around transit stations and commercial corridors to allow for high-density residential development
| Location | Tyson, VA |
|:------|:-------------------------------------------------------------------|
| Details | This plan increased the permissible floor area ratio from 2.0 to 5.0 while also providing incentives to reserve 20% of new residential units for affordable and workforce housing (residents earning between 50% and 120% of area median income). City officials hope that this will also help to facilitate the use of public transit due to close proximity to stations. |
| Links | [Tyson Comprehensive Land Use Plan](https://www.fairfaxcounty.gov/tysons/tysons-comprehensive-plan-land-use-transit-oriented-development) |
| Implementation Costs & Impact Factor | Besides legislative work, no implementation costs. Planned to attract 80,000 new residents and 200,000 jobs. |
| Scalable Potential | Stockton recently updated its General Plan, Envision Stockton 2040, but the next cycle is likely to begin in 2021. |
| Similar | [Minneapolis 2040](https://minneapolis2040.com/) |

### Offset negative externalities of traffic through tolls 
| Location | New York City, NY |
|:------|:-------------------------------------------------------------------|
| Details | New York placed tolls in two locations that are typically congested. 80% of the funds from tolling will go to capital projects while 20% goes towards the public transit system. Drivers can only be tolled once per day. Additionally, toll exemptions are made for emergency vehicles, drivers with disabilities, and those who make under $60,000 per year. The goal of the program is to reduce congestion by encouraging the use of carpooling and public transit. |
| Links | [NY Times](https://www.nytimes.com/2019/04/24/nyregion/what-is-congestion-pricing.html) |
| Implementation Costs & Impact Factor | Mayor Bloomberg's [2008 proposal](https://web.archive.org/web/20080305132512/http://www.transalt.org/campaigns/congestion), based on an \$8 charge for entering Manhattan south of 86th Street, place dannual revenue from the charge at roughly \$400 million in the first year and up to \$900 million by 2030. When a congestion charge is implemented, a small but significant number of motorists alter the time of their commute to avoid the charge, or adopt a more efficient means of transportation such as walking, bicycling or mass transit. This relatively small decrease in traffic leads to an enormous reduction in delays and congestion. Mayor Bloomberg's proposal anticipated a 6.5% reduction in the number of vehicles entering Manhattan south of 86th Street, and an even more dramatic during peak hours when an 11% traffic reduction would result in a 20-40% reduction in time loss to traffic delays. |
| Scalable Potential | Because Stockton is not currently a concentrated job center, congestion on local roads is not a significant issue. |
| Similar | [Seattle Department of Transportation](https://www.seattle.gov/Documents/Departments/SDOT/About/SeattleCongestionPricingStudy_SummaryReport_20190520.pdf)<br>[Stockholm, Sweden](https://docs.google.com/spreadsheets/d/1wfzrP3pYT7yDMCnIthztelqYMdhkURePtL_N114HtIw/edit#gid=0) |

### Charge for parking
| Location | New York City, NY |
|:------|:-------------------------------------------------------------------|
| Details | Cities that charge for parking have realized an increase in the use of public transit for commuting (r-squared of .83) and a reduction in commuting alone. This is made more effective when they eliminate zoning requirements about parking and change the cost of parking over the day. In New York, sensors have allowed the tracking of parking spaces, bringing vehicles directly to open parking spaces, rather than having them drive around looking for a spot. |
| Links | [What the Price of Parking Shows Us About Cities](https://usa.streetsblog.org/2016/10/24/what-the-price-of-parking-shows-us-about-cities/) |
| Implementation Costs & Impact Factor | Over the course of the SFpark pilot project, the SFMTA lowered the average hourly rate at meters by 11 cents from \$2.69 to \$2.58 and average hourly rates at SFpark garages by 42 cents from \$3.45 to \$3.03. The amount of time that spots achieved the target parking occupancy (60 to 80 percent) increased by 31 percent in pilot areas, compared to a 6 percent increase in control areas. [Read more here](http://sfpark.org/wp-content/uploads/2014/06/SFpark_Eval_Summary_2014.pdf). |
| Scalable Potential | Because Stockton is not currently a concentrated job center, parking congestion is not a significant issue. However, demand-response parking pricing can be explored in Downtown. |
| Similar | [SFpark](http://sfpark.org/) |

### Give carpoolers priority parking at transit stops
| Location | King County, WA |
|:------|:-------------------------------------------------------------------|
| Details | At all light rail stations, commuters who drive together are able to park for free at Sound Transit priority parking. Drivers must arrive with at least two other riders to be eligible and half the spaces at each parking location are dedicated to carpoolers. |
| Links | [Carpoolers will get edge for Sound Transit parking -- for a price](https://www.thenewstribune.com/news/local/traffic/article101595332.html) |
| Implementation Costs & Impact Factor | 5 Year Budget, including permitting, towing, and administration of program with outside vendor, costs $3 million. No evaluation results could be found. |
| Scalable Potential | Contingent upon RTD use. Carpooling incentives can be targeted towards commuters to transit-accessible destinations. |
| Similar | [Stanford Commute Club](https://transportation.stanford.edu/rideshare/learn-about-carpooling/start-a-carpool)<br>[Portland Carpool Program](https://www.portlandoregon.gov/TRANSPORTATION/article/725534) |

### Ban personal vehicles from certain areas
| Location | Madrid, Spain |
|:------|:-------------------------------------------------------------------|
| Details | Madrid 360 has made 472 hectares of the city center off-limits to traffic, except for local residents and public transit. Non-residents with appropriate labels may enter to leave their vehicle in a public parking lot, and exceptions are made for people with reduced mobility, ambulances, taxis, private-hire cars, and delivery vans. Electric vehicles will also be allowed into the city center. |
| Links | [Madrid takes historic step to becoming a car-free city center](https://elpais.com/elpais/2018/11/30/inenglish/1543565577_207058.html) |
| Implementation Costs & Impact Factor | Pedestrian space has increased by nearly 22,000 square meters. It has cut traffic by 32 percent in some areas. Those who violated the ban were fined $100. |
| Scalable Potential | Anecdotally, many of the cities that have implemented car bans seem to have greater pedestrian traffic and less sprawl/more centralized downtown. Stockton does not yet have a vibrant pedestrian downtown core that would merit this strategy. |
| Similar | [Better Market Street SF](https://www.sfmta.com/projects/better-market-street-project)<br>[Paris, France](https://www.independent.co.uk/travel/news-and-advice/paris-car-free-sundays-city-centre-france-pedestrian-a8566991.html) |
 
### Encourage carsharing strategies
| Location | San Francisco Bay Area, CA |
|:------|:-------------------------------------------------------------------|
| Details | On June 13, 2018 the Metropolitan Transportation Commission (MTC, the Bay Areas transportation planning, financing, and coordinating agency) allocated $1.2 million under the Climate Initiatives Program to implement the strategies recommended in the attached report; Bay Area Carsharing Implementation Strategy, completed in Spring 2018. The Carsharing Implementation Strategy documents were outlined in a report to MTCs Board which reviews the development and current state of carsharing in the Bay Area, explores regional challenges and opportunities as they apply to various carsharing business models (round-trip, one-way, and peer-to-peer), presents findings from interviews and workshops with stakeholders in the region, and provides specific strategies to support the expansion of carsharing. The Carsharing Strategy is intended to identify opportunities to grow carsharing membership and usage in the Bay Area as a method of reducing single-occupancy vehicle trips and vehicles miles traveled, with the overall goal of reducing greenhouse gases. |
| Links | [Bay Area Carsharing Implementation Strategy](https://learn.sharedusemobilitycenter.org/wp-content/uploads/MTC-carsharing_report_vfinal_06.21.18.pdf) |
| Implementation Costs & Impact Factor | This plan will be integrated with relevant local transit authorities e.g. BART, Caltrain, Muni, et cetera. As such, payment kiosks will be located at respective centers. See Table 1 in MTC report.  |
| Scalable Potential | Stocktons [intra-county workforce](https://www.pacific.edu/Documents/school-business/BFC/NSJV%20Reg%20Assessment/NSJV%20Commuting%20Patterns%20v2.pdf) has declined from 92.4% in 1980 to 83.1% in 2010. This means that people are traveling longer to get to work, suggesting greater benefits to such a program. |
| Similar | [Boston Fleethub](https://www.zipcar.com/press/releases/zipcar-launches-new-boston-fleethub-program) |

### Provide free public transit
| Location | Kansas City, MO |
|:------|:-------------------------------------------------------------------|
| Details | Kansas City, Missouri, will be the first major US city to offer free bus service to residents by 2020. City Council members in a metropolis of about 490,000 people, voted unanimously in early December 2019. The council still needs to decide how the system will be funded and where that money will come from in the budget. |
| Links | [Vox](https://www.vox.com/the-goods/2019/12/17/21026425/kansas-city-free-bus-system) |
| Implementation Costs & Impact Factor | The Kansas City Council already expects to spend about \$8 to \$9 million to cover for the lost fares, as mentioned, but the city already loses \$1.5 million collecting fares every year, according to Mayor Lucas. The impact on ridership is yet to be determined. |
| Scalable Potential | Free transit could be feasible in Stockton given the relatively low transit ridership numbers for RTD compared to high-density cities. It's unclear how the loss in revenues would affect service quality and ridership. In Dunkirk, France, a similar program was implemented with the following results: Passengers were up 50-85%, depending on the route, and Aaverage trip length dropped by 10%. |
| Similar | [Luxembourg](https://www.bbc.com/worklife/article/20190128-the-cost-of-luxembourgs-free-public-transport-plan)<br>[Estonia](https://www.economist.com/europe/2019/05/09/free-public-transport-in-estonia) |

### Subsidize first-mile/last-mile transportation services
| Location | Centennial, CO |
|:------|:-------------------------------------------------------------------|
| Details | The First and Last Mile Pilot (FLMP) was a public-private partnership between the City of Centennial, CH2M, the Denver South Transportation Management Association (DSTMA), Southeast Public Improvement Metropolitan District (SPIMD), Lyft, Via Mobility Services (Via), and Xerox (Conduent). Beginning August 17th, residents were able to request a free Lyft Line (carpooling) ride to and from the Dry Creek LRT station. The Go Denver app powered by Xerox integrated scheduling and payment systems for both transit and Lyft, thus allowing users to select the FLMP options including Light Rail + Lyft Line. |
| Links | [Shared Use Mobility Center](https://learn.sharedusemobilitycenter.org/wp-content/uploads/Go-Centennial-Final-Report_for-web.pdf) |
| Implementation Costs & Impact Factor | The FLMP program had a budget of \$400,000 and temporarily replaced the Citys Call-n-Ride system. Read more in the report. |
| Scalable Potential | A similar service in Stockton could subsidize trips to the Amtrak station or dowtown bus station. |
| Similar | [RideAustin](https://learn.sharedusemobilitycenter.org/casestudy/metrolink-pilot-by-capmetro-in-partnership-with-rideaustin/) |

## Vehicle Emissions

This domain focuses on strategies that reduce the emissions of combustion engine vehicles or increase the share of electric vehicles on the road.

### Provide grants for pollutant remediation and reduction initiatives
| Location | Ventura County, CA |
|:------|:-------------------------------------------------------------------|
| Details | The Carl Moyer Memorial Air Quality Standards Attainment Program, which is jointly run by CARB and the VCAPCB, provides grants for the following projects: Repower commercial fishing boats with lower emission engines; Repower farm equipment with lower emission engines; Replace emergency vehicles with lower emission engines; Replace heavy duty diesel trucks with lower emission engines; New, conversion of existing, or expansion of battery charging/alternative fueling stations. |
| Links | [Ventura County Air Pollution Control District](http://www.vcapcd.org/grant_programs.htm#Clean_Air_Fund_) |
| Implementation Costs & Impact Factor | Since its inception, over \$42 million was granted to businesses in Ventura County. In 2017, \$4.5 million was allocated; in 2018, \$2.5 million was allocated;iIn 2019, \$6 million was allocated. |
| Scalable Potential | The case study was funded by CARB, so the primary pathway is through CARB and the local air pollution district. Most funding is allocated to commercial uses. |
| Similar | [Transportation Fund for Clean Air County Program Manager Fund, BAAQMD](https://www.baaqmd.gov/funding-and-incentives/public-agencies/county-program-manager-fund) |

### Provide commercial rebates for commercial building owners to install EV charging stations
| Location | Los Angeles, CA |
|:------|:-------------------------------------------------------------------|
| Details | The Los Angeles Department of Water and Power (LADWP) provides rebates to commercial customers toward the purchase of a Level 2 electric vehicle charging station. Commercial customers who purchase and install EV charging stations for employee and public use can receive up to \$5,000 for each charger, with up to \$750 in additional rebate funds per extra charge port. Eligible customers may qualify for up to 40 rebate rewards depending on the number of parking spaces at the installation site. EV charging stations must be installed within the LADWP service area. Rebates are available on a first-come, first-served basis through June 30, 2021, or until funds are exhausted. |
| Links | [LADWP](https://www.ladwp.com/ladwp/faces/ladwp/commercial/c-savemoney/c-sm-rebatesandprograms/c-sm-rp-commevstation?_adf.ctrl-state=ydg1eawf9_17&_afrLoop=246802491623816) |
| Implementation Costs & Impact Factor | [See recent dashboard report](https://www.ladwp.com/cs/idcplg?IdcService=GET_FILE&dDocName=OPLADWPCCB701489&RevisionSelectionMethod=LatestReleased). As for February 2020, \$31 million for Level 2 charging stations, with over 350 applications paid, pending, or reserved. |
| Scalable Potential | Many parking structures in Stockton may be good candidates for incentivizing EV charging station installation. |
| Similar | [Rancho Cucamonga Municipal Utility](https://www.cityofrc.us/sites/default/files/2019-08/ENG-RCMU-Commercial-EV-Rebate-Application_2019.pdf) |

### Provide grants to income eligible residents for the replacement of high-emission cars with low-emission cars
| Location | San Francisco Bay Area, CA |
|:------|:-------------------------------------------------------------------|
| Details | The Bay Area Air Quality Management District's (BAAQMD) Clean Cars for All program offers grants up to \$9,500 to income-eligible residents to replace a vehicle eligible for retirement with a PEV or HEV. Eligible vehicles for replacement should have a model year 15 years or older than the current year. Recipients may buy or lease a new or used PEV or HEV. Grants vary depending on the household income and vehicle technology. Vehicles that are replaced must be turned in at an authorized dismantler. Individuals that purchase an all-electric vehicle are eligible to receive up to \$2,000 for the purchase and installation of a Level 2 electric vehicle supply equipment. |
| Links | [BAAQMD](https://www.baaqmd.gov/funding-and-incentives/residents/clean-cars-for-all) |
| Implementation Costs & Impact Factor | From 2015-2019, \$112 million was allocated to Clean Cars 4 All from CARB (\$10 million of which was from Volkswagen settlement funds). Of this, San Joaquin Valley APCD has expended about \$9 million of \$41 million to replace 1,450 vehicles (about 15 percent battery electric, 35 percent plug-in hybrid, 50 percent hybrid). [Read more here](https://ww2.arb.ca.gov/sites/default/files/2019-09/fy1920fundingplan.pdf) and through [Drive Clean in the San Joaquin](https://www.valleyair.org/drivecleaninthesanjoaquin/replace/). |
| Scalable Potential | Further grant opportunities are expected through the program in the coming years. Stockton could target underserved communities in future grant applications. |
| Similar | [City of Pasadena](https://ww5.cityofpasadena.net/water-and-power/residentialevrebate/) |

### Engage automobile manufacturers as stakeholders in the EV market
| Location | Arizona |
|:------|:-------------------------------------------------------------------|
| Details | Arizona requires car dealers to make information about alternative fuel vehicles and Arizona-based incentives for purchasing or leasing alternative fuel vehicles available to the public. The state also created an Electric Vehicles Arizona stakeholder group to bring together auto dealers and other interested parties so that they better understand the opportunities and barriers that electric vehicles face in the state. |
| Links | [Carnegie Endowment Report](https://carnegieendowment.org/files/electric_vehicles.pdf) |
| Implementation Costs & Impact Factor | No implementation costs. [Between 2017 and 2018](https://evadoption.com/ev-market-share/ev-market-share-state/), AZ EV sales increased from 2,976 (0.90% of market share) to 7,086 (1.84% of market share). |
| Scalable Potential | According to the California [Clean Vehicle Rebate Project](https://cleanvehiclerebate.org/eng/rebate-statistics), San Joaquin County customers have received about 3,000 rebates, compared to 366,000 state-wide, leaving a lot of growth potential compared to other counties. |
| Similar | [Chicago Area Clean Cities](https://www.chicago.gov/city/en/depts/cdot/supp_info/chicago_area_cleancities.html) |

### Reduce vehicle speed limits
| Location | Massachusetts |
|:------|:-------------------------------------------------------------------|
| Details | Introducing lower speed limits on motorways cuts fuel consumption and pollutant emissions. The exact impact is contingent upon vehicle type, driving patterns, frequency of speeding, congestion, and traffic diversion. |
| Links | [European Environment Agency](https://www.eea.europa.eu/themes/transport/speed-limits-fuel-consumption-and/speed-limits) |
| Implementation Costs & Impact Factor | Pollution: Depending on [driving behavior](https://www.eea.europa.eu/themes/transport/speed-limits-fuel-consumption-and/speed-limits), it is possible to expect anything from 2-18% reductions in GHGs.<br>Public Health: In an 83-city [study](https://ehjournal.biomedcentral.com/articles/10.1186/1476-069X-9-65), PM2.5-related mortality reduction is worth \$31 billion (2007 dollars).<br>Fatalities and Injuries: 2200 crashes, 18 fatalities, and 1200 injuries reduced in Massachusetts.<br>Economic Benefits: Massachusetts predicted to save \$210 million (30mph to 25mph reduction). |
| Scalable Potential | According to the California [Clean Vehicle Rebate Project](https://cleanvehiclerebate.org/eng/rebate-statistics), San Joaquin County customers have received about 3,000 rebates, compared to 366,000 state-wide, leaving a lot of growth potential compared to other counties. |
| Similar | [NYC Neighborhood Slow Zones](https://www1.nyc.gov/html/dot/html/motorist/slowzones.shtml)<br>[Philadelphia Neighborhood Slow Zones](http://visionzerophl.com/get-involved) |

## Resilience

### Promote cool surfaces to reduce heat island effect
| Location | New York City, NY |
|:------|:-------------------------------------------------------------------|
| Details | Rather than using dark pavements, which attract 80-95% of sunlight, solar reflective "cool" pavements have increased reflectance. They typically use a reflective or clear binder, or a reflective surface coating. |
| Links | [White Roof Project, NYC](http://www.whiteroofproject.org/)<br>[Berkeley Lab](https://heatisland.lbl.gov/coolscience/cool-pavements) |
| Implementation Costs & Impact Factor | CoolSeal costs between \$0.30 to \$0.40 per square foot. Albedo increases lead to a reduction of outdoor air temperatures by 0.2 to 0.9 degrees Fahrenheit. In California cities with a lot of air conditioning, the savings of air conditioning energy due to lowered air temperature is up to 1 kWh (\$0.60) per year per sq.m. of pavement modified. The avoided CO2 is valued at less than a penny a year per sq.m. Lower surface air temperature reduces ground level ozone. |
| Scalable Potential | Downtown Stockton could benefit from a set of public and private initiatives to retrofit existing commercial roofs and ground surfaces. |
| Similar | [SMUD Cool Roof Rebate](https://energy-seal.com/wp-content/uploads/crrp_smud_cool_roof_rebate_program.pdf) |

### Promote permeable pavement to increase groundwater absorption
| Location | Madison, WI |
|:------|:-------------------------------------------------------------------|
| Details | Permeable pavement is a form of pavement that is highly porous pavement that allows rainwater to pass through it and into the ground. In addition to reducing surface runoff, it can trap suspended solids, thereby filtering stormwater. This also reduces peak discharge rates, meaning that flooding is more controlled. It is, however, most appropriate for sidewalks/pedestrian areas and low-speed driving areas. |
| Links | [USGS](https://www.usgs.gov/science/evaluating-potential-benefits-permeable-pavement-quantity-and-quality-stormwater-runoff?qt-science_center_objects=0#qt-science_center_objects) |
| Implementation Costs & Impact Factor | \$4.00-\$6.00 per square foot. [Read more here](https://docs.google.com/document/d/1qV1ki5JeARdA-i3a_4ICYKz0fER5NR8QOo5Aq3TBiTQ/edit). |
| Scalable Potential | Stockton could identify low-lying areas that frequently flood and prioritize permeable pavement as part of regularly scheduled maintenance. |
| Similar | [SF Permeable Sidewalks](https://www.sfbetterstreets.org/find-project-types/greening-and-stormwater-management/stormwater-overview/permeable-paving/) |

### Reclaim urban streams and rivers to increase groundwater absorption and filtration
| Location | Greenville County, SC |
|:------|:-------------------------------------------------------------------|
| Details | Reclaiming urban streams and rivers helps to restore the watercycle back to its natural processes. This helps to restore groundwater recharge, as well as natural water filtration processes. From an environmental perspective, it restores sensitive natural habitats. |
| Links | [Earth Economics](https://static1.squarespace.com/static/561dcdc6e4b039470e9afc00/t/5e4581cf81c87071297f8e61/1581613539633/ReedyRiver_FactSheet_0220-0.pdf) |
| Implementation Costs & Impact Factor | [\$28 to \$129 per foot](https://www.prp.cses.vt.edu/Reports_04/Mitigation_04.pdf). Benefits: reduction in sediment removal (\$2.76 per ton to manually remove); [green space](https://www.researchgate.net/publication/265969625_Effect_of_public_green_space_on_residential_property_values_in_Belfast_metropolitan_area) increases property values by up to 49% as properties change hands; [contingent valuation](https://www.hydroreform.org/sites/default/files/Hurd_Economic_Benefits_2009_0.pdf) varies from \$10.83 to \$270.40 per capita. |
| Scalable Potential | There are a number of waterways through Stockton that could be opportunities for proactive reclamation, given that FEMA and U.S. Army Corps guidelines do not yet fully factor in the science on climate change impacts on precipitation patterns. |
| Similar | [Guadalupe River, San Jose](https://www.hydroreform.org/sites/default/files/Hurd_Economic_Benefits_2009_0.pdf) |

### Use green infrastructure to improve stormwater management
| Location | San Francisco, CA |
|:------|:-------------------------------------------------------------------|
| Details | Green Infrastructure is a method of reducing stormwater and pollution burden from stormwater systems. It does this through the creation of micro urban watersheds that have the potential to decrease erosion, improve air quality, increase land value, and reduce urban heat effects (thereby also reducing cooling loads). |
| Links | [SFWater](https://sfwater.org/modules/showdocument.aspx?documentid=13249) |
| Implementation Costs & Impact Factor | Contingent upon site. [See table](https://docs.google.com/spreadsheets/d/1Z1Q1j1GJpgI8-M9XGKHMgTds0wqyB-twr-RLR7xX-JU/edit#gid=414331495).
| Scalable Potential | There are several key risks to Stocktons water quality, most of which are tied to Stockton historic and present manufacturing activities. The Sharpe Army Depot and McCormick & Baxter Creosoting Company are both listed on the Environmental Protection Agencies National Priorities List, indicating they are a high priority superfund site. The EPA has identified additional sites of concern including Stockton Iron Works, Colberg Boat Works, Norge Cleaning Village, and Brea Agricultural Services. Two additonal sites, Stockton Naval Communications Station and the General Services Administration, are both located at the Naval Supply Center at Rough and Ready Island. As a result of these sites, as well as agricultural run-off and other sources, Stockton has elevated levels of Arsenic that are, on average, 4.5 times higher than recommended levels. [Read more](https://docs.google.com/document/d/1O8eMspahozBkoB3-uIw3Azvwyv6xEJvca1XV76TwgFY/edit). |
| Similar | [Hunts Point, NY](https://static1.squarespace.com/static/561dcdc6e4b039470e9afc00/t/5d435f106f6e7a0001f5b304/1564696351697/HuntsPoint_EarthEconomics_062719-1.pdf)<br>[NE Siskiyou Green Street, Portland, OR](https://www.urbanraindesign.com/ne-siskiyou)<br>[Caltrans](https://www.owp.csus.edu/research/papers/papers/PP061.pdf)<br>[Tres Rios Demonstration Constructed Wetlands, Phoenix](https://www.wetlandsolutionsinc.com/download/TreatmentWetlands/Tres_Rios_Biomonitoring_Aug%202004.pdf) |

### Promote urban gardens as a substitute for displaced ecosystem services
| Location | Philadelphia, PA |
|:------|:-------------------------------------------------------------------|
| Details | As a result of their greying environment, cities often suffer from greater fluctuations in weather conditions, poor water infiltration, improper nutrient cycling, and lack of vegetative cover. These lead to reduced water quality and flooding, heat islands, and lack of ecological diversity. Using vacant lots, which reduce property values, residents of Philadelphia have developed urban gardens  as a means of food production, increase property values, and provide educational opportunities on sustainability. |
| Links | [Philadelphia Inquirer](https://www.inquirer.com/science/climate/urban-farm-agriculture-philadelphia-plan-garden-plots-20190320.html)<br>[University of Pennsylvania](https://repository.upenn.edu/cgi/viewcontent.cgi?article=1044&context=mes_capstones) |
| Implementation Costs & Impact Factor | Soil remediation costs between \$5-40 per ton. Central Valley water costs between \$15-40 per acre-foot. Philadelphia is estimated to have about 40,000 structureless vacant parcels amounting to 1,840 acres of unused land. These vacant parcels reduced property values by an average of 6.5%, leading to $3.6 billion in property tax loss. Households with an adult that participates in a community garden program are more likely to eat fruits and vegetables. Compared to vacant lots, agricultural lots realized far lower rates of soil erosion. |
| Scalable Potential | Local nonprofits like [PUENTES](http://puentesca.org/) already are in a position to expand their operations to develop more urban gardens in Stockton, contingent on land and water costs. |
| Similar | [Detroit Garden Resource Program](http://detroitagriculture.net/)<br>[HOME GR/OWN Milwaukee](https://city.milwaukee.gov/homegrownmilwaukee.com#.XlXwGmhKiUk) |

### Offer rebates for flood mitigation projects
| Location | South Holland, IL |
|:------|:-------------------------------------------------------------------|
| Details | Due to flooding from a local river, South Holland, IL offers up to \$2500 per project per property. Approved projects include measures to prevent water from entering a home, including adding downspouts and floodwalls, sewer backup projects, such as installing overhead sewers, and removal of connections from stormwater sewers. In 2016, the program was further extended to cover up to \$5,000 in costs if residents install systems to prevent sewer backups. |
| Links | [Pew Charitable Trusts](https://www.pewtrusts.org/-/media/assets/2019/11/illinois_village_offers_rebates_brief_final.pdf) |
| Implementation Costs & Impact Factor | As of February 2019 (started in 1990), \$800,000 in rebates; 1,172 households have participated. |
| Scalable Potential | Historical data on snowpack flooding has shown that 3 feet of flooding in Stockton could impact as many as 12,000 acres of land, with 20,000 housing units. Factoring in sea level rise projections, [Climate Central](http://ssrf.climatecentral.org.s3-website-us-east-1.amazonaws.com/Buffer2/states/CA/downloads/pdf_reports/Town/CA_Stockton-report.pdf) estimates a 34 percent multi-year risk of at least one flood exceeding 3 feet from 2016 to 2030, a 93 percent risk by from 2016 to midcentury, and a 100 percent risk by 2100. Under the National Resaerch Council's high-end projections, these chances increase to 50, 100, and 100 percent, respectively, and they compute a 100 percent risk of at least one flood exceeding 6 feet by the end of the century.
| Similar | [Wisconsin Department of Natural Resources](https://www.pewtrusts.org/en/research-and-analysis/issue-briefs/2019/11/wisconsin-grant-program-helps-people-relocate-from-flood-prone-areas)<br>[Arkansas Private Wetland and Riparian Zone Creation and Restoration Incentives Act](https://www.pewtrusts.org/en/research-and-analysis/issue-briefs/2019/11/arkansas-tax-credit-rewards-landowners-for-conserving-wetlands) |

# Analysis of Green Economy Strategies

While the previous chapter is presented as a broad overview of different green economy strategies from locations across the U.S. and other countries, this chapter hand-picks a limited subset of strategies to examine in greater detail. These strategies are selected because of their ability to be modeled using the same framework as developed in Chapter 2, as well as their identification as practical options for Stockton by Stockton stakeholders. After a description of how the strategies will be quantitatively evaluated within our existing GHG framework, the following sections are once again organized by domain of green economy strategies. Each section introduces key model assumptions, and then a specific set of recommended strategies are modeled in terms of their possible impact on GHG reduction and economic benefits. Where possible, short-term and operational costs are also estimated.

## Methodology

Chapter 2's baseline assessment has already set up the framework for how we will evaluate the effectiveness of any green economy strategies we might consider. Whatever the strategy may be, it would need to have a predicted effect on one of the variable inputs in our GHG model. The following diagram shows those variables highlighted in yellow, and their business-as-usual trends as up/down arrows.

```{r diagram, fig.cap="GHG model diagram."}
include_graphics("images/diagram.jpg")
```

- Employment % was observed in ACS data as the ratio between employed residents and population 16 and older. Using a simple linear assumption, the employment rate increases to 72% in 2040. As a point of comparison, the U.S. 2018 employment rate was ~ 70%. To maintain even this "business-as-usual" trend may depend on aggressive strategies like workforce training and education initiatives. Otherwise, this is considered a variable that can be influenced through specific employment growth strategies. Note that employment rate affects the number of employed residents, which particularly affects VMTs in the GHG model.
- Increasing Jobs to Employed Residents Ratio is different from increasing local employment rate as it can also include attracting workers who are not Stockton residents to commute to Stockton. Economic development strategies to attract new businesses would be an example of a type of strategy that influences the GHG model through this variable. J/ER affects the number of jobs in Stockton, which particularly affects commercial building emissions in the GHG model. If those local jobs are increasingly held by Stockton residents, it also implies that VMTs have been reduced.
- Commute One-Way Vehicle Miles Traveled is modeled using the LODES origin-destination data, so any predictions of changes in the distribution and concentration of jobs would affect this variable. Other transportation strategies such as increasing carpooling or transit would also affect this variable.
- Vehicle Emission Rates
- Building Utilization and Building Energy Efficiency are built into the variables of Energy Use per Capita per Degree Day as "hidden variables" that can't easily be isolated without more data, but any strategies directed at reducing the amount of floor space per capita, or increasing floor area ratio on sites, or retrofitting buildings can be predicted as affecting Building Utilization or Building Energy Efficiency, which in turn would proportionally affect Energy Use per Capita.
- Energy Emission Rates also affect the ultimate emissions estimated out of some amount of energy use. We have already incorporated PG&E's target to steadily eliminate the emissions associated with electricity use. Strategies that shift energy use from gas to electricity would result in quantitative changes at this leverage point in the model.

## Building Utilization

As seen in [Section 2.10](#ghg-forecast), Stockton's population is estimated to grow from 315,000 in 2020 to 339,000 in 2040, and Stockton's job count is estimated to grow from 125,000 in 2020 to 151,000 in 2040. The roughly 24,000 new residents and 26,000 jobs will of course have some baseline amount of energy use that can't be avoided, but the particular ways in which buildings provide for their needs can be made more energy-efficient through specific strategies. This section will focus on ways to reduce the amount of space required per person, which primarily affects energy usage because less heating and cooling is required. Less space per person implies a more dense urban form, which also brings transportation benefits, which we account for elsewhere in the model.

### Strategy: Accessory Dwelling Units

The 2019 California state legislative cycle resulted in [accessory dwelling units](#encourage-accessory-dwelling-units) (ADU) laws that took effect on 1/1/2020 and, among other changes, supercede local control to allow ADUs to be built on every single-family parcel. More specifically, local regulations cannot prevent a homeowner from applying to build an internal ADU of up to 500 sqft within their existing structure, as well as a detached ADU of up to 800 sqft in their backyard, with newly enforced maximum setbacks of 4ft from the side and rear. Exact regulatory details are still in flux as individual cities are expected to update their local ordinances to match the new state laws, and loopholes will inevitably come up; refer to [CA Housing and Community Development](https://www.hcd.ca.gov/policy-research/AccessoryDwellingUnits.shtml) for the latest guidance.

ADUs are being evaluated as a green economy strategy for the following key reasons.

First, internal ADUs such as garage conversions directly align with the goals of Building Utilization, making more effective use of existing built floor area and promoting less energy-intensive residential living. According to the [U.S. Energy information Administration's Residential Energy Consumption Survey](https://www.eia.gov/todayinenergy/detail.php?id=11731) (RECS 2009) (see figure below), the energy use per household in 2-4 unit dwellings is roughly half of the energy use of a single-family household, so we will use the same assumption when considering the energy impact of internal ADUs. In other words, every new internal ADU development that Stockton can enable will effectively increase household count without increasing overall energy use, assuming those households would have otherwise lived in newly built single-family homes. This liberal assumption can inform an upper-end estimate of the energy consumption benefits of internal ADUs.

```{r energy-use-duplex-diagram, fig.cap="Site energy use by housing type. Source: RECS 2009.", out.width = "100%"}
include_graphics("images/energyuseduplex.png")
```

$~$

Second, detached ADUs, while not as effective as internal ADUs from a building utilization perspective, still are efficient compared to the average single-family dwelling because they are likely to have a smaller footprint in the constraints of backyard development. A robust model for the relationship between square footage and energy use is outside the scope of this study, so our simplified assumption will be as follows. According to the same RECS, [as analyzed by the National Association of home Builders](https://www.nahbclassic.org/generic.aspx?genericContentID=237901&fromGSA=1) (see figure below), about a third of single-family home energy consumption is for heating/cooling, while the rest is not significantly correlated with square footage. As previously estimated in [Section 2.9](#buildings), the average residential unit size in Stockton today is about 3,200 sqft (conservative because the data includes multifamily units) and consumes about 78,000 kBTUs per year. So we can estimate that a detached ADU of half that size, 1,600 sqft, would reduce its energy consumption by a sixth (to 65,000 kBTUs per year), and so forth.

```{r energy-sqft-diagram, fig.cap="NAHB analysis of HVAC vs non-HVAC energy use. Source: RECS 2009.", out.width = "100%"}
include_graphics("images/nahbenergy.jpg")
```

$~$

Third, ADUs of any type can be considered "infill growth" as they do not lead to expansion of existing urban boundaries or services. Considering transportation GHGs, we can assume that a household that lives in a new ADU will have the same transportation footprint as their neighbors, where otherwise they might live in newly-built housing that is likely to be further on the outskirts of town, away from jobs and amenities. For the purposes of this section, we will conclude by demonstrating that a progressive ADU strategy could target ADU development in the areas with the least amount of car-dependence, namely transit access to downtown and other neighborhood centers.

Fourth, homeowners who develop ADUs may realize a new stream of rent revenue, building wealth for local residents, while renters may benefit from lower rents because ADUs are a form of naturally occurring affordable housing. 

The fundamental question, then, is: how many new ADUs can Stockton actively enable in the next two decades that wouldn't have otherwise been built? It is unknown what the natural rate of ADU development is without local intervention, given the new state legislation; this remains to be seen in communities across the state as the laws have just taken effect. But for the purposes of our analysis, we will assume that the City of Stockton has a range of options from being the *least* supportive of ADU development (given that despite state legislation, local permitting processes, permit fees, information barriers, community opposition, and financial barriers could all work to curtail development) to the *most* supportive of ADU development (adopting many of the best practices [we reviewed in Chapter 3](#encourage-accessory-dwelling-units)), and we will quantify the size of that spectrum by estimating the number of ADUs that could be built based purely on physical characteristics of existing single-family parcels.

The following is a breakdown of the number of residential parcels by housing type, based on 2018 County Assessor Records. Note that the apartment parcels contain multiple units, so the number of total housing units or households is not represented in this table. Also, our data does not clearly indicate existing ADUs, so the analysis assumes that all single family parcels do not currently have ADUs. We suspect that the existing number of permitted ADUs is relatively low.

```{r units-by-type-table}
projection <- "+proj=utm +zone=10 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=ft +no_defs"

stockton_boundary_influence_projected <- st_read("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/SpheresOfInfluence/SpheresOfInfluence.shp", quiet = TRUE) %>% 
  filter(SPHERE == "STOCKTON") %>% 
  st_transform(projection)

load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/Parcels/sjc_parcels.Rdata")

load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/Parcels/stockton_parcels.Rdata")

load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/USBuildingFootprints/bldg_join.Rdata")

residential_bldg <-
  bldg_join %>% 
  st_transform(projection) %>% 
  filter(ZONING == "R")

stockton_residential_parcels <-
  stockton_parcels %>%
  filter(APN %in% residential_bldg$APN) %>% 
  left_join(residential_bldg %>% st_set_geometry(NULL), by ="APN") %>% 
  filter(!duplicated(APN))

residential_bldg_summary <-
  stockton_residential_parcels %>% 
  mutate(
    Type = 
      case_when(
        type == 10 ~ "Single Family",
        type == 21 ~ "Duplex",
        type == 22 ~ "Apartment",
        is.na(type) ~ "Data Unavailable",
        TRUE ~ "Other"
      )
  ) %>% 
  group_by(Type) %>%
  summarize(Count = n()) %>% 
  st_set_geometry(NULL) %>% 
  mutate(Count = prettyNum(floor(Count/100)*100,big.mark=","))

residential_bldg_summary <- residential_bldg_summary[c(5,3,1,4,2),]

kable(
  residential_bldg_summary,
  booktabs = TRUE,
  caption = 'Number of residential parcels in Stockton by housing type.'
) %>%
  kable_styling() %>%
  scroll_box(width = "100%")
```

$~$

Starting first with internal ADUs, technically all 66,000 single-family, duplex, and apartment parcels could build permitted internal ADUs (in fact more than one can be allowed in existing multifamily buildings). These are by definition smaller units (less than 500 sqft, typically converting an existing garage, attic, basement, or master bedroom), so can't necessarily support larger household sizes. 

As projected in [Section 2.10](#ghg-forecast), only 25,000 new residents are expected between 2020 and 2040. In other words, it could be possible to support this entire population growth (with little increase in building energy consumption) if just half of all eligible existing buildings were to convert existing space to internal ADUs. Of course, for a number of reasons including lifestyle preference (with internal ADUs perhaps being the least palatable social arrangement for two separate households), this is not literally feasible, but should signal the opportunity in encouraging ADU development. 

Detached ADUs may be more palatable (along with attached ADUs which are additions to an existing home, but these are not considered in our analysis), given the greater privacy between households, greater square footage, and potential reduced complexity of new construction vs. retrofitting existing buildings, but are more costly as well. Assessing the viability of detached ADUs is more complicated because it involves geospatial analysis. 

We developed a script that performs the following basic steps:

1. We acquired Parcel shapes from the [City of Stockton GIS database](http://www.stocktonca.gov/services/gis/mapdatDat.html).
2. We acquired Building shapes from [Microsoft's U.S. Building Footprint Data](https://github.com/microsoft/USBuildingFootprints)
3. For each residential parcel, we produced the leftover yard area after removing 4ft setbacks, front yards (based on the closest distance from the existing building to the street edge), and the building (including a 5ft setback per municipal ordinances).
4. Using an 8ft x 20ft shape (like [the smallest ADU available on the market](https://mekamodular.com/models/standard/liberty-160/)), we traced this yard space to find the subset of space that can technically fit an orthogonal ADU design. This method does not account for obstructions like trees not represented in our data.
5. We aggregated and quantified the square footage of this remaining "buildable area".

The following map shows what the analysis looks like for one block group in South Stockton.

```{r adu-example, fig.cap='Demonstration of detached ADU geospatial analysis. Shown are parcels, existing building footprints, and buildable area.'}
# yard_setbacks <-
#   stockton_residential_parcels %>%
#   st_buffer(-4, joinStyle = "MITRE", mitreLimit = 1) # 4ft yard setback
# 
# house_setbacks <-
#   residential_bldg %>%
#   st_buffer(5, joinStyle = "MITRE", mitreLimit = 1) #5 ft house setback
# 
# adu_available_land <- NULL
# for(row in 1:floor(nrow(stockton_residential_parcels)/1000)){
# 
#   start <- row*1000-999
# 
#   end <- ifelse(
#     row < floor(nrow(stockton_residential_parcels)/1000),
#     row*1000,
#     nrow(stockton_residential_parcels)
#   )
# 
#   print(paste0(start," to ",end))
# 
#   available_land <-
#     st_difference(yard_setbacks[which(yard_setbacks$APN %in% stockton_residential_parcels$APN[start:end]),], st_union(house_setbacks[which(house_setbacks$APN %in% stockton_residential_parcels$APN[start:end]),]))
# 
#   adu_available_land <-
#     adu_available_land %>%
#     rbind(available_land)
# }
# save(adu_available_land, file = "C:/Users/derek Ouyang/Google Drive/City Systems/Stockton Green Economy/ADU/adu_available_land.Rdata")
# 
# yard_separation <- #separates front and back yards into separate shapes
#   adu_available_land %>%
#   as_Spatial() %>%
#   sp::disaggregate() %>%
#   st_as_sf()
# 
# This creates the merged parcel shapes, so you can know that a parcel touches a street edge if it shares an edge with the block it's part of. the buffers are first filling in some small slivers, and then producing an end block shape that is 1ft inset from the original.
# stockton_parcels_dissolve <-
#   stockton_parcels_extended %>% 
#   summarize() %>% 
#   st_buffer(1) %>% 
#   st_buffer(-2) %>%
#   as_Spatial() %>%
#   sp::disaggregate() %>%
#   st_as_sf()
# 
# save(stockton_parcels_dissolve, file = "C:/Users/derek Ouyang/Google Drive/City Systems/Stockton Green Economy/ADU/stockton_parcels_dissolve.Rdata")
# load("C:/Users/derek Ouyang/Google Drive/City Systems/Stockton Green Economy/ADU/stockton_parcels_dissolve.Rdata")
# 
# This creates the clips of each parcel with the block shapes from the previous line. because of the -1ft buffer, this creates little 1ft leftover crusts.
# 
# for(row in 1:floor(nrow(stockton_parcels_dissolve)/100)){
# 
# street_edges <- NULL
# for(row in 1:floor(nrow(stockton_parcels_dissolve)/100)){
#   
#   start <- row*100-99
# 
#   end <- ifelse(
#     row < floor(nrow(stockton_parcels_dissolve)/100),
#     row*100,
#     nrow(stockton_parcels_dissolve)
#   )
# 
#   print(paste0(start," to ",end))
#   
#   street_edge <- 
#     stockton_residential_parcels[which(stockton_residential_parcels$APN %in% st_centroid(stockton_residential_parcels)[stockton_parcels_dissolve[start:end,],]$APN),] %>% 
#     mutate(
#       parcel_area = st_area(.) %>% as.numeric()
#     ) %>% 
#     st_difference(st_union(stockton_parcels_dissolve[start:end,]))
#   
#   street_edges <-
#     street_edges %>% 
#     rbind(street_edge)
#   
#   save(street_edges, file = "C:/Users/derek Ouyang/Google Drive/City Systems/Stockton Green Economy/ADU/street_edges.Rdata")
# }
# 
# load("C:/Users/derek Ouyang/Google Drive/City Systems/Stockton Green Economy/ADU/street_edges.Rdata")
# 
# # Note that borders with water or green space may be incorrectly identified as street edges with this method. in EPA there are almost always buffer parcels for the baylands which prevent this from happening, but this may need to be addressed as a check on suspected throughlots using the street method, same as how the corner lot cases likely need to be sent to the street method.
# 
# # Reviewing the throughlot cases can lead to manual identification of false positives, but this may not be worth the time to do. for now, this sets aside all cases of 2+ crusts to be treated in a separate analysis, since you'd need to treat throughlots separately anyway.
# through_lots_or_misc <-
#   street_edges %>% 
#   as_Spatial() %>%
#   sp::disaggregate() %>%
#   st_as_sf() %>% 
#   group_by(APN) %>% 
#   summarize(count = n()) %>% 
#   filter(count > 1) %>% 
#   st_set_geometry(NULL) %>% 
#   left_join(stockton_parcels, by = "APN") %>% 
#   st_as_sf()
# 
# # This takes advantage of the convex hull operation to find bent crusts. 15% seems to be roughly the right ratio of the convex hull shape area to original parcel area to identify true corner conditions, but this will have some false positives and false negatives. these corner cases are set aside for now, likely need to be sent to the street matching script.
# corner_edges <-
#   street_edges %>%
#   filter(!APN %in% through_lots_or_misc$APN) %>% 
#   st_convex_hull() %>% 
#   mutate(
#     edge_area = st_area(.) %>% as.numeric()
#   ) %>% 
#   filter(edge_area > parcel_area*0.15)
# 
# This filters to the remaining one-crust parcels that are SFR. 
# normal_residential_parcels <-
#   street_edges %>% 
#   filter(!APN %in% through_lots_or_misc$APN) %>%
#   as.data.frame() %>% 
#   rename(street_edge = geometry) %>% 
#   dplyr::select(APN,parcel_area,street_edge) %>% 
#   left_join(stockton_parcels, by = "APN") %>%
#   as.data.frame() %>% 
#   rename(parcel_geometry = geometry) %>% 
#   dplyr::select(APN,parcel_area,street_edge,parcel_geometry) %>% 
#   right_join(residential_bldg, by = "APN") %>%
#   filter(!is.na(parcel_area)) %>% 
#   rename(building_geometry = WKT) %>% 
#   st_as_sf()
# 
# normal_residential_parcels_distance <-
#   normal_residential_parcels %>% 
#   mutate(
#     distance_bldg_front =
#       1:nrow(normal_residential_parcels) %>% 
#       map(function(row){
#         if(row%%100 == 0) print(row)
#         st_nearest_points(normal_residential_parcels$street_edge[row],normal_residential_parcels$building_geometry[row]) %>% 
#           st_length()
#       }) %>% 
#       unlist()
#   ) %>% 
#   arrange(APN, distance_bldg_front) %>% 
#   filter(!duplicated(APN))
# 
# front_yard_setback <-
#   1:nrow(normal_residential_parcels_distance) %>% 
#   map_dfr(function(row){
#     if(row%%100 == 0) print(row)
#     
#     normal_residential_parcels_distance[row,] %>% 
#       st_set_geometry("street_edge") %>% 
#       st_buffer(normal_residential_parcels_distance$distance_bldg_front[row],joinStyle = "MITRE", mitreLimit = 1) %>% 
#       as.data.frame()
#   }) %>% 
#   st_as_sf() %>% 
#   st_set_crs(projection)
# 
# yard_separation_front_yard_setback <- NULL
# for(row in 1:floor(nrow(stockton_residential_parcels)/1000)){
# 
#   start <- row*1000-999
# 
#   end <- ifelse(
#     row < floor(nrow(stockton_residential_parcels)/1000),
#     row*1000,
#     nrow(stockton_residential_parcels)
#   )
# 
#   print(paste0(start," to ",end))
# 
#   yard_separation_temp_result <-
#     yard_separation[which(yard_separation$APN %in% stockton_residential_parcels$APN[start:end]),]
#   
#   front_yard_setback_temp_result <-
#     front_yard_setback[which(front_yard_setback$APN %in% stockton_residential_parcels$APN[start:end]),] %>% 
#     st_union()
# 
#   yard_separation_front_yard_setback <-
#     yard_separation_front_yard_setback %>%
#     rbind(
#       st_difference(
#         yard_separation_temp_result,
#         front_yard_setback_temp_result
#       )
#     )
# }
# 
# yard_separation_front_yard_setback <-
#   yard_separation_front_yard_setback %>% 
#   mutate(
#     yard_area = st_area(.) %>% as.numeric()
#   ) %>% 
#   filter(yard_area >= 160)
# 
# normal_residential_parcels_yards <-
#   normal_residential_parcels_distance %>%
#   as.data.frame() %>%
#   right_join(yard_separation_front_yard_setback %>% dplyr::select(APN,yard_area), by = "APN") %>% 
#   filter(!is.na(parcel_area)) %>% 
#   rename(yard_geometry = geometry) %>% 
#   st_set_geometry("yard_geometry")
# 
# # Takes two points and calculates the slope between them. Reference 0 degrees would be due east, and positive degrees are in the clockwise direction.
# get_angle <- function(pt1,pt2){
#   angle <- atan2((pt2[2]-pt1[2]),(pt2[1]-pt1[1]))
#   return(angle)
# }
# 
# # this creates a rotation matrix that can be multiplied by a point to get a point rotated counter-clockwise relative to (0,0). I found this online. Since my get_angle function gives degrees in the clockwise direction, it'd be great to reverse this rot function, but I didn't bother to figure out the math -- just added a negative in get_adu below.
# rot <- function(a) matrix(c(cos(a), sin(a), -sin(a), cos(a)), 2, 2)
# 
# get_adu_forward <- function(centroid,width,length,angle){
#   # this is revised ADU, the 8x20 is shifted 6ft to the right before rotating, which might do better fitting at corners.
#   corner1 <- st_point(centroid)+st_point(c(-width/2,-width/2))*rot(-angle) 
#   corner2 <- st_point(centroid)+st_point(c(length-width/2,-width/2))*rot(-angle) 
#   corner3 <- st_point(centroid)+st_point(c(length-width/2,width/2))*rot(-angle) 
#   corner4 <- st_point(centroid)+st_point(c(-width/2,width/2))*rot(-angle) 
#   
#   
#   adu <- 
#     rbind(corner1,corner2,corner3,corner4,corner1) %>%
#     list() %>% 
#     st_polygon() %>% 
#     st_sfc() %>% 
#     st_sf() %>% 
#     st_set_crs(projection)
#   
#   return(adu)
# }
# 
# get_adu_sideways_counterclockwise <- function(centroid,width,length,angle){
#   # this is a second revised ADU, the 8x20 is rotated 90 degrees relative to the previous one, so the ADU is sticking further into the inside of the yard area, which might do better fitting in certain areas that were previously unexplored.
#   corner1 <- st_point(centroid)+st_point(c(-width/2,-width/2))*rot(-angle) 
#   corner2 <- st_point(centroid)+st_point(c(width/2,-width/2))*rot(-angle) 
#   corner3 <- st_point(centroid)+st_point(c(width/2,length-width/2))*rot(-angle) 
#   corner4 <- st_point(centroid)+st_point(c(-width/2,length-width/2))*rot(-angle) 
#   
#   
#   adu <- 
#     rbind(corner1,corner2,corner3,corner4,corner1) %>%
#     list() %>% 
#     st_polygon() %>% 
#     st_sfc() %>% 
#     st_sf() %>% 
#     st_set_crs(projection)
#   
#   return(adu)
# }
# 
# # DO: note there was a typo in this (formerly adu3.5), the math for corners 3 and 4
# get_adu_sideways_clockwise <- function(centroid,width,length,angle){
#   # this is the same as get_adu2 but mirrored, since depending on which way you're going around the track clockwise or counterclockwise you might be sticking inwards or outwards. (I haven't checked if it's always a certain direction, maybe it is and you can definitely know which of these functions is the one to use. In my test case go[5048,], get_adu3 was the correct one, and the track was going clockwise)
#   corner1 <- st_point(centroid)+st_point(c(width/2,width/2))*rot(-angle) 
#   corner2 <- st_point(centroid)+st_point(c(-width/2,width/2))*rot(-angle) 
#   corner3 <- st_point(centroid)+st_point(c(-width/2,-length+width/2))*rot(-angle) 
#   corner4 <- st_point(centroid)+st_point(c(width/2,-length+width/2))*rot(-angle) 
#   
#   adu <- 
#     rbind(corner1,corner2,corner3,corner4,corner1) %>%
#     list() %>% 
#     st_polygon() %>% 
#     st_sfc() %>% 
#     st_sf() %>% 
#     st_set_crs(projection)
#   
#   return(adu)
# }
# 
# length <- 20
# width <- 8
# increment <- 2
# 
# go <- normal_residential_parcels_yards
# 
# go_buffer <- 
#   go %>% 
#   st_buffer(-width/2-0.25,joinStyle="MITRE",mitreLimit=1)
# 
# go_collected_buildable_area <- NULL
# for(parcelRow in 1:nrow(go)){
#   
#   print(parcelRow)
#   cbuffer <- go[parcelRow,]
#   go_adus <- NULL
#   
#   parcel_coords <-
#     go_buffer[parcelRow,] %>%
#     st_coordinates()
#   
#   start <- proc.time()
#   
#   if(is_empty(parcel_coords)){
#     parcel_coords <- NULL
#   } else{
#     
#     for(point in 1:(nrow(parcel_coords)-1)){
#       
#       # print(point)
#       pt1 <- parcel_coords[point,1:2]
#       pt2 <- parcel_coords[point+1,1:2]
#       
#       line <-
#         rbind(pt1,pt2) %>%
#         st_linestring() %>%
#         st_sfc() %>%
#         st_sf() %>%
#         st_set_crs(projection)
# 
#       go_angle <- get_angle(pt1,pt2)
#       
#       segments <- 
#         line %>% 
#         st_segmentize(increment) %>% 
#         st_coordinates()
#       
#       # forward/backward direction
#       segment <- 1
#       first_forward_eligible_adu <- NULL
#       while(is.null(first_forward_eligible_adu) & segment <= nrow(segments)){
#         adu_candidate <- 
#           get_adu_forward(segments[segment,1:2],width,length,go_angle) %>% 
#           filter(st_covers(cbuffer,.,sparse=F))
#         if(nrow(adu_candidate) > 0) first_forward_eligible_adu <- adu_candidate
#         segment <- segment + 1
#       }
#       
#       #simple backwards check if forwards completely fails, just checking "behind" the forward track
#       last_forward_eligible_adu <- NULL
#       if(is.null(first_forward_eligible_adu)){
#         for(segment in pmin(nrow(segments),(length-width/2)/increment):1){
#           adu_candidate <- 
#             get_adu_forward(segments[segment,1:2],width,length,go_angle + pi) %>% 
#             filter(st_covers(cbuffer,.,sparse=F))
#           if(nrow(adu_candidate) > 0) last_forward_eligible_adu <- adu_candidate
#         }
#       }
#       
#       segment <- 1
#       first_sideways_eligible_adu <- NULL
#       while(is.null(first_sideways_eligible_adu) & segment <= nrow(segments)){
#         adu_candidate <- 
#           get_adu_sideways_clockwise(segments[segment,1:2],width,length,go_angle) %>% 
#           filter(st_covers(cbuffer,.,sparse=F))
#         if(nrow(adu_candidate) > 0) first_sideways_eligible_adu <- adu_candidate
#         segment <- segment + 1
#       }
#       
#       last_sideways_eligible_adu <- NULL
#       if(is.null(first_sideways_eligible_adu)){
#         for(segment in pmin(nrow(segments),(length-width/2)/increment):1){
#           adu_candidate <- 
#             get_adu_sideways_counterclockwise(segments[segment,1:2],width,length,go_angle + pi) %>% 
#             filter(st_covers(cbuffer,.,sparse=F))
#           if(nrow(adu_candidate) > 0) last_sideways_eligible_adu <- adu_candidate
#         }
#       }
#       
#       # if no eligible ADU, next
#       if(is.null(first_forward_eligible_adu) & 
#          is.null(last_forward_eligible_adu) &
#          is.null(first_sideways_eligible_adu) &
#          is.null(last_sideways_eligible_adu)) next
#       
#       forward_churro <- NULL
#       sideways_churro <- NULL
#       
#       # finish checking forward_adu
#         
#       segment <- nrow(segments)
#       last_forward_eligible_adu <- NULL
#       while(is.null(last_forward_eligible_adu) & segment > 0){
#         adu_candidate <- 
#           get_adu_forward(segments[segment,1:2],width,length,go_angle + pi) %>% 
#           filter(st_covers(cbuffer,.,sparse=F))
#         if(nrow(adu_candidate) > 0) last_forward_eligible_adu <- adu_candidate
#         segment <- segment - 1
#       }
#       
#       if(!is.null(last_forward_eligible_adu)){
#         forward_churro <- 
#           rbind(first_forward_eligible_adu, last_forward_eligible_adu) %>% 
#           summarise() %>% 
#           st_convex_hull() %>% 
#           filter(st_covers(cbuffer,.,sparse=F))
#       }
#       
#       # finish checking sideways adu
#         
#       segment <- nrow(segments)
#       last_sideways_eligible_adu <- NULL
#       while(is.null(last_sideways_eligible_adu) & segment > 0){
#         adu_candidate <- 
#           get_adu_sideways_counterclockwise(segments[segment,1:2],width,length,go_angle + pi) %>% 
#           filter(st_covers(cbuffer,.,sparse=F))
#         if(nrow(adu_candidate) > 0) last_sideways_eligible_adu <- adu_candidate
#         segment <- segment - 1
#       }
#       
#       if(!is.null(last_sideways_eligible_adu)){
#         
#         sideways_churro <- 
#           rbind(first_sideways_eligible_adu, last_sideways_eligible_adu) %>% 
#           summarise() %>% 
#           st_convex_hull() %>% 
#           filter(st_covers(cbuffer,.,sparse=F))
#       }
#       
#       go_adus <-
#         go_adus %>% 
#         rbind(
#           forward_churro,
#           sideways_churro
#         )
#     }
#   }
#     
#   if(is.null(go_adus) | is.null(parcel_coords)){
#     go_adus_merge <-
#       st_sf(st_sfc(st_multipolygon())) %>% 
#         mutate(
#           APN = go$APN[parcelRow],
#           parcelRow = parcelRow,
#           compute_time = proc.time()[3] - start[3]
#         ) %>% 
#       rename(geometry = st_sfc.st_multipolygon...) %>% 
#       st_set_crs(projection)
#   } else {
#     go_adus_merge <-
#       go_adus %>%
#         st_make_valid() %>% 
#         st_buffer(0.1) %>% 
#         st_buffer(-0.1) %>% 
#         summarise() %>% # can throw a self-intersection error
#         mutate(
#           APN = go$APN[parcelRow],
#           parcelRow = parcelRow,
#           compute_time = proc.time()[3] - start[3]
#         )
#   }
#   
#   go_collected_buildable_area <- 
#     go_collected_buildable_area %>%
#     rbind(
#       go_adus_merge
#     )
# }
# 
# clean_buildable_area <-
#   go_collected_buildable_area %>% 
#   filter(!st_is_empty(.)) %>% 
#   st_buffer(2) %>% 
#   st_buffer(-2) %>% 
#   fill_holes(threshold = units::set_units(100000000, ft^2)) %>% 
#   as_Spatial() %>% 
#   sp::disaggregate() %>% 
#   st_as_sf() %>% 
#   mutate(
#     yard_area = st_area(.) %>% as.numeric()
#   ) %>% 
#   arrange(APN,desc(yard_area)) %>% 
#   filter(!duplicated(APN)) %>% 
#   mutate(
#     buildable_area = floor(yard_area/10)*10
#   )

load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/ADU/clean_buildable_area.Rdata")

test_block_group <- 
  block_groups("CA", cb = TRUE) %>% 
  filter(GEOID == "060770022011") %>% 
  st_transform(projection)

test_buildable_area <- clean_buildable_area[test_block_group,]
test_parcels <- normal_residential_parcels_yards[test_block_group,]

# map <- mapview(test_buildable_area$geometry, col.regions = "green", lwd=0, layer.name= "Buildable ADU Area") + 
#   mapview(test_parcels %>% st_set_geometry("parcel_geometry") %>% dplyr::select(parcel_geometry), alpha.region=0, color = "white", layer.name= "Parcel Boundary") + 
#   mapview(test_parcels %>% st_set_geometry("building_geometry") %>% dplyr::select(building_geometry), col.regions = "tan", lwd=0.5, layer.name= "Existing Building")
# 
# mapshot(map, url = "map-adu-example.html")

knitr::include_url("http://web.stanford.edu/~douyang1/map-adu-example.html")
```

$~$

While the geospatial analysis is not perfect, and doesn't account for other possible obstructions in a backyard, this result can be used to roughly estimate the number of parcels that could build detached ADUs, and examine the characteristics of those potential ADUs.

We analyzed 85,625 residential parcels and found 64,188 with enough backyard space to build at least a 160 sqft ADU. The breakdown is shown below by area range. The cut-offs are based on market research showing the existence of a [576 sqft 2-bedroom ADU](https://californiamodulars.com/roma/) and a [989 sqft 3-bedroom ADU](https://californiamodulars.com/napoli/). With over 2000 sqft of space, a greener option would be to completely redevelop the site to a higher density use, like a low-rise apartment.

```{r buildable-area-summary}
buildable_area_summary <-
  clean_buildable_area %>% 
  mutate(
    `Buildable Area` =
      case_when(
        buildable_area < 600 ~ "160-600 sqft (studio or one bedroom)",
        buildable_area < 1000 ~ "600-1000 sqft (2 bedroom)",
        buildable_area < 2000 ~ "1000-2000 sqft (3 bedroom)",
        TRUE ~ "2000 sqft or more"
      )
  ) %>% 
  group_by(`Buildable Area`) %>% 
  summarize(Count = n()) %>% 
  st_set_geometry(NULL) %>% 
  mutate(Count = prettyNum(floor(Count/100)*100,big.mark=","))

buildable_area_summary <- buildable_area_summary[c(2,4,1,3),]

kable(
  buildable_area_summary,
  booktabs = TRUE,
  caption = 'Stockton parcels with buildable area for detached ADUs.'
) %>%
  kable_styling() %>%
  scroll_box(width = "100%")
```

$~$

These numbers further suggest that there is more than enough space in residential backyards to support all the expected population growth in Stockton over the next 20 years.

Considering transportation footprint, Stockton could focus its outreach and incentives to the ADU-viable properties that are also extremely accessible to transit, so that the future ADU tenants are less likely to be car-dependent (this could be further ensured by restricting on-street parking and/or providing transit passes). For our demonstration, we defined this subset of the 64,000+ parcels as being within 15 minutes of walking + bus transit (with at least 20-minute frequency during commute hours) from Stockton's downtown bus station, which provides transfers to many other destinations around town as well a commuter bus to the Bay Area. Even with this heavy constraint, we found over 2,600 eligible parcels, as shown below.

```{r accessible-adus, fig.cap='Buildable areas for detached ADUs within 15 minutes of walking and transit from the Stockton downtown bus station.'}
rtd_gtfs <- read_gtfs("http://sjrtd.com/RTD-GTFS/RTD-GTFS.zip")
rtd_stops <- 
  st_as_sf(rtd_gtfs$stops,coords=c(6,5)) %>% 
  st_set_crs(4326) %>% 
  st_transform(projection)

rtd_stops_downtownstation <-
  c("7258","7017","7155","7003","7006","7025")

rtd_stops_amtrak <-
  c("7029","7032")

start_hour <- 16
end_hour <- 20
max_time_minutes <- 15

stop_times <- filter_stop_times(rtd_gtfs, "2020-02-24", start_hour*3600, end_hour*3600)

stop_frequency <-
  get_stop_frequency(
    rtd_gtfs,
    start_hour,
    end_hour
  )

rptr <- 
  raptor(
    stop_times, 
    rtd_gtfs$transfers, 
    rtd_stops_downtownstation, 
    departure_time_range = (end_hour-start_hour)*3600,
    keep = "shortest"
  )

downtown_accessible_stops <-
  rptr %>% 
  mutate(
    travel_time_minutes = (min_arrival_time-journey_departure_time)/60,
    walking_time_minutes = max_time_minutes - travel_time_minutes
  ) %>% 
  filter(travel_time_minutes <= max_time_minutes) %>% 
  left_join(rtd_stops, by = "stop_id") %>% 
  st_as_sf() %>% 
  left_join(stop_frequency, by = "stop_id") %>% 
  filter(departures >= (end_hour-start_hour)*3)

downtown_accessible_zone <-
  1:nrow(downtown_accessible_stops) %>% 
  map_dfr(function(row){
    downtown_accessible_stops[row,] %>% 
      st_buffer(downtown_accessible_stops$walking_time_minutes[row]/20*5280) %>% # convert minutes to ft assuming 20 minutes per mile walking
      as.data.frame()
  }) %>% 
  st_as_sf() %>% 
  st_set_crs(projection)

downtown_accessible_adus <-
  clean_buildable_area[which(clean_buildable_area$APN %in% st_centroid(clean_buildable_area)[downtown_accessible_zone,]$APN),]

downtown_accessible_adus_filtered <-
  downtown_accessible_adus %>% 
  filter(buildable_area < 15000)

routes <- 
  get_route_geometry(
    rtd_gtfs %>% gtfs_as_sf(), 
    route_ids = downtown_accessible_stops$route_id,
    service_ids = downtown_accessible_stops$service_id
  ) %>% 
  st_transform(projection)

downtownstation_stops <- 
  downtown_accessible_stops %>% 
  filter(stop_id %in% rtd_stops_downtownstation)

# map <- mapview(downtown_accessible_stops$geometry, layer.name= "Bus Stops")+
#   mapview(downtownstation_stops$geometry, cex = 10, col.regions = "red", layer.name = "Downtown Bus Station") +
#   mapview(routes$geometry, layer.name = "Bus Routes") +
#   mapview(downtown_accessible_adus_filtered$geometry, col.regions = "green", lwd=0.5, layer.name= "Buildable ADU Area")
# 
# mapshot(map, url = "map-accessible-adus.html")

knitr::include_url("http://web.stanford.edu/~douyang1/map-accessible-adus.html")
```

$~$

Such sites are great opportunities to immediately conduct homeowner outreach to increase awareness of new state legislation and the opportunities associated with ADU development, including a possible source of wealth-building or living space for a growing family. This type of analysis could be scaled up to a city-wide strategy in partnership with Stockton's Community Development Department.

Below, we offer an example of how a progress ADU strategy could impact our GHG forecasts:

- The business-as-usual projection from [Section 2.10](#ghg-forecast) suggests that total residential building GHG emissions are already expected to decline from 209,000 tCO2/year in 2020 to 101,000 tCO2/year, driven by climate change that reduces gas heating needs, cleaner PG&E electricity, and continuing trends in energy efficiency improvements and building utilization.
- As previously noted, 25,000 new residents are projected during the same time, contributing to about 7,400 of the 101,000 tCO2 in 2040.
- As part of a steady stream of single-family home retrofits happening over the next 20 years (partially driven by energy efficiency strategies covered later), homeowners could be actively encouraged to also consider the conversion of an underutilized space in their homes into an internal ADU, at the same time as other renovations. If just 1% of the 60,000+ single-family homes were to take up this opportunity, 6,000 internal ADUs could be developed, creating highly energy-efficient dwelling opportunities for some of the residential growth (which may include cases of younger Stocktonians growing up and moving into an internal ADU in the same home they grew up in, or their aging parents moving into the internal ADU and giving the main home to their children to start a new family).
- At the same time, homeowners could be actively encouraged to consider the development of detached ADUs, which can accommodate an even greater range of lifestyle preferences. If just 1% of the 60,000+ property owners eligible for detached ADUs were motivated to build a detached ADU, 6,000 additional detached ADUs could be made available that wouldn't otherwise have existed.
- Assuming an average 2 residents per household, these 12,000 new ADUs could support nearly all of the new residential growth. Of course, other kinds of residential development can be expected elsewhere in Stockton during these two decades, particularly higher-density multifamily housing. But this ADU capacity could effectively mitigate any further development of detached single-family housing.
- Using our energy assumptions, 6,000 internal ADUs and 6,000 detached ADUs (assuming an average 600 sqft in size), compared to what could have been 12,000 new single-family homes, would only emit about `r prettyNum(floor((25000/339000*101000*(12000/25000)*(2/3+(1/3)*(600/3200))+25000/339000*101000*(1000/25000))/100)*100,big.mark=",")` tCO2 compared to 7,400 in business-as-usual -- a 2-3% reduction in 2040's residential building GHG footprint.
- While the GHG reductions in building energy are relatively low because of the progressive reductions already expected in business-as-usual, the combined transportation impacts of ADU development could be relatively significant. There is a projected increase of 59,000 employed residents between 2020-2040. If half of the 12,000 ADUs could support transit-based commuting (given their location, like the demonstration above) for at least 6,000 employed residents (one per household) who would have otherwise been car-dependent, the reduction in projected commute GHGs would be about 46,000 tCO2 in 2040, bringing the total GHG reduction associated with ADU development to 53,000 tCO2 (2-3% of Stockton's total tCO2 in 2016).

Regarding the cost of implementation, more research is needed to quantify the size and effectiveness of different types of expenditures, like outreach to homeowners and reduced permit fees. It is safe to say that ADU development is primarily a market-driven opportunity that can potentially increase a city's bottom line, since new ADU development can yield increased property taxes with less infrastructure development (pipes and roads) and urban servicing (police and fire) cost per unit compared to entirely new suburban growth. We recommend considering ADU promotion a net-zero $/tCO2 strategy, with each incremental ADU having the rough kinds of GHG benefits summarized in the table below:

| ADU Type | tCO2/year Reduction (in 2040) |
|:------|:-------------------------------------------------------------------|
| Detached ADU, 600sqft | 0.2 |
| Internal ADU | 0.6 |
| Detached ADU, 600sqft, transit-oriented | 7.8 |
| Internal ADU, transit-oriented | 8.3 |

## Building Energy

### Strategy: Electrification

Building electrification refers generally to the conversion of building systems and appliances that are powered directly by fossil fuels into alternative systems and appliances that are powered by electricity, which is becoming increasingly low-carbon. The primary opportunities for electrification are in suburban areas with old homes that have water and space heating powered by natural gas. Household heating fuel type in Stockton from 2018 ACS 1-Yr data is shown below.

```{r fuel}
# acs_vars <-
#   listCensusMetadata(
#     name = "2018/acs/acs1",
#     type = "variables"
#   )
# 
# save(acs_vars, file="C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/acs1_vars_2018.Rdata")

load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/acs1_vars_2018.Rdata")

heating_fuel <-
  getCensus(
    name = "acs/acs1",
    vintage = 2018,
    vars = "group(B25040)",
    region = "place:75000",
    regionin = "state:06"
  ) %>% 
  select_if(!names(.) %in% c("GEO_ID","state","place","NAME")) %>%
  dplyr::select(-c(contains("EA"),contains("MA"),contains("M"))) %>%
  gather(
    key = "variable",
    value = "estimate"
  ) %>%
  mutate(
    label = acs_vars$label[match(variable,acs_vars$name)]
  ) %>% 
  transmute(
    `Heating Fuel Type` = 
      substr(
        label,
        lapply(
          label, function(x){
            max(unlist(gregexpr('!!',x)))+2
          }
        ),
        nchar(label)
      ),
    `Number of Households` = estimate,
    `Percent of Households` = paste0(round(estimate/95557*100,2),"%")
  )

kable(
  heating_fuel,
  booktabs = TRUE,
  caption = 'Heating fuel type for Stockton households. Data from ACS 1-yr, 2018.'
) %>% 
  kable_styling() %>% 
  scroll_box(width = "100%")
```

The 65% of households with "Utility gas" represent the opportunity to replace space heating systems with electric alternatives like heat pumps, moving those households over to the "Electricity" category currently at 32%. The other households using other fuels like kerosene or biomass represent a very small number, but targeting these households may be particularly important because of the extra cost-effectiveness of electrification, and the likely co-benefits of improving health outcomes for a relatively more low-income and rural population. The California Public Utilities Commission is in the process of piloting projects to "[Identify Disadvantaged Communities in the San Joaquin Valley and Analyze Economically Feasible Options to Increase Access to Affordable Energy in those Disadvantaged Communities](http://docs.cpuc.ca.gov/PublishedDocs/Efile/G000/M199/K979/199979978.PDF)". Unfortunately, at least [one pilot in California City](https://www.socalgas.com/1443741594585/Exhibit-5---SoCalGas-Pilot-Project-Proposal-for-California-City--Revised-.pdf) is moving forward with natural gas infrastructure, seemingly because of bureaucratic issues related to the electricity alternative. We would recommend that the City of Stockton stay actively involved in this CPUC project by providing comments on the upcoming phases and advocating for further pilo ts in Stockton and its peripheral rural areas to involve electrification. 

The Rocky Mountain Institute produced a report in 2018 titled ["The Economics of Electrifying Buildings"](https://rmi.org/insight/the-economics-of-electrifying-buildings/). This report includes Oakland as the most geographically proximate case study with estimates of average annual tCO2e reduction and net $ savings for every household that converts under different initial conditions, which will be modeled for Stockton. Their overall recommendations include:

- **Prioritize rapid electrification of buildings currently using propane and heating oil**. This is more relevant in East Coast case studies, but the possible benefits to Stockton were described above.
- **Stop supporting the expansion of the natural gas distribution system, including for new homes**. Our model will consider the impacts of policies to ban natural gas in new buildings. It will be important to learn from the experience of the City of Berkeley which voted to ban natural gas in new buildings in 2019 but is currently [facing a lawsuit](https://www.npr.org/2019/11/21/781874235/california-restaurant-industry-group-sues-berkeley-over-natural-gas-ban) from the California Restaurant Association.
- **Bundle demand flexibility programs, new rate designs, and energy efficiency with electrification initiatives**. Stockton should particularly focus on incentives for both creating the local skilled workforce of HVAC contractors, as well as rebates for homeowners. RMI notes: "Heat pump water heaters make up less than 1% of water heater sales today, and their unsubsidized purchase prices are two or more times those of natural gas water heaters. Given the current immaturity of the market for these products, and the potential for significant economies of scale with increasing market share, their costs are likely to decline in the future. The National Renewable Energy Laboratory's (NREL's) Electrification Futures Study projects cost declines of 20-38% for air-source heat pumps and 42-48% for heat pump water heaters by 2050. Likewise, in regions where contractors are currently unfamiliar with heat pump products, increasing scale and familiarity may reduce installation costs in the future." Electrification of specific high-consumption appliances like water and space heaters also may be combined with "smart appliance" capabilities that enable demand response, discussed next.

The following are case studies of electrification incentive programs from other cities. It is notable that none were found that specifically focus on workforce training, which is an opportunity for Stockton to differentiate itself.

- [Sacramento Municipal Utility District](https://www.smud.org/en) has an All-Electric Smart Home Program, part of the SMUD Smart Home Program, in which participating homeowners receive the financial incentives for single and multi-family homes shown in the table below. The minimum requirements include: all electric appliances and mechanical systems; no gas line in the home; and no gas service at the property. The public-private partnership has reached more than 1,000 homes and is expected to reach 2,000 by the end of the year.

```{r smud}
smud <-
  data.frame(
    Type = c("Single-family unit","Multi-family unit"),
    `Standard Incentive` = c("$4,000","$1,250"),
    `Induction cooking appliance bonus` = c("$1,000","$500"),
    `Total possible incentives` = c("$5,000","$1,750")
  ) %>% 
  rename(
    `Standard incentive` = Standard.Incentive,
    `Induction cooking appliance bonus` = Induction.cooking.appliance.bonus,
    `Total possible incentives` = Total.possible.incentives
  )

kable(
  smud,
  booktabs = TRUE,
  caption = 'Financial incentives for single-family and multi-family homes in the SMUD All-Electric Smart Home Program.'
) %>% 
  kable_styling() %>% 
  scroll_box(width = "100%")
```

$~$

- [MassCEC](https://www.masscec.com/installer-resources-air-source-heat-pumps) provides incentives for residential installation of whole-home air-source heat pumps. Pilot funding for the project is still being allocated so the number of affected homes is not yet recorded. Incentives are based on income category: For >120% of state median income, \$2,500; for 80-120%, \$3,750; for <80% or affordable housing, \$5,000.
- [City of Palo Alto Utilities](https://cityofpaloalto.org/gov/depts/utl/residents/save_energy_n_water/rebates/heat_pump_water_heater/pilot_program_details.asp) offers rebates with the following eligibility requirements: To participate in the program, you must be a CPAU customer replacing a gas or electric water heater or installing a HPHW in a new or remodeled home; The HPHW must abide by the technical specifications listed by CPAU or must be on the list of Energy Star certified HPHWs.

### Strategy: Solar Installations

## Employment Growth

### Strategy: Job Training

## Local Jobs

### Strategy: Attracting Green Jobs

## Vehicle Miles Traveled

### Strategy: Park and Ride

## Vehicle Emissions

### Strategy: Electric Vehicle Program

In Section 2.7, we used EMFAC2017 to estimate the penetration of EVs into the market in a business-as-usual situation from now till 2040, reaching about 5% in 2040. Any increase beyond this percentage would contribute to a further reduction in gCO2/mile, which would reduce the overall GHG footprint of Stockton's commute travel.

The following table shows how transportation tCO2 changes in 2040 with different EV penetration percentages. This model assumes that the distribution of vehicle types (car vs. truck, gasoline vs. diesel) does not change apart from the increase in percentage of EVs. For example, within gasoline vehicles, about 70% are projected to be cars and the rest are trucks; we do not change that assumption as we decrease the number of gasoline vehicles overall.

```{r vehicle-electric-forecast}
non_electric <-
  emfac_summary %>% 
  filter(Year == 2040) %>% 
  filter(`Fuel Type` != "Electric") %>% 
  pull(`Percent Vehicles`) %>% 
  sum()

emfac_modify <-
  c(0,5,10,15,20,25,30,35,40,45) %>% 
  map_dfr(function(x){
    temp <-
      emfac_summary %>% 
      filter(Year == 2040) %>% 
      mutate(
        `Percent Vehicles` = `Percent Vehicles`*(1-x/non_electric),
        product = `Percent Vehicles`/100*`gCO2 Running Exhaust`,
        product2 = `Percent Vehicles`/100*`gCO2 Start Exhaust`
      ) %>% 
      group_by(Year) %>% 
      summarize(
        `gCO2/mile` = sum(product),
        `gCO2/trip` = sum(product2)
      ) %>% 
      left_join(ghg_forecast_prep %>% dplyr::select(vmtperjob, `Employed Residents`, Year,Population), by = "Year") %>% 
      mutate(
        `Percent EVs` = 5.19 + x,
        `gCO2/mile` = `gCO2/mile`,
        tco2 = vmtperjob * `Employed Residents` *2*369.39*`gCO2/mile`*1.1023e-6 + `Employed Residents`*2*369.39*`gCO2/trip`*1.1023e-6 + 4100*Population*`gCO2/mile`*1.1023e-6
      )
  })

emfac_modify_table <-
  emfac_modify %>% 
  transmute(
    `Percent EVs` = paste0(round(`Percent EVs`),"%"),
    `gCO2/mile` = round(`gCO2/mile`),
    `Transportation tCO2` = prettyNum(round(tco2,-4), big.mark = ",") 
  )

kable(
  emfac_modify_table,
  booktabs = TRUE,
  caption = 'Impact of increasing EV penetration by increments of 5% on commute GHGs in 2040.'
) %>% 
  kable_styling() %>% 
  scroll_box(width = "100%")
```

$~$

```{r vehicle-electric-forecast-plot, fig.cap = 'Impact of increasing EV penetration by increments of 5% on commute GHGs in 2040.'}
emfac_modify %>% 
  ggplot(
    aes(
      x = `Percent EVs`,
      y = `tco2`
    )
  ) +
  geom_line(size = 2, colour = "forest green") +
  labs(title = "Commute Emissions in 2040", y = "Transportation tCO2")
```

$~$

Note that while EVs can be effective at reducing gCO2/mile, transit strategies are even more effective because they reduce VMTs directly. Ultimately Stockton should proactively pursue strategies in both VMT reduction and vehicle emissions reduction because this sector of GHG emissions can use as many interventions as possible.

# Conclusion

**Future Work**

- Acquire data about industrial building emissions, which is currently limited by PG&E data privacy issues. Stockton could form data partnership agreements or benchmarking mandates directly with local corporations.
- Incorporate non-commute VMTs, such as trips to the grocery store. These VMTs would be added to the VMTs already calculated for commuting, and further increase the already dominant share of transportation emissions.
- Acquire water consumption data from local water companies.
- Acquire waste collection data from local waste management companies.
- Conduct a flood risk analysis for Stockton buildings.

# Appendix A: Index of Case Studies by Place

**Arizona**

- [Engage automobile manufacturers as stakeholders in the EV market](#engage-automobile-manufacturers-as-stakeholders-in-the-ev-market)

**Arkansas**

- [Offer rebates for flood mitigation projects](#offer-rebates-for-flood-mitigation-projects)

**Arlington, VA**

- [Provide a density bonus for affordable housing](#provide-a-density-bonus-for-affordable-housing)
- [Enable property-assessed clean energy (PACE) financing](#enable-property-assessed-clean-energy-pace-financing)

**Austin, TX**

- [Provide consumer-oriented programs to incentivize energy efficiency retrofits and appliance improvements](#provide-consumer-oriented-programs-to-incentivize-energy-efficiency-retrofits-and-appliance-improvements)
- [Redesign bus network to prioritize ridership over coverage](#redesign-bus-network-to-prioritize-ridership-over-coverage)
- [Subsidize first-mile/last-mile transportation services](#subsidize-first-mile-last-mile-transportation-services)

**Berkeley, CA**

- [Create local transportation demand management ordinances](#create-local-transportation-demand-management-ordinances)

**Birmingham, AL**

- [Provide consumer-oriented programs to incentivize energy efficiency retrofits and appliance improvements](#provide-consumer-oriented-programs-to-incentivize-energy-efficiency-retrofits-and-appliance-improvements)

**Bogota, Colombia**

- [Use BRT corridors to reduce travel times on public transit](#use-brt-corridors-to-reduce-travel-times-on-public-transit)

**Boston, MA**

- [Create a fund to implement energy savings projects](#create-a-fund-to-implement-energy-savings-projects)
- [Provide green-oriented job training and education pathways](#provide-green-oriented-job-training-and-education-pathways)
- [Encourage carsharing strategies](#encourage-carsharing-strategies)

**Bridgeport, CT**

- [Provide training and coaching for low-income workers, rather than unemployed workers](#provide-training-and-coaching-for-low-income-workers-rather-than-unemployed-workers)

**Buffalo, NY**

- [Eliminate minimum parking](#eliminate-minimum-parking)

**California**

- [Encourage accessory dwelling units](#encourage-accessory-dwelling-units)
- [Revise zoning codes in medium to large cities to facilitate upzoning](#revise-zoning-codes-in-medium-to-large-cities-to-facilitate-upzoning)
- [Promote a Solar Renewable Energy Certificate program](#promote-a-solar-renewable-energy-certificate-program)
- [Provide incentives for households to install solar generation and storage, particularly for vulnerable customers](#provide-incentives-for-households-to-install-solar-generation-and-storage-particularly-for-vulnerable-customers)
- [Use green infrastructure to improve stormwater management](#use-green-infrastructure-to-improve-stormwater-management)

**Centennial, CO**

- [Subsidize first-mile/last-mile transportation services](#subsidize-first-mile-last-mile-transportation-services)

**Chicago, IL**

- [Enable property-assessed clean energy (PACE) financing](#enable-property-assessed-clean-energy-pace-financing)
- [Create a scholarship fund for students wishing to pursue eco-conscious careers](#create-a-scholarship-fund-for-students-wishing-to-pursue-eco-conscious-careers)
- [Encourage mortgage refinancing](#encourage-mortgage-refinancing)
- [Engage automobile manufacturers as stakeholders in the EV market](#engage-automobile-manufacturers-as-stakeholders-in-the-ev-market)

**Cleveland, OH**

- [Offer continued training and support post-employment](#offer-continued-training-and-support-post-employment)

**Colorado**

- [Provide tax credits to investors in advanced industries](#provide-tax-credits-to-investors-in-advanced-industries)

**Columbus, OH**

- [Offer job creation tax credit](#offer-job-creation-tax-credit)
- [Redesign bus network to prioritize ridership over coverage](#redesign-bus-network-to-prioritize-ridership-over-coverage)

**Davis, CA**

- [Develop a shared equity program for high-density housing](#develop-a-shared-equity-program-for-high-density-housing)

**Dayton, OH**

- [Provide training and coaching for low-income workers, rather than unemployed workers](#provide-training-and-coaching-for-low-income-workers-rather-than-unemployed-workers)

**Detroit, MI**

- [Promote urban gardens as a substitute for displaced ecosystem services](#promote-urban-gardens-as-a-substitute-for-displaced-ecosystem-services)

**Dublin, CA**

- [Encourage mortgage refinancing](#encourage-mortgage-refinancing)

**Estonia**

- [Provide free public transit](#provide-free-public-transit)

**Georgia**

- [Pursue public-private partnerships for commercial development](#pursue-public-private-partnerships-for-commercial-development)

**Glendale, CA**

- [Use waste to produce electricity](#use-waste-to-produce-electricity)

**Greenville County, SC**

- [Reclaim urban streams and rivers to increase groundwater absorption and filtration](#reclaim-urban-streams-and-rivers-to-increase-groundwater-absorption-and-filtration)

**Hartford, CT**

- [Eliminate minimum parking](#eliminate-minimum-parking)
- [Enable property-assessed clean energy (PACE) financing](#enable-property-assessed-clean-energy-pace-financing)

**Hayward, CA**

- [Use waste to produce electricity](#use-waste-to-produce-electricity)

**Houston, CA**

- [Redesign bus network to prioritize ridership over coverage](#redesign-bus-network-to-prioritize-ridership-over-coverage)

**Indianapolis, IN**

- [Develop public employment program](#develop-public-employment-program)
- [Redesign bus network to prioritize ridership over coverage](#redesign-bus-network-to-prioritize-ridership-over-coverage)

**Johannesburg, South Africa**

- [Use BRT corridors to reduce travel times on public transit](#use-brt-corridors-to-reduce-travel-times-on-public-transit)

**Kansas**

- [Create a scholarship fund for students wishing to pursue eco-conscious careers](#create-a-scholarship-fund-for-students-wishing-to-pursue-eco-conscious-careers)
- [Pay remote workers to move to new location](#pay-remote-workers-to-move-to-new-location)

**Kansas City, MO**

- [Provide free public transit](#provide-free-public-transit)

**King County, WA**

- [Give carpoolers priority parking at transit stops](#give-carpoolers-priority-parking-at-transit-stops)

**London, UK**

- [Create a fund to implement energy savings projects](#create-a-fund-to-implement-energy-savings-projects)

**Los Angeles, CA**

- [Provide consumer-oriented programs to incentivize energy efficiency retrofits and appliance improvements](#provide-consumer-oriented-programs-to-incentivize-energy-efficiency-retrofits-and-appliance-improvements)
- [Provide green-oriented job training and education pathways](#provide-green-oriented-job-training-and-education-pathways)
- [Provide commercial rebates for commercial building owners to install EV charging stations](#provide-commercial-rebates-for-commercial-building-owners-to-install-EV-charging-stations)

**Los Angeles County, CA**

- [Enable property-assessed clean energy (PACE) financing](#enable-property-assessed-clean-energy-pace-financing)

**Luxembourg**

- [Provide free public transit](#provide-free-public-transit)

**Madison, WI**

- [Promote permeable pavement to increase groundwater absorption](#promote-permeable-pavement-to-increase-groundwater-absorption)

**Madrid, Spain**

- [Ban personal vehicles from certain areas](#ban-personal-vehicles-from-certain-areas)

**Massachusetts**

- [Provide tax credits to investors in community development corporations](#provide-tax-credits-to-investors-in-community-development-corporations)
- [Reduce vehicle speed limits](#reduce-vehicle-speed-limits)

**Melbourne, Australia**

- [Create a fund to implement energy savings projects](#create-a-fund-to-implement-energy-savings-projects)

**Menlo Park, CA**

- [Provide green-oriented job training and education pathways](#provide-green-oriented-job-training-and-education-pathways)

**Milwaukee, WI**

- [Set energy savings standards on all public buildings and provide financial and technical assistance for commercial private sector energy savings](#set-energy-savings-standards-on-all-public-buildings-and-provide-financial-and-technical-assistance-for-commercial-private-sector-energy-savings)
- [Enable property-assessed clean energy (PACE) financing](#enable-property-assessed-clean-energy-pace-financing)
- [Promote urban gardens as a substitute for displaced ecosystem services](#promote-urban-gardens-as-a-substitute-for-displaced-ecosystem-services)

**Mexico City, Mexico**

- [Use BRT corridors to reduce travel times on public transit](#use-brt-corridors-to-reduce-travel-times-on-public-transit)

**Minneapolis, MN**

- [Revise zoning codes in medium to large cities to facilitate upzoning](#revise-zoning-codes-in-medium-to-large-cities-to-facilitate-upzoning)
- [Eliminate minimum parking](#eliminate-minimum-parking)
- [Fund economic development using tax-base sharing](#fund-economic-development-using-tax-base-sharing)
- [Rezone areas around transit stations and commercial corridors to allow for high-density residential development](#rezone-areas-around-transit-stations-and-commercial-corridors-to-allow-for-high-density-residential-development)

**Montana**

- [Pay remote workers to move to new location](#pay-remote-workers-to-move-to-new-location)

**Montgomery County, OH**

- [Fund economic development using tax-base sharing](#fund-economic-development-using-tax-base-sharing)

**Muskegon, MI**

- [Promote solar development in Opportunity Zones](#promote-solar-development-in-opportunity-zones)

**Nebraska**

- [Provide tax credits to investors in advanced industries](#provide-tax-credits-to-investors-in-advanced-industries)

**New York City, NY**

- [Encourage micro-units](#encourage-micro-units)
- [Create a fund to implement energy savings projects](#create-a-fund-to-implement-energy-savings-projects)
- [Provide green-oriented job training and education pathways](#provide-green-oriented-job-training-and-education-pathways)
- [Offer continued training and support post-employment](#offer-continued-training-and-support-post-employment)
- [Offset negative externalities of traffic through tolls](#offset-negative-externalities-of-traffic-through-tolls)
- [Charge for parking](#charge-for-parking)
- [Reduce vehicle speed limits](#reduce-vehicle-speed-limits)
- [Promote cool surfaces to reduce heat island effect](#promote-cool-surfaces-to-reduce-heat-island-effect)
- [Use green infrastructure to improve stormwater management](#use-green-infrastructure-to-improve-stormwater-management)

**Norfolk, VA**

- [Promote solar development in Opportunity Zones](#promote-solar-development-in-opportunity-zones)

**Oakland, CA**

- [Provide green-oriented job training and education pathways](#provide-green-oriented-job-training-and-education-pathways)

**Oregon**

- [Revise zoning codes in medium to large cities to facilitate upzoning](#revise-zoning-codes-in-medium-to-large-cities-to-facilitate-upzoning)

**Palo Alto, CA**

- [Implement reach codes which go beyond state minimum requirements for energy use in building design and construction](#implement-reach-codes-which-go-beyond-state-minimum-requirements-for-energy-use-in-building-design-and-construction)

**Paris, France**

- [Ban personal vehicles from certain areas](#ban-personal-vehicles-from-certain-areas)

**Pasadena, CA**

- [Create local transportation demand management ordinances](#create-local-transportation-demand-management-ordinances)
- [Provide grants to income eligible residents for the replacement of high-emission cars with low-emission cars](#provide-grants-to-income-eligible-residents-for-the-replacement-of-high-emission-cars-with-low-emission-cars)

**Pennsylvania**

- [Provide tax credits to investors in community development corporations](#provide-tax-credits-to-investors-in-community-development-corporations)

**Philadelphia, PA**

- [Offer job creation tax credit](#offer-job-creation-tax-credit)
- [Reduce vehicle speed limits](#reduce-vehicle-speed-limits)
- [Promote urban gardens as a substitute for displaced ecosystem services](#promote-urban-gardens-as-a-substitute-for-displaced-ecosystem-services)

**Phoenix, AZ**

- [Use green infrastructure to improve stormwater management](#use-green-infrastructure-to-improve-stormwater-management)

**Pittsburgh, PA**

- [Promote the use of e-scooters and dockless bicycles to reduce reliance on private cars](#promote-the-use-of-e-scooters-and-dockless-bicycles-to-reduce-reliance-on-private-cars)

**Portland, OR**

- [Give carpoolers priority parking at transit stops](#give-carpoolers-priority-parking-at-transit-stops)
- [Use green infrastructure to improve stormwater management](#use-green-infrastructure-to-improve-stormwater-management)

**Prince George's County, MD**

- [Pursue public-private partnerships for commercial development](#pursue-public-private-partnerships-for-commercial-development)

**Rancho Cucamonga, CA**

- [Provide commercial rebates for commercial building owners to install EV charging stations](#provide-commercial-rebates-for-commercial-building-owners-to-install-EV-charging-stations)

**Richmond, CA**

- [Provide green-oriented job training and education pathways](#provide-green-oriented-job-training-and-education-pathways)

**Sacramento, CA**

- [Fund economic development using tax-base sharing](#fund-economic-development-using-tax-base-sharing)
- [Promote cool surfaces to reduce heat island effect](#promote-cool-surfaces-to-reduce-heat-island-effect)

**San Diego, CA**

- [Provide training and coaching for low-income workers, rather than unemployed workers](#provide-training-and-coaching-for-low-income-workers-rather-than-unemployed-workers)

**San Francisco, CA**

- [Eliminate minimum parking](#eliminate-minimum-parking)
- [Encourage micro-units](#encourage-micro-units)
- [Provide a density bonus for affordable housing](#provide-a-density-bonus-for-affordable-housing)
- [Develop a shared equity program for high-density housing](#develop-a-shared-equity-program-for-high-density-housing)
- [Enable property-assessed clean energy (PACE) financing](#enable-property-assessed-clean-energy-pace-financing)
- [Encourage mortgage refinancing](#encourage-mortgage-refinancing)
- [Develop public employment program](#develop-public-employment-program)
- [Pursue public-private partnerships for commercial development](#pursue-public-private-partnerships-for-commercial-development)
- [Create local transportation demand management ordinances](#create-local-transportation-demand-management-ordinances)
- [Use BRT corridors to reduce travel times on public transit](#use-brt-corridors-to-reduce-travel-times-on-public-transit)
- [Promote the use of e-scooters and dockless bicycles to reduce reliance on private cars](#promote-the-use-of-e-scooters-and-dockless-bicycles-to-reduce-reliance-on-private-cars)
- [Charge for parking](#charge-for-parking)
- [Ban personal vehicles from certain areas](#ban-personal-vehicles-from-certain-areas)
- [Promote permeable pavement to increase groundwater absorption](#promote-permeable-pavement-to-increase-groundwater-absorption)
- [Use green infrastructure to improve stormwater management](#use-green-infrastructure-to-improve-stormwater-management)

**San Francisco Bay Area, CA**

- [Encourage carsharing strategies](#encourage-carsharing-strategies)
- [Provide grants for pollution remediation and reduction initiatives](#provide-grants-for-pollution-remediation-and-reduction-initiatives)
- [Provide grants to income eligible residents for the replacement of high-emission cars with low-emission cars](#provide-grants-to-income-eligible-residents-for-the-replacement-of-high-emission-cars-with-low-emission-cars)

**San Jose, CA**

- [Set energy savings standards on all public buildings and provide financial and technical assistance for commercial private sector energy savings](#set-energy-savings-standards-on-all-public-buildings-and-provide-financial-and-technical-assistance-for-commercial-private-sector-energy-savings)
- [Implement reach codes which go beyond state minimum requirements for energy use in building design and construction](#implement-reach-codes-which-go-beyond-state-minimum-requirements-for-energy-use-in-building-design-and-construction)
- [Reclaim urban streams and rivers to increase groundwater absorption and filtration](#reclaim-urban-streams-and-rivers-to-increase-groundwater-absorption-and-filtration)

**San Mateo County, CA**

- [Match homeowners with vacant spaces with individuals looking for affordable housing](#match-homeowners-with-vacant-spaces-with-individuals-looking-for-affordable-housing)

**Santa Clara County, CA**

- [Match homeowners with vacant spaces with individuals looking for affordable housing](#match-homeowners-with-vacant-spaces-with-individuals-looking-for-affordable-housing)

**Seattle, WA**

- [Encourage accessory dwelling units](#encourage-accessory-dwelling-units)
- [Provide consumer-oriented programs to incentivize energy efficiency retrofits and appliance improvements](#provide-consumer-oriented-programs-to-incentivize-energy-efficiency-retrofits-and-appliance-improvements)
- [Offset negative externalities of traffic through tolls](#offset-negative-externalities-of-traffic-through-tolls)

**South Holland, IL**

- [Offer rebates for flood mitigation projects](#offer-rebates-for-flood-mitigation-projects)

**St. Louis, MO**

- [Enable property-assessed clean energy (PACE) financing](#enable-property-assessed-clean-energy-pace-financing)

**Stanford, CA**

- [Give carpoolers priority parking at transit stops](#give-carpoolers-priority-parking-at-transit-stops)

**Stockholm, Sweden**

- [Offset negative externalities of traffic through tolls](#offset-negative-externalities-of-traffic-through-tolls)

**Tacoma, WA**

- [Promote the use of e-scooters and dockless bicycles to reduce reliance on private cars](#promote-the-use-of-e-scooters-and-dockless-bicycles-to-reduce-reliance-on-private-cars)

**Toronto, Canada**

- [Create a fund to implement energy savings projects](#create-a-fund-to-implement-energy-savings-projects)

**Tulsa, OK**

- [Offer continued training and support post-employment](#offer-continued-training-and-support-post-employment)

**Tyson, VA**

- [Rezone areas around transit stations and commercial corridors to allow for high-density residential development](#rezone-areas-around-transit-stations-and-commercial-corridors-to-allow-for-high-density-residential-development)

**Vancouver, Canada**

- [Encourage micro-units](#encourage-micro-units)

**Ventura County, CA**

- [Provide grants for pollution remediation and reduction initiatives](#provide-grants-for-pollution-remediation-and-reduction-initiatives)

**Vermont**

- [Pay remote workers to move to new location](#pay-remote-workers-to-move-to-new-location)

**Washington, DC**

- [Promote solar development in Opportunity Zones](#promote-solar-development-in-opportunity-zones)
- [Promote a Solar Renewable Energy Certificate program](#promote-a-solar-renewable-energy-certificate-program)
- [Promote the use of e-scooters and dockless bicycles to reduce reliance on private cars](#promote-the-use-of-e-scooters-and-dockless-bicycles-to-reduce-reliance-on-private-cars)

**Wisconsin**

- [Offer rebates for flood mitigation projects](#offer-rebates-for-flood-mitigation-projects)

```{r save, include=FALSE}
# save.image(file = "C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/stockton_greeneconomy.Rdata")
# load("C:/Users/derek/Google Drive/City Systems/Stockton Green Economy/stockton_greeneconomy.Rdata")
```